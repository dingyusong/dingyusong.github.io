<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Blog Atom Feed"><title data-react-helmet="true">Mach-O | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Mach-O | My Site"><meta data-react-helmet="true" name="description" content="Mach-O"><meta data-react-helmet="true" property="og:description" content="Mach-O"><meta data-react-helmet="true" property="og:url" content="https://your-docusaurus-test-site.com/docs/编程基础/计算机系统基础/1-程序/2-二进制格式/Mach-O"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://your-docusaurus-test-site.com/docs/编程基础/计算机系统基础/1-程序/2-二进制格式/Mach-O"><link rel="stylesheet" href="/styles.8cfbcdec.css">
<link rel="preload" href="/styles.e736442d.js" as="script">
<link rel="preload" href="/runtime~main.500606b1.js" as="script">
<link rel="preload" href="/main.e34cadf8.js" as="script">
<link rel="preload" href="/1.3353372a.js" as="script">
<link rel="preload" href="/256.3f6603bc.js" as="script">
<link rel="preload" href="/257.427a7301.js" as="script">
<link rel="preload" href="/935f2afb.0ee8c40a.js" as="script">
<link rel="preload" href="/255.24175022.js" as="script">
<link rel="preload" href="/797cbab7.da239d5e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/编程基础/编程基础/编程基础">编程基础</a><a class="navbar__item navbar__link" href="/docs/编程语言/编程语言">编程语言</a><a class="navbar__item navbar__link" href="/docs/工具/常用工具">工具</a><a class="navbar__item navbar__link" href="/docs/应用开发/应用开发">应用开发</a><a class="navbar__item navbar__link" href="/docs/Apple/iOS开发/iOS开发">Apple</a><a class="navbar__item navbar__link" href="/docs/音视频/音视频">音视频</a><a class="navbar__item navbar__link" href="/docs/项目/项目">项目</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/编程基础/编程基础/编程基础">编程基础</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/编程语言/编程语言">编程语言</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/工具/常用工具">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/应用开发/应用开发">应用开发</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/iOS开发/iOS开发">Apple</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/音视频">音视频</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/项目/项目">项目</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Mach-O</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="mach-o"></a>Mach-O<a class="hash-link" href="#mach-o" title="Direct link to heading">#</a></h1><p>Mach-Object</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="符号表"></a>符号表<a class="hash-link" href="#符号表" title="Direct link to heading">#</a></h1><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="objective-c"></a>Objective-C<a class="hash-link" href="#objective-c" title="Direct link to heading">#</a></h3><p>The dynamic nature of Objective-C complicates things slightly. Because the code that implements a method is not determined until the method is actually called, Objective-C does not define linker symbols for methods. Linker symbols are only defined for classes.</p><p>For example, if main.m includes the code <code>[[FooClass alloc] initWithBar:nil];</code> then <code>main.o</code> will contain an undefined symbol for <code>FooClass</code>, but no linker symbols for the <code>-initWithBar:</code> method will be in <code>main.o</code>.</p><p>Since categories are a collection of methods, using a category&#x27;s method does not generate an undefined symbol. This means the linker does not know to load an object file defining the category, if the class itself is already defined. This causes the same &quot;selector not recognized&quot; runtime exception you would see for any unimplemented method.</p><p>参考：</p><p><a href="https://developer.apple.com/library/archive/qa/qa1490/_index.html" target="_blank" rel="noopener noreferrer">https://developer.apple.com/library/archive/qa/qa1490/_index.html</a></p><p>因为实现方法的代码直到方法被实际调用时才确定，Objective-C 没有为方法定义链接器符号。链接器符号仅为类定义。</p><p>dys_ios_framework：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/Users/dingyusong/mine/github/dys_ios_framework_staticlib/demo2/dys_ios_framework/dys_ios_framework/DYSFrameWorkClass.h</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  dys_ios_framework.framework nm -g dys_ios_framework</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dys_ios_framework_vers.o:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000040 R _dys_ios_frameworkVersionNumber</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000000 R _dys_ios_frameworkVersionString</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">DYSFrameWorkClass.o:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _NSLog</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000280 T _OBJC_CLASS_$_DYSFrameWorkClass</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _OBJC_CLASS_$_NSObject</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000258 T _OBJC_METACLASS_$_DYSFrameWorkClass</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _OBJC_METACLASS_$_NSObject</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U ___CFConstantStringClassReference</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U __objc_empty_cache</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>DYSFrameWorkClass.h</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@interface DYSFrameWorkClass : NSObject</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">+ (void)dys_test;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- (void)dys_test1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>可以看到符号只有类，没有方法。验证了上面的方法。</p><p>添加了helloc.c 和 helloc2.c。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  dys_ios_framework.framework nm -g dys_ios_framework</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dys_ios_framework_vers.o:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000040 R _dys_ios_frameworkVersionNumber</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000000 R _dys_ios_frameworkVersionString</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">helloc.o:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000000 T _my_c_print</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _printf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">helloc2.o:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000000 T _my_c_print_in</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _printf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">DYSFrameWorkClass.o:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _NSLog</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000280 T _OBJC_CLASS_$_DYSFrameWorkClass</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _OBJC_CLASS_$_NSObject</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000258 T _OBJC_METACLASS_$_DYSFrameWorkClass</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _OBJC_METACLASS_$_NSObject</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U ___CFConstantStringClassReference</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U __objc_empty_cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _my_c_print_in</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ul><li>-g或–extern-only：仅显示外部符号。</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="mach-o-1"></a>Mach-O<a class="hash-link" href="#mach-o-1" title="Direct link to heading">#</a></h2><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">gcc -g a.c -o a</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>注意-g参数，在其他unix系统中，通常将符号信息内嵌在二进制文件中，但是在osx中，这些信息都放在一个辅助文件dSYM中。</p><p><a href="https://h3adsh0tzz.com/2020/01/macho-file-format/" target="_blank" rel="noopener noreferrer">Mach-O File Format: Introduction</a></p><p><a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/CodeFootprint/Articles/MachOOverview.html" target="_blank" rel="noopener noreferrer">Overview of the Mach-O Executable Format</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="mach-header"></a>Mach header<a class="hash-link" href="#mach-header" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">//EXTERNAL_HEADERS/mach-o/loader.h</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct mach_header {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        uint32_t            magic;          // mach magic number</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        cpu_type_t          cputype;        // cpu specifier</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        cpu_subtype_t       cpusubtype;     // cpu subtype specifier</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        uint32_t            filetype;       // type of mach-o e.g. exec, dylib ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        uint32_t            ncmds;          // number of load commands</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        uint32_t            sizeofcmds;     // size of load command region</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        uint32_t            flags;          // flags</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        uint32_t            reserved;       // *64-bit only* reserved</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/* Constant for the magic field of the mach_header_64 (64-bit architectures) */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define MH_MAGIC_64 0xfeedfacf /* the 64-bit mach magic number */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define MH_CIGAM_64 0xcffaedfe /* NXSwapInt(MH_MAGIC_64) */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  dys_ios_framework.framework otool -h dys_ios_framework </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dys_ios_framework:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Mach header</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> 0xfeedfacf 16777228          0  0x00           6    21       2536 0x00100085</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><img alt="image-20210818153407343" src="/assets/images/image-20210818153407343-1379df3a7f30768ac1d14903a7f9baaf.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="load-commands"></a>Load Commands<a class="hash-link" href="#load-commands" title="Direct link to heading">#</a></h3><p>加载命令。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">header中这两个字段，是关于加载的。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">uint32_t            ncmds;          // number of load commands</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">uint32_t            sizeofcmds;     // size of load command region</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">   struct load_command {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        uint32_t      cmd;      // type of load command</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        uint32_t      cmdsize;    // size of load command</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="symbol-table"></a>Symbol Table<a class="hash-link" href="#symbol-table" title="Direct link to heading">#</a></h3><p>符号表存储了当前文件的符号信息，静态链接器(ld)和动态链接器(dyld)在链接的过程中都会读取符号表，另外调试器也会用符号表来把符号映射到源文件。</p><p>.symtab符号表不包含局部变量的条目。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="dynamic-symbol-table"></a>Dynamic Symbol Table<a class="hash-link" href="#dynamic-symbol-table" title="Direct link to heading">#</a></h3><p>使用 <strong>*otool* 命令可以查看动态符号表中的符号位于符号表中的下标。因此动态符号也叫做 ***Indirect symbols*。**</strong></p><p>****动态符号表，***Dynamic Symbol Table* ，其中 ***仅存储了符号位于Symbol Table中的下标* ，而非符号数据结构，因为符号的结构仅存储在 ***Symbol Table* 而已。****</p><p><img alt="image-20210817172804282" src="/assets/images/image-20210817172804282-7599e91265cb45f110a9fbeb9228a556.png"></p><p><img alt="image-20210817172203838" src="/assets/images/image-20210817172203838-76ea04ff6e826509b5f944461ca4dba1.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="string-table"></a>String Table<a class="hash-link" href="#string-table" title="Direct link to heading">#</a></h3><p>二进制中的所有字符串都存储在 ***String Table* 中。********</p><p><img alt="img" src="/assets/images/17231f081b953bf4~tplv-t2oaga2asx-watermark-e9c2fc748948b0a99a4b1fb2e40f3b2f.awebp"></p><p><img alt="image-20210817172107039" src="/assets/images/image-20210817172107039-c1487f2ec5b85b97689e4acf4ec56e0c.png"></p><p><img alt="image-20210817172356296" src="/assets/images/image-20210817172356296-39e9ae1d1b04f39245d9682f23d2f794.png"></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  dys_ios_framework.framework strings dys_ios_framework</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="otool"></a>otool<a class="hash-link" href="#otool" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  dys_ios_framework.framework otool --help</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">error: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/otool: unknown char `-&#x27; in flag --help</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Usage: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/otool [-arch arch_type] [-fahlLDtdorSTMRIHGvVcXmqQjCP] [-mcpu=arg] [--version] &lt;object file&gt; ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -f print the fat headers</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -a print the archive header</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -h print the mach header</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -l print the load commands</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -L print shared libraries used</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -D print shared library id name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -t print the text section (disassemble with -v)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -x print all text sections (disassemble with -v)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -p &lt;routine name&gt;  start dissassemble from routine name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -s &lt;segname&gt; &lt;sectname&gt; print contents of section</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -d print the data section</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -o print the Objective-C segment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -r print the relocation entries</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -S print the table of contents of a library (obsolete)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -T print the table of contents of a dynamic shared library (obsolete)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -M print the module table of a dynamic shared library (obsolete)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -R print the reference table of a dynamic shared library (obsolete)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -I print the indirect symbol table</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -H print the two-level hints table (obsolete)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -G print the data in code table</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -v print verbosely (symbolically) when possible</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -V print disassembled operands symbolically</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -c print argument strings of a core file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -X print no leading addresses or headers</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -m don&#x27;t use archive(member) syntax</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -B force Thumb disassembly (ARM objects only)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -q use llvm&#x27;s disassembler (the default)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -Q use otool(1)&#x27;s disassembler</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -mcpu=arg use `arg&#x27; as the cpu for disassembly</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -j print opcode bytes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -P print the info plist section as strings</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -C print linker optimization hints</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        --version print the version of /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/otool</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  dys_ios_framework.framework </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>-I print the indirect symbol table</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  dys_ios_framework.framework otool -I dys_ios_framework </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dys_ios_framework:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Indirect symbols for (__TEXT,__stubs) 2 entries</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">address            index</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0x0000000000007e70    58 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0x0000000000007e7c    63 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Indirect symbols for (__DATA_CONST,__got) 1 entries</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">address            index</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0x0000000000008000    64 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Indirect symbols for (__DATA,__la_symbol_ptr) 2 entries</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">address            index</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0x000000000000c000    58 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0x000000000000c008    63 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  dys_ios_framework.framework </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><img alt="image-20210817173651023" src="/assets/images/image-20210817173651023-1d1fc1b15cafe895d2231f6af4ff9ceb.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="符号生成规则"></a>符号生成规则<a class="hash-link" href="#符号生成规则" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="c语言"></a>C语言<a class="hash-link" href="#c语言" title="Direct link to heading">#</a></h4><p>C的符号生成规则比较简单，一般的符号都是在函数名上加上下划线，比如main.c里包含mian和mylog两个C函数，对应符号如下：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  link-test nm a.o</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000000 T _foo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  link-test nm b.o</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000000 D _x</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000004 D _y</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  link-test nm a.out</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000100008008 d __dyld_private</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000100000000 T __mh_execute_header</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000100003f10 T _foo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000100003f30 T _main</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _printf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000100008010 D _x</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000100008014 D _y</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U dyld_stub_binder</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="c"></a>C++<a class="hash-link" href="#c" title="Direct link to heading">#</a></h4><p>C++因为支持命名空间，函数重载等高级特性，为了避免符号冲突，所以编译器对C++符号做了Symbol Mangling(不同编译器的规则不一样)。</p><p>举个例子：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace MyNameSpace {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    class MyClass{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        static int myFunc(int);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        static double myFunc(double);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>编译后，分别对应符号</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000008 T __ZN11MyNameSpace7MyClass6myFuncEd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000000 T __ZN11MyNameSpace7MyClass6myFuncEi</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>其实，Symbol Mangling规则并不难，刚刚的两个符号是按照如下规则生成的：</p><ul><li>以_Z开头</li><li>跟着C语言的保留字符串N</li><li>对于namespace等嵌套的名称，接下依次拼接名称长度，名称</li><li>然后是结束字符E</li><li>最后是参数的类型，比如int是i，double是d</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="objective-c-1"></a>Objective C<a class="hash-link" href="#objective-c-1" title="Direct link to heading">#</a></h4><p>Objective C的符号更简单一些，比如方法的符号是<code>+-[Class_name(category_name) method:name:]</code>，除了这些，Objective C还会生成一些Runtime元数据的符号</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _OBJC_CLASS_$_BTDRouteBuilder</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _OBJC_CLASS_$_BTDRouter</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _OBJC_CLASS_$_UIViewController</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000458 S _OBJC_CLASS_$_ViewController</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _OBJC_METACLASS_$_NSObject</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 U _OBJC_METACLASS_$_UIViewController</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0000000000000480 S _OBJC_METACLASS_$_ViewController</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>所以当链接的时候类找不到了，会报错符号*OBJC_CLASS*$_CLASSNAME找不到</p><p><img alt="在这里插入图片描述" src="/assets/images/20191130225957319-3877695318309d16b4a3256be9bb46c7.png"></p><p>当然，如果类的符号没有被裁减掉，运行时就用*OBJC_CLASS*$_CLASSNAME作为参数，通过dlsym来获取类指针。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="符号的种类"></a>符号的种类<a class="hash-link" href="#符号的种类" title="Direct link to heading">#</a></h3><p>按照不同的方式可以对符号进行不同的分类，比如按照可见性划分</p><ul><li>全局符号(Global Symbol) 对其他编译单元可见</li><li>本地符号(Local Symbol) 只对当前编译单元可见</li></ul><p>按照位置划分</p><ul><li>外部符号，符号不在当前文件，需要ld或者dyld在链接的时候解决</li><li>非外部符号，即当前文件内的符号</li></ul><p>nm命令里的小写字母对应着本地符号，大写字母表示全局符号；U表示undefined，即未定义的外部符号</p><p><img alt="在这里插入图片描述" src="/assets/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9sZW9tb2JpbGVkZXZlbG9wZXIuYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70-1ef08279f0a31d06741bb2d5e87d98e9.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="可见性"></a>可见性<a class="hash-link" href="#可见性" title="Direct link to heading">#</a></h3><p>有个很常见的case，就是你有1000个函数，但只有10个函数是公开的，希望最后生成的动态库里不包含其他990个函数的符号，这时候就可以用clang的attribute来实现</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">//符号可被外部链接</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">__attribute__((visibility(&quot;default&quot;)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//符号不会被放到Dynamic Symbol Table里，意味着不可以再被其他编译单元链接</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">__attribute__((visibility(&quot;hidden&quot;)))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>clang来提供了一个全局的开关，用来设置符号的默认可见性：</p><p><img alt="在这里插入图片描述" src="/assets/images/1-2bb401d8c4f16c284117bd8eca376271.png"></p><p>控制符号的可见性</p><p><a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/CppRuntimeEnv/Articles/SymbolVisibility.html#//apple_ref/doc/uid/TP40001670-CJBGBHEJ" target="_blank" rel="noopener noreferrer">Apple： Controlling Symbol Visibility</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="segments-and-sections"></a>segments and sections<a class="hash-link" href="#segments-and-sections" title="Direct link to heading">#</a></h2><p><img alt="image-20210819164759981" src="/assets/images/image-20210819164759981-7dfbf97a69aa778c57fd9dbaf1f837f0.png"></p><p>段（segment）有时候可以进一步分解为区（section）。</p><p><img alt="image-20210819162807327" src="/assets/images/image-20210819162807327-2c79c16a9b5bdfe72255057831d99690.png"></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  mach-o size dys_ios_framework_demo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">__TEXT  __DATA  __OBJC  others  dec     hex</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">32768   16384   0       4295016448      4295065600      100018000</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>文件头，代码段，数据段，符号表等其他信息</p><p><img alt="image-20210819173553884" src="/assets/images/image-20210819173553884-f7263539ae0e5ff5208823f5c019035a.png"></p><p>section主要提供给Linker使用， 而segment提供给Loader用，Linker需要关心.text, .rel.text, .data, .rodata等等，关键是Linker需要做relocation。而Loader只需要知道Read/Write/Execute的属性。</p><p>参考:<a href="https://www.cnblogs.com/feng9exe/p/6899136.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/feng9exe/p/6899136.html</a></p><p>参考:<a href="http://rk700.github.io/2014/10/26/ELF-segments-and-sections/" target="_blank" rel="noopener noreferrer">ELF segments and sections</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="库文件"></a>库文件<a class="hash-link" href="#库文件" title="Direct link to heading">#</a></h2><p>生成库文件</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">libtool -static -o libmylib.a add.o</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  /Users/Ding/mine/gitee/clab/compile-as-ld/04-static-lib git:(master) ✗ vi main.c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  /Users/Ding/mine/gitee/clab/compile-as-ld/04-static-lib git:(master) ✗ clang main.c add.c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  /Users/Ding/mine/gitee/clab/compile-as-ld/04-static-lib git:(master) ✗ ./a.out</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">add(3,3)=6</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  /Users/Ding/mine/gitee/clab/compile-as-ld/04-static-lib git:(master) ✗ clang -c add.c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  /Users/Ding/mine/gitee/clab/compile-as-ld/04-static-lib git:(master) ✗ ll</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">total 136</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rwxr-xr-x  1 Ding  staff    48K 10  6 21:49 a.out</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  1 Ding  staff    40B 10  6 21:46 add.c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  1 Ding  staff    22B 10  6 21:45 add.h</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  1 Ding  staff   624B 10  6 21:49 add.o</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  1 Ding  staff   118B 10  6 21:49 main.c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  /Users/Ding/mine/gitee/clab/compile-as-ld/04-static-lib git:(master) ✗ libtool -static -o libmyadd.a add.o</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  /Users/Ding/mine/gitee/clab/compile-as-ld/04-static-lib git:(master) ✗ ll</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">total 144</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rwxr-xr-x  1 Ding  staff    48K 10  6 21:49 a.out</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  1 Ding  staff    40B 10  6 21:46 add.c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  1 Ding  staff    22B 10  6 21:45 add.h</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  1 Ding  staff   624B 10  6 21:49 add.o</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  1 Ding  staff   808B 10  6 21:50 libmyadd.a</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  1 Ding  staff   118B 10  6 21:49 main.c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  /Users/Ding/mine/gitee/clab/compile-as-ld/04-static-lib git:(master) ✗ clang -g -o main main.c -I . -L . -l myadd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  /Users/Ding/mine/gitee/clab/compile-as-ld/04-static-lib git:(master) ✗ ll</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">total 248</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rwxr-xr-x  1 Ding  staff    48K 10  6 21:49 a.out</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  1 Ding  staff    40B 10  6 21:46 add.c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  1 Ding  staff    22B 10  6 21:45 add.h</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  1 Ding  staff   624B 10  6 21:49 add.o</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  1 Ding  staff   808B 10  6 21:50 libmyadd.a</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rwxr-xr-x  1 Ding  staff    49K 10  6 21:51 main</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  1 Ding  staff   118B 10  6 21:49 main.c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">drwxr-xr-x  3 Ding  staff    96B 10  6 21:51 main.dSYM</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  /Users/Ding/mine/gitee/clab/compile-as-ld/04-static-lib git:(master) ✗ ./main</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">add(3,3)=6</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="cstatic变量加载问题"></a>C++Static变量加载问题<a class="hash-link" href="#cstatic变量加载问题" title="Direct link to heading">#</a></h2><p><img alt="image-20211105164810704" src="/assets/images/image-20211105164810704-0a43f711e4c1917f91fc062a36bdee95.png"></p><ol><li>Other Linker Flags 添加-all_load 可以解决！</li><li>生成临时变量也可以解决！</li></ol><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">IRZLogan* CreateRZLogan(const LoganConfig* cfg) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    RZTransportationHttp module1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    RZFileStorage module2;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//    RZCompressZlib module3;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    RZControlFlowV1 module4;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    RZEncryptionV1 module5;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    RZFileNode module6;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    LoganConfig* newCfg = (LoganConfig*)cfg;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (!checkConfig(newCfg)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        assert(0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return nullptr;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return new RZLoganV1(*newCfg);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="rtfm"></a>RTFM<a class="hash-link" href="#rtfm" title="Direct link to heading">#</a></h2><ul><li><a href="https://developer.apple.com/library/archive/technotes/tn2206/_index.html" target="_blank" rel="noopener noreferrer">[1] Apple Technical Note - TN2206: Mac OS X Code Signing In Depth</a></li><li><a href="https://www.nextop.de/NeXTstep_3.3_Developer_Documentation/DevTools/14_MachO/MachO.htmld/index.html" target="_blank" rel="noopener noreferrer">[2] NeXTSTEP 3,3 DevTools documentation, Chapter 14, Mach Object Files&quot; -- Documents the
original Mach-O format (which remains largely unchanged in OS X).</a></li><li><a href="https://www.cs.miami.edu/home/burt/learning/Csc521.091/docs/MachOTopics.pdf" target="_blank" rel="noopener noreferrer">[3] Apple Developer: Mach-O Programming Topics - - Basic architecture and loading</a></li><li><a href="https://github.com/aidansteele/osx-abi-macho-file-format-reference" target="_blank" rel="noopener noreferrer">[4] Apple Developer: Mac OS x ABI Mach-O File Format Reference -- Discussion on load commands</a></li><li>[5] Dream Team Absinthe and Corona Jailbreaks for iOS 5.0.l: <a href="http://onference.hitb.org/hitbsecconf2012ams/materials/" target="_blank" rel="noopener noreferrer">http://onference.hitb.org/hitbsecconf2012ams/materials/</a></li><li>[6] Apple Developer: Memory Management- Discusses memory management from the user mode perspective</li><li>[7] Apple Developer: Grand Central Dispatcher Reference</li><li>[8] Apple Developer: Concurrency Programming Guide</li><li><a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/CodeFootprint/Articles/MachOOverview.html" target="_blank" rel="noopener noreferrer">Apple Developer:Overview of the Mach-O Executable Format</a></li><li><a href="https://www.nextop.de/NeXTstep_3.3_Developer_Documentation/" target="_blank" rel="noopener noreferrer">https://www.nextop.de/NeXTstep_3.3_Developer_Documentation/</a></li><li><a href="https://www.nextop.de/" target="_blank" rel="noopener noreferrer">https://www.nextop.de/</a></li><li><a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/MachOTopics/0-Introduction/introduction.html#//apple_ref/doc/uid/TP40001519" target="_blank" rel="noopener noreferrer">Mach-O Programming Topics</a></li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="dys-typora-open://mine/survival/docs/编程基础/计算机系统基础/1-程序/2-二进制格式/Mach-O.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#objective-c" class="table-of-contents__link">Objective-C</a></li><li><a href="#mach-o-1" class="table-of-contents__link">Mach-O</a><ul><li><a href="#mach-header" class="table-of-contents__link">Mach header</a></li><li><a href="#load-commands" class="table-of-contents__link">Load Commands</a></li><li><a href="#symbol-table" class="table-of-contents__link">Symbol Table</a></li><li><a href="#dynamic-symbol-table" class="table-of-contents__link">Dynamic Symbol Table</a></li><li><a href="#string-table" class="table-of-contents__link">String Table</a></li><li><a href="#otool" class="table-of-contents__link">otool</a></li><li><a href="#符号生成规则" class="table-of-contents__link">符号生成规则</a></li><li><a href="#符号的种类" class="table-of-contents__link">符号的种类</a></li><li><a href="#可见性" class="table-of-contents__link">可见性</a></li></ul></li><li><a href="#segments-and-sections" class="table-of-contents__link">segments and sections</a></li><li><a href="#库文件" class="table-of-contents__link">库文件</a></li><li><a href="#cstatic变量加载问题" class="table-of-contents__link">C++Static变量加载问题</a></li><li><a href="#rtfm" class="table-of-contents__link">RTFM</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.e736442d.js"></script>
<script src="/runtime~main.500606b1.js"></script>
<script src="/main.e34cadf8.js"></script>
<script src="/1.3353372a.js"></script>
<script src="/256.3f6603bc.js"></script>
<script src="/257.427a7301.js"></script>
<script src="/935f2afb.0ee8c40a.js"></script>
<script src="/255.24175022.js"></script>
<script src="/797cbab7.da239d5e.js"></script>
</body>
</html>