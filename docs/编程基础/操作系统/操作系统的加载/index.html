<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Blog Atom Feed"><title data-react-helmet="true">操作系统的加载 | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="操作系统的加载 | My Site"><meta data-react-helmet="true" name="description" content="镜像加载"><meta data-react-helmet="true" property="og:description" content="镜像加载"><meta data-react-helmet="true" property="og:url" content="http://localhost:9999//docs/编程基础/操作系统/操作系统的加载"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://localhost:9999//docs/编程基础/操作系统/操作系统的加载"><link rel="stylesheet" href="/styles.8cfbcdec.css">
<link rel="preload" href="/styles.1004da7c.js" as="script">
<link rel="preload" href="/runtime~main.74d3fe56.js" as="script">
<link rel="preload" href="/main.b81ad7fb.js" as="script">
<link rel="preload" href="/1.2fe752e0.js" as="script">
<link rel="preload" href="/259.96e24fb8.js" as="script">
<link rel="preload" href="/260.8c75c7b8.js" as="script">
<link rel="preload" href="/935f2afb.8492b0e9.js" as="script">
<link rel="preload" href="/258.d78093f4.js" as="script">
<link rel="preload" href="/652b7eaf.c0dbaf4d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">基础</a><a class="navbar__item navbar__link" href="/docs/编程语言/编程语言">语言</a><a class="navbar__item navbar__link" href="/docs/工具/常用工具">工具</a><a class="navbar__item navbar__link" href="/docs/应用开发/应用开发">应用开发</a><a class="navbar__item navbar__link" href="/docs/Apple/iOS开发/iOS开发">Apple</a><a class="navbar__item navbar__link" href="/docs/音视频/音视频">音视频</a><a class="navbar__item navbar__link" href="/docs/项目/项目">项目</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">基础</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/编程语言/编程语言">语言</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/工具/常用工具">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/应用开发/应用开发">应用开发</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/iOS开发/iOS开发">Apple</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/音视频">音视频</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/项目/项目">项目</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">操作系统的加载</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="镜像加载"></a>镜像加载<a class="hash-link" href="#镜像加载" title="Direct link to heading">#</a></h2><p>创建软盘镜像首先需要一个汇编器，将汇编源代码编译成二进制文件，其实软盘镜像的真身也是二进制文件，例如只是编译bootsect.asm文件，那么生成的二进制文件可以直接在虚拟机里面运行，由于现在软驱已经基本绝迹了所以才需要使用镜像文件来启动操作系统，使用bochs虚拟机需要有一个对镜像文件的配置表，在windows中这个配置表是一个以bsxr结尾的文件，配置好这个文件之后双击运行就能启动自制的操作系统了</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="启动过程"></a>启动过程<a class="hash-link" href="#启动过程" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="加电-启动bios"></a>加电-启动BIOS<a class="hash-link" href="#加电-启动bios" title="Direct link to heading">#</a></h3><p>当电脑刚加电的时候，会做一些重置的工作，将 CS 设置为 0xFFFF，将 IP 设置为 0x0000，所以第一条指令就会指向 0xFFFF0，正是在 ROM 的范围内。在这里，有一个 JMP 命令会跳到 ROM 中做初始化工作的代码，于是，BIOS 开始进行初始化的工作。</p><p>相关寄存器重置了了一个地址，然后去哪个地址取指令执行。这就是起点。第一个地址是写死的，内容也是固定到room的。</p><p>从room到硬盘</p><p>从实模式切换到保护模式</p><p>计算机的运行过程及其简单：<strong>取指=&gt;执行</strong> 不停循环</p><p><img alt="img" src="/assets/images/337-3d6aae4cfb7dbaf3817fc74554322b59.jpeg"></p><p> CS 设置为 0xFFFF，将 IP 设置为 0x0000，所以第一条指令就会指向 0xFFFF0。</p><p>CS::IP 初始入口。</p><p>在 x86 系统中，将 1M 空间最上面的 0xF0000 到 0xFFFFF 这 64K 映射给 ROM，也就是说，到这部分地址访问的时候，会访问 ROM。</p><p>此时会访问rom，而rom是提前写好的程序。</p><p>![下载 (3)](操作系统的加载.assets/下载 (3).jpeg)</p><p>给存储介质一字节一字节得划好了地址，cpu编地址有两种方式，一种是统一编址，比如我在内存中划出一块区域专门作为与外设交互的地址，一个超明显的例子就是显存，以Intel的x86架构为例，0xB8000就是显存的地址，你往这个地址下写字符就是能在显示器上显示出来，从这个地址开始，每<strong>两个字节</strong>被解释为显示在屏幕上的一个字符，这第一个字节表示要显示字符的字模码，就是一个字符的像素点应该怎么点出来，第二个字节用于表示这个字符的前景色和背景色。具体如下</p><p><img alt="image-20210630215852789" src="/assets/images/image-20210630215852789-7572dd493566f53b59d71f0c74c5cd49.png"></p><p>显示的内容容量总是比已安装的内存条小上一点，原因就是将地址总线能访问的一部分划给内存条之外的其他存储空间。</p><p>这个阶段的任务：</p><ol><li><p>检验外设，初始化硬件。</p><p>BIOS 要检查一下系统的硬件是不是都好着</p></li><li><p>建立一个中断向量表和中断服务程序，因为现在你还要用键盘和鼠标，这些都要通过中断进行的。</p></li></ol><p>0x000~0x3ff处建立终端向量表，并填写中断历程。</p><ol start="3"><li><p>基本的I/O功能。</p><p>因为此时用户需要和BIOS交互。</p></li></ol><p>完成之后，跳转到下一步：MBR</p><p>解释：BIOS的最后一项工作就是检验启动盘，0盘，0道，1扇区(CHS表示法)，或者0盘，0道，0扇区（LBA表示法），如果此扇区末尾的两个字节是0x55和0xaa,则表示此扇区存在可执行的程序(MBR), 随后将其加载到0x7c00处，在跳转到此处运行，此时接力棒就交给了MBR。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="bootloader时期"></a>bootloader时期<a class="hash-link" href="#bootloader时期" title="Direct link to heading">#</a></h3><p><strong>MBR</strong>: main boot record. 主引导记录，位于硬盘最开始的扇区。</p><p>这个扇区是硬盘上的，也就是我们可以自己写的。一般在linux下我们用grub2来写进入，或者叫安装，或者叫配置。</p><p>一般扇区大小为512字节。MBR引导扇区的内容为：</p><ol><li>446字节的引导程序和参数</li><li>64字节的分区表</li><li>最后两字节0x55和0xaa</li></ol><p><strong>Grub2</strong> 在这个扇区安装了什么呢？第一个要安装的就是 boot.img。它由 boot.S 编译而成，一共 512 字节，正式安装到启动盘的第一个扇区。这个扇区通常称为<strong>MBR</strong>（Master Boot Record，主引导记录 / 扇区）。</p><p>bootloader</p><p>boot.img 做不了太多事情。因为比较小。它能做的最重要的一个事情就是加载 grub2 的另一个镜像 core.img。</p><p>![下载 (4)](操作系统的加载.assets/下载 (4).jpeg)</p><p>boot.img 先加载的是 core.img 的第一个扇区。如果从硬盘启动的话，这个扇区里面是 diskboot.img，对应的代码是 diskboot.S。</p><p>boot.img 将控制权交给 diskboot.img 后，diskboot.img 的任务就是将 core.img 的其他部分加载进来，先是解压缩程序 lzma_decompress.img，再往下是 kernel.img，最后是各个模块 module 对应的映像。这里需要注意，它不是 Linux 的内核，而是 grub 的内核。</p><p>lzma_decompress.img 对应的代码是 startup_raw.S，本来 kernel.img 是压缩过的，现在执行的时候，需要解压缩。</p><p><strong>实模式-&gt;保护模式</strong></p><p>在这之前，我们所有遇到过的程序都非常非常小，完全可以在实模式下运行，但是随着我们加载的东西越来越大，实模式这 1M 的地址空间实在放不下了，所以在真正的解压缩之前，lzma_decompress.img 做了一个重要的决定，就是调用 real_to_prot，切换到保护模式，这样就能在更大的寻址空间里面，加载更多的东西。</p><p>切换到保护模式要干很多工作，大部分工作都与内存的访问方式有关。</p><p>第一项是<strong>启用分段</strong>，就是在内存里面建立段描述符表，将寄存器里面的段寄存器变成段选择子，指向某个段描述符，这样就能实现不同进程的切换了。</p><p>第二项是<strong>启动分页</strong>。能够管理的内存变大了，就需要将内存分成相等大小的块，</p><p>打开 Gate A20，也就是第 21 根地址线的控制线。切换保护模式的函数 DATA32 call real_to_prot 会打开 Gate A20，也就是第 21 根地址线的控制线。</p><p>现在好了，有的是空间了。接下来我们要对压缩过的 kernel.img 进行解压缩，然后跳转到 kernel.img 开始运行。</p><p>kernel.img 对应的代码是 startup.S 以及一堆 c 文件，在 startup.S 中会调用 grub_main，这是 grub kernel 的主函数。</p><p>在这个函数里面，grub_load_config() 开始解析，我们上面写的那个 grub.conf 文件里的配置信息。</p><p>如果是正常启动，grub_main 最后会调用 grub_command_execute (“normal”, 0, 0)，最终会调用 grub_normal_execute() 函数。在这个函数里面，grub_show_menu() 会显示出让你选择的那个操作系统的列表。</p><p><img alt="下载" src="/assets/images/下载-b422cd09990cf3aa8558cf28d7e2a6b4.png"></p><p>一旦，你选定了某个宝典，启动某个操作系统，就要开始调用 grub_menu_execute_entry() ，开始解析并执行你选择的那一项。接下来你的经营企业之路就此打开了。</p><p>例如里面的 linux16 命令，表示装载指定的内核文件，并传递内核启动参数。于是 grub_cmd_linux() 函数会被调用，它会首先读取 Linux 内核镜像头部的一些数据结构，放到内存中的数据结构来，进行检查。如果检查通过，则会读取整个 Linux 内核镜像到内存。</p><p>如果配置文件里面还有 initrd 命令，用于为即将启动的内核传递 init ramdisk 路径。于是 grub_cmd_initrd() 函数会被调用，将 initramfs 加载到内存中来。</p><p>当这些事情做完之后，grub_command_execute (“boot”, 0, 0) 才开始真正地启动内核。</p><p>![下载 (5)](操作系统的加载.assets/下载 (5).jpeg)</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="内核启动"></a>内核启动<a class="hash-link" href="#内核启动" title="Direct link to heading">#</a></h3><p>内核的启动从入口函数 start_kernel() 开始。在 init/main.c 文件中，start_kernel 相当于内核的 main 函数。打开这个函数，你会发现，里面是各种各样初始化函数 XXXX_init。</p><p>![下载 (6)](操作系统的加载.assets/下载 (6).jpeg)</p><ol><li>创建0号进程。</li></ol><p>在操作系统里面，先要有个创始进程，有一行指令 set_task_stack_end_magic(&amp;init_task)。这里面有一个参数 init_task，它的定义是 struct task_struct init_task = INIT_TASK(init_task)。它是系统创建的第一个进程，我们称为<strong>0 号进程</strong>。这是唯一一个没有通过 fork 或者 kernel_thread 产生的进程，是进程列表的第一个。</p><ol start="2"><li>启动中断服务</li></ol><p>这里面对应的函数是 trap_init()，里面设置了很多<strong>中断门</strong>（Interrupt Gate），用于处理各种中断。其中有一个 set_system_intr_gate(IA32_SYSCALL_VECTOR, entry_INT80_32)，这是系统调用的中断门。系统调用也是通过发送中断的方式进行的。</p><ol start="3"><li>启动内存管理系统</li></ol><p>对应的，mm_init() 就是用来初始化内存管理模块。项目需要项目管理进行调度，需要执行一定的调度策略。sched_init() 就是用于初始化调度模块。</p><ol start="4"><li>启动文件系统</li></ol><p>vfs_caches_init() 会用来初始化基于内存的文件系统 rootfs。在这个函数里面，会调用 mnt_init()-&gt;init_rootfs()。这里面有一行代码，register_filesystem(&amp;rootfs_fs_type)。在 VFS 虚拟文件系统里面注册了一种类型，我们定义为 struct file_system_type rootfs_fs_type。</p><p>文件系统是我们的项目资料库，为了兼容各种各样的文件系统，我们需要将文件的相关数据结构和操作抽象出来，形成一个抽象层对上提供统一的接口，这个抽象层就是 VFS（Virtual File System），虚拟文件系统。</p><ol start="5"><li>启动1号进程和2号进程</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="编译后的内核镜像-及其执行"></a>编译后的内核镜像 及其执行<a class="hash-link" href="#编译后的内核镜像-及其执行" title="Direct link to heading">#</a></h2><ul><li><p><a href="https://www.cnblogs.com/cxj2011/p/13430960.html" target="_blank" rel="noopener noreferrer">谈谈Linux内核镜像</a></p></li><li><p><a href="https://blog.csdn.net/dashen2259/article/details/101995793" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/dashen2259/article/details/101995793</a></p></li><li><p>Linux kernel 分析之一:内核镜像<a href="https://blog.csdn.net/vanquishedzxl/article/details/46958785" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/vanquishedzxl/article/details/46958785</a></p></li><li><p><a href="https://blog.csdn.net/nsdhy/article/details/38683107" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/nsdhy/article/details/38683107</a></p></li><li><p>制作linux启动盘</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="问题"></a>问题<a class="hash-link" href="#问题" title="Direct link to heading">#</a></h2><p>操作系统是怎么跑起来的？</p><p>取指-&gt;译码-&gt;执行-&gt;更新pc</p><p>计算机不断地重复上述四个步骤, 不断地执行指令, 直到永远.</p><p>参考：<a href="https://nju-projectn.github.io/ics-pa-gitbook/ics2020/2.1.html" target="_blank" rel="noopener noreferrer">https://nju-projectn.github.io/ics-pa-gitbook/ics2020/2.1.html</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="理解"></a>理解<a class="hash-link" href="#理解" title="Direct link to heading">#</a></h2><p>操作系统是一个有限状态机，加电之后用不停歇的状态转换。本质是寄存器和内存上一堆的二进制的组合，虚拟机的原理是，用内存中的二进制模拟真机中的寄存器和内存。在此之上，进行何种处理。</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="dys-typora-open://mine/survival/docs/编程基础/操作系统/操作系统的加载.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#镜像加载" class="table-of-contents__link">镜像加载</a></li><li><a href="#启动过程" class="table-of-contents__link">启动过程</a><ul><li><a href="#加电-启动bios" class="table-of-contents__link">加电-启动BIOS</a></li><li><a href="#bootloader时期" class="table-of-contents__link">bootloader时期</a></li><li><a href="#内核启动" class="table-of-contents__link">内核启动</a></li></ul></li><li><a href="#编译后的内核镜像-及其执行" class="table-of-contents__link">编译后的内核镜像 及其执行</a></li><li><a href="#问题" class="table-of-contents__link">问题</a></li><li><a href="#理解" class="table-of-contents__link">理解</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.1004da7c.js"></script>
<script src="/runtime~main.74d3fe56.js"></script>
<script src="/main.b81ad7fb.js"></script>
<script src="/1.2fe752e0.js"></script>
<script src="/259.96e24fb8.js"></script>
<script src="/260.8c75c7b8.js"></script>
<script src="/935f2afb.8492b0e9.js"></script>
<script src="/258.d78093f4.js"></script>
<script src="/652b7eaf.c0dbaf4d.js"></script>
</body>
</html>