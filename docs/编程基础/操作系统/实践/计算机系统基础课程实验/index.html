<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Blog Atom Feed"><title data-react-helmet="true">计算机系统基础课程实验 | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="计算机系统基础课程实验 | My Site"><meta data-react-helmet="true" name="description" content="计算机系统基础课程实验"><meta data-react-helmet="true" property="og:description" content="计算机系统基础课程实验"><meta data-react-helmet="true" property="og:url" content="http://localhost:9999//docs/编程基础/操作系统/实践/计算机系统基础课程实验"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://localhost:9999//docs/编程基础/操作系统/实践/计算机系统基础课程实验"><link rel="stylesheet" href="/styles.8cfbcdec.css">
<link rel="preload" href="/styles.4ec932fe.js" as="script">
<link rel="preload" href="/runtime~main.3425bbd6.js" as="script">
<link rel="preload" href="/main.4d172be4.js" as="script">
<link rel="preload" href="/1.978a979f.js" as="script">
<link rel="preload" href="/284.9b127a42.js" as="script">
<link rel="preload" href="/285.87bc8610.js" as="script">
<link rel="preload" href="/935f2afb.0ad17a86.js" as="script">
<link rel="preload" href="/283.46b48473.js" as="script">
<link rel="preload" href="/4c8ef43c.fb07c9e9.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">基础</a><a class="navbar__item navbar__link" href="/docs/编程语言/编程语言">语言</a><a class="navbar__item navbar__link" href="/docs/工具/常用工具">工具</a><a class="navbar__item navbar__link" href="/docs/应用开发/应用开发">应用开发</a><a class="navbar__item navbar__link" href="/docs/Apple/iOS开发/iOS开发">Apple</a><a class="navbar__item navbar__link" href="/docs/音视频/音视频">音视频</a><a class="navbar__item navbar__link" href="/docs/项目/项目">项目</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">基础</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/编程语言/编程语言">语言</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/工具/常用工具">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/应用开发/应用开发">应用开发</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/iOS开发/iOS开发">Apple</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/音视频">音视频</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/项目/项目">项目</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">计算机系统基础课程实验</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="计算机系统基础课程实验"></a>计算机系统基础课程实验<a class="hash-link" href="#计算机系统基础课程实验" title="Direct link to heading">#</a></h1><p>参考：<a href="https://nju-projectn.github.io/ics-pa-gitbook/ics2020/" target="_blank" rel="noopener noreferrer">https://nju-projectn.github.io/ics-pa-gitbook/ics2020/</a></p><p>[toc]</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="开发环境配置"></a>开发环境配置<a class="hash-link" href="#开发环境配置" title="Direct link to heading">#</a></h2><p><a href="https://nju-projectn.github.io/ics-pa-gitbook/ics2020/0.3.html" target="_blank" rel="noopener noreferrer">https://nju-projectn.github.io/ics-pa-gitbook/ics2020/0.3.html</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="开天辟地的篇章-最简单的计算机"></a>开天辟地的篇章: 最简单的计算机<a class="hash-link" href="#开天辟地的篇章-最简单的计算机" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="在开始愉快的pa之旅之前"></a>在开始愉快的PA之旅之前<a class="hash-link" href="#在开始愉快的pa之旅之前" title="Direct link to heading">#</a></h3><p><strong>NEMU是什么?</strong></p><p>NEMU就是一个模拟出来的计算机系统, 物理计算机中的基本功能, 在NEMU中都是通过程序来实现的. </p><p>要模拟出一个计算机系统并没有你想象中的那么困难. 我们可以把计算机看成由若干个硬件部件组成, 这些部件之间相互协助, 完成&quot;运行程序&quot;这件事情. 在NEMU中, 每一个硬件部件都由一个程序相关的数据对象来模拟, 例如变量, 数组, 结构体等; 而对这些部件的操作则通过对相应数据对象的操作来模拟. 例如NEMU中使用数组来模拟内存, 那么对这个数组进行读写则相当于对内存进行读写.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="开天辟地的篇章"></a>开天辟地的篇章<a class="hash-link" href="#开天辟地的篇章" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="最简单的计算机"></a>最简单的计算机<a class="hash-link" href="#最简单的计算机" title="Direct link to heading">#</a></h4><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="内存"></a>内存<a class="hash-link" href="#内存" title="Direct link to heading">#</a></h5><p>程序放在哪里？</p><p>为了执行程序, 首先要解决的第一个问题, 就是要把程序放在哪里. 显然, 我们不希望自己创造的计算机只能执行小程序. 因此, 我们需要一个足够大容量的部件, 来放下各种各样的程序, 这个部件就是存储器. 于是, 先驱创造了存储器, 并把程序放在存储器中, 等待着CPU去执行.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="加法器"></a>加法器<a class="hash-link" href="#加法器" title="Direct link to heading">#</a></h5><p>谁来执行程序？</p><p>CPU是负责处理数据的核心电路单元, 也就是说, 程序的执行全靠它了. 但只有存储器的计算机还是不能进行计算. 自然地, CPU需要肩负起计算的重任, 先驱为CPU创造了运算器, 这样就可以对数据进行各种处理了. 如果觉得运算器太复杂, 那就先来考虑一个加法器吧.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="寄存器"></a>寄存器<a class="hash-link" href="#寄存器" title="Direct link to heading">#</a></h5><p>提高运算速度，暂存数据的需求？</p><p>有时候程序需要对同一个数据进行连续的处理. 例如要计算<code>1+2+...+100</code>, 就要对部分和<code>sum</code>进行累加, 如果每完成一次累加都需要把它写回存储器, 然后又把它从存储器中读出来继续加, 这样就太不方便了. 同时天下也没有免费的午餐, 存储器的大容量也是需要付出相应的代价的, 那就是速度慢, 这是先驱也无法违背的材料特性规律. 于是先驱为CPU创造了寄存器, 可以让CPU把正在处理中的数据暂时存放在其中.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="指令"></a>指令<a class="hash-link" href="#指令" title="Direct link to heading">#</a></h5><p>为了让强大的CPU成为忠诚的奴仆, 先驱还设计了&quot;指令&quot;, 用来指示CPU对数据进行何种处理. 这样, 我们就可以通过指令来控制CPU, 让它做我们想做的事情了.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="自动运行"></a>自动运行<a class="hash-link" href="#自动运行" title="Direct link to heading">#</a></h5><p>有了指令以后, 先驱提出了一个划时代的设想: 能否让程序来自动控制计算机的执行? 为了实现这个设想, 先驱和CPU作了一个简单的约定: 当执行完一条指令之后, 就继续执行下一条指令. 但CPU怎么知道现在执行到哪一条指令呢? 为此, 先驱为CPU创造了一个特殊的计数器, 叫&quot;程序计数器&quot;(Program Counter, PC). 在x86中, 它有一个特殊的名字, 叫<code>EIP</code>(Extended Instruction Pointer).</p><p>从此以后, 计算机就只需要做一件事情:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  从PC指示的存储器位置取出指令</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  执行指令</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  更新PC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>这样, 我们就有了一个足够简单的计算机了. 我们只要将一段指令序列放置在存储器中, 然后让PC指向第一条指令, 计算机就会自动执行这一段指令序列, 永不停止.</p><p>这个全自动的执行过程实在是太美妙了!</p><p>最简单的真实计算机需要满足哪些条件:</p><ul><li>结构上, TRM有存储器, 有PC, 有寄存器, 有加法器</li><li>工作方式上, TRM不断地重复以下过程: 从PC指示的存储器位置取出指令, 执行指令, 然后更新PC</li></ul><p>参考：<a href="https://nju-projectn.github.io/ics-pa-gitbook/ics2020/1.2.html" target="_blank" rel="noopener noreferrer">https://nju-projectn.github.io/ics-pa-gitbook/ics2020/1.2.html</a></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="重新认识程序-程序是个状态机"></a>重新认识程序: 程序是个状态机<a class="hash-link" href="#重新认识程序-程序是个状态机" title="Direct link to heading">#</a></h4><p>参考： <a href="https://nju-projectn.github.io/ics-pa-gitbook/ics2020/1.2.html" target="_blank" rel="noopener noreferrer">https://nju-projectn.github.io/ics-pa-gitbook/ics2020/1.2.html</a></p><p>既然计算机是一个数组逻辑电路, 那么我们可以把计算机划分成两部分, 一部分由所有时序逻辑部件(存储器, 计数器, 寄存器)构成, 另一部分则是剩余的组合逻辑部件(如加法器等). 这样以后, 我们就可以从状态机模型的视角来理解计算机的工作过程了: 在每个时钟周期到来的时候, 计算机根据当前时序逻辑部件的状态, 在组合逻辑部件的作用下, 计算出并转移到下一时钟周期的新状态.</p><p>这个计算机有4个8位的寄存器, 一个4位PC, 以及一段16字节的内存(也就是存储器), 那么这个计算机可以表示比特总数为<code>B = 4*8 + 4 + 16*8 = 164</code>, 因此这个计算机总共可以有<code>N = 2^B = 2^164</code>种不同的状态. 假设这个在这个计算机中, 所有指令的行为都是确定的, 那么给定<code>N</code>个状态中的任意一个, 其转移之后的新状态也是唯一确定的.</p><p>我们其实可以从两个互补的视角来看待同一个程序:</p><ul><li>一个是以代码(或指令序列)为表现形式的静态视角, 大家经常说的&quot;写程序&quot;/&quot;看代码&quot;, 其实说的都是这个静态视角. 这个视角的一个好处是描述精简, 分支, 循环和函数调用的组合使得我们可以通过少量代码实现出很复杂的功能. 但这也可能会使得我们对程序行为的理解造成困难.</li><li>另一个是以状态机的状态转移为运行效果的动态视角, 它直接刻画了&quot;程序在计算机上运行&quot;的本质. 但这一视角的状态数量非常巨大, 程序代码中的所有循环和函数调用都以指令的粒度被完全展开, 使得我们难以掌握程序的整体语义. 但对于程序的局部行为, 尤其是从静态视角来看难以理解的行为, 状态机视角可以让我们清楚地了解相应的细节.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="nemu框架代码初探"></a>NEMU框架代码初探<a class="hash-link" href="#nemu框架代码初探" title="Direct link to heading">#</a></h3><p>参考：<a href="https://nju-projectn.github.io/ics-pa-gitbook/ics2020/1.3.html" target="_blank" rel="noopener noreferrer">https://nju-projectn.github.io/ics-pa-gitbook/ics2020/1.3.html</a></p><ol><li>将客户程序读入到客户计算机中</li></ol><p>我们已经知道, NEMU是一个用来执行客户程序的程序, 但客户程序一开始并不存在于客户计算机中. 我们需要将客户程序读入到客户计算机中, 这件事是monitor来负责的. 于是NEMU在开始运行的时候, 首先会调用<code>init_monitor()</code>函数(在<code>nemu/src/monitor/monitor.c</code>中定义) 来进行一些和monitor相关的初始化工作.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="初始化工作"></a><strong>初始化工作</strong><a class="hash-link" href="#初始化工作" title="Direct link to heading">#</a></h4><p>这段模拟的是BIOS启动及操作系统加载。</p><p>BIOS启动也是约定，启动后到一个默认的地址。默认是BIOS的地址。对于NEMU是IMAGE_START（也就是<code>0x100000</code>） 对于linux就是：当电脑刚加电的时候，会做一些重置的工作，将 CS 设置为 0xFFFF，将 IP 设置为 0x0000，所以第一条指令就会指向 0xFFFF0，正是在 ROM 的范围内。</p><p>ISA相关的初始化工作.</p><p>一. 将一个内置的客户程序读入到内存中. 为了理解这项工作, 我们还需要理清三个问题:</p><ol><li><p>客户程序是什么? </p><p>我们知道, 程序是由指令构成的, 而不同ISA的指令也各不相同(想象一下用不同的语言来表达&quot;你好&quot;的意思), 因而程序本身肯定是<strong>ISA相关</strong>的. 因此, 我们把内置客户程序放在<code>nemu/src/isa/$ISA/init.c</code>中. 内置客户程序的行为非常简单, 它只包含少数几条指令, 甚至算不上在做一些有意义的事情.</p></li><li><p>内存是什么? </p><p>我们可以把内存看作一段连续的存储空间, 而内存又是字节编址的(即一个内存位置存放一个字节的数据), 在C语言中我们就很自然地使用一个uint8_t类型的<strong>数组</strong>来对内存进行模拟. NEMU默认为客户计算机提供128MB的物理内存(见nemu/src/memory/paddr.c中定义的pmem),</p></li><li><p>需要将客户程序读入到内存的什么位置? </p><p>为了让客户计算机的CPU可以执行客户程序, 因此我们需要一种方式让客户计算机的CPU知道客户程序的位置. 我们采取一种最简单的方式: <strong>约定</strong>. 具体地, 我们让monitor直接把客户程序读入到一个固定的内存位置IMAGE_START(也就是0x100000).</p></li></ol><p>二.<code>init_isa()</code>的第二项任务是初始化寄存器。</p><p> 这是通过<code>restart()</code>函数来实现的. 在CPU中, 寄存器是一个结构化特征较强的存储部件, 在C语言中我们就很自然地使用相应的结构体来描述CPU的寄存器结构. 不同ISA的寄存器结构也各不相同, 为此我们把寄存器结构体<code>CPU_state</code>的定义放在<code>nemu/include/isa/$ISA.h</code>中, 并在<code>nemu/src/moinitor/cpu-exec.c</code>中定义一个全局变量<code>cpu</code>. <strong>初始化寄存器的一个重要工作就是设置<code>cpu.pc</code>的初值</strong>, 我们需要将它设置成刚才加载客户程序的内存位置, 这样就可以让CPU从我们约定的内存位置开始执行客户程序了. 对于mips32和riscv32, 它们的0号寄存器总是存放<code>0</code>, 因此我们也需要对其进行初始化.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">物理内存的起始地址</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">x86的物理内存是从0开始编址的, 但对于一些ISA来说却不是这样, 例如mips32和riscv32的物理地址均从0x80000000开始. 因此对于mips32和riscv32, 其nemu/include/isa/$ISA.h中的PMEM_BASE将会被定义成0x80000000. 将来CPU访问内存时, 我们会将CPU将要访问的内存地址映射到pmem中的相应偏移位置. 例如如果mips32的CPU打算访问内存地址0x80100000, 我们会让它最终访问pmem[0x100000], 从而可以正确访问客户程序的第一条指令. 这种机制有一个专门的名字, 叫地址映射, 在后续的PA中我们还会再遇到它.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>注意：可以看一看 PMEM_BASE 的定义 PMEM_BASE 是个宏，我们根据不同的架构可以得到不同的实现。不同的架构，参数用make传入。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">nemu</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">include</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">isa</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">h</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain">  #define IMAGE_START </span><span class="token function" style="color:rgb(130, 170, 255)">concat</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">__ISA__</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> _IMAGE_START</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">11</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> #define PMEM_BASE </span><span class="token function" style="color:rgb(130, 170, 255)">concat</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">__ISA__</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> _PMEM_BASE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">12</span><span class="token plain">  </span><span class="token keyword" style="font-style:italic">typedef</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">concat</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">__ISA__</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> _CPU_state</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> CPU_state</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">nemu</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">include</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">isa</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">mips32</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">h</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">7</span><span class="token plain">  #define mips32_IMAGE_START </span><span class="token number" style="color:rgb(247, 140, 108)">0x100000</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> #define mips32_PMEM_BASE </span><span class="token number" style="color:rgb(247, 140, 108)">0x80000000</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">9</span><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">nemu</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">include</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">isa</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">riscv32</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">h</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">7</span><span class="token plain">  #define riscv32_IMAGE_START </span><span class="token number" style="color:rgb(247, 140, 108)">0x100000</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> #define riscv32_PMEM_BASE </span><span class="token number" style="color:rgb(247, 140, 108)">0x80000000</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">9</span><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">nemu</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">include</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">isa</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">riscv64</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">h</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">7</span><span class="token plain">  #define riscv64_IMAGE_START </span><span class="token number" style="color:rgb(247, 140, 108)">0x100000</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> #define riscv64_PMEM_BASE </span><span class="token number" style="color:rgb(247, 140, 108)">0x80000000</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">9</span><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">nemu</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">include</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">isa</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">x86</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">h</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">  #define x86_IMAGE_START </span><span class="token number" style="color:rgb(247, 140, 108)">0x100000</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">9</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> #define x86_PMEM_BASE </span><span class="token number" style="color:rgb(247, 140, 108)">0x0</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">nemu</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">src</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">isa</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">mips32</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">init</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">c</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">14</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* Set the initial program counter. */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">15</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain">   cpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pc </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> PMEM_BASE </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> IMAGE_START</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">nemu</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">src</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">isa</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">riscv32</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">init</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">c</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">14</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* Set the initial program counter. */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">15</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain">   cpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pc </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> PMEM_BASE </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> IMAGE_START</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">nemu</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">src</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">isa</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">riscv64</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">init</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">c</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">14</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* Set the initial program counter. */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">15</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain">   cpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pc </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> PMEM_BASE </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> IMAGE_START</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">nemu</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">src</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">isa</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">x86</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">init</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">c</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">17</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* Set the initial instruction pointer. */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">18</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain">   cpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">pc </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> PMEM_BASE </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> IMAGE_START</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">19</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>将来CPU访问内存时, 我们会将CPU将要访问的内存地址映射到pmem中的相应偏移位置. 例如如果mips32的CPU打算访问内存地址0x80100000, 我们会让它最终访问pmem[0x100000], 从而可以正确访问客户程序的第一条指令. 这种机制有一个专门的名字, 叫地址映射</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">nemu</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">src</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">memory</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">paddr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">c</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">26</span><span class="token plain">  </span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">inline</span><span class="token plain"> bool </span><span class="token function" style="color:rgb(130, 170, 255)">in_pmem</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">paddr_t addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">27</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain">   </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">PMEM_BASE </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;=</span><span class="token plain"> addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">addr </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;=</span><span class="token plain"> PMEM_BASE </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> PMEM_SIZE </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">28</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">30</span><span class="token plain">  </span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">inline</span><span class="token plain"> word_t </span><span class="token function" style="color:rgb(130, 170, 255)">pmem_read</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">paddr_t addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">31</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain">   </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">p </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">pmem</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">addr </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> PMEM_BASE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">32</span><span class="token plain">    </span><span class="token keyword" style="font-style:italic">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">43</span><span class="token plain">  </span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">inline</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">pmem_write</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">paddr_t addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> word_t data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">44</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain">   </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">p </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">pmem</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">addr </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> PMEM_BASE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">45</span><span class="token plain">    </span><span class="token keyword" style="font-style:italic">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Monitor读入客户程序并对寄存器进行初始化后, 这时内存的布局如下:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pmem:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0             0x100000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-----------------------------------------------</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">|                 |                  |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">|                 |    guest prog    |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">|                 |                  |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-----------------------------------------------</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  ^</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                 pc</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>NEMU返回到<code>init_monitor()</code>函数中, 继续调用<code>load_img()</code>函数.(在<code>nemu/src/monitor/monitor.c</code>中定义). 这个函数会将一个有意义的客户程序从<a href="https://en.wikipedia.org/wiki/Disk_image" target="_blank" rel="noopener noreferrer">镜像文件</a>读入到内存, 覆盖刚才的内置客户程序.</p><p>monitor剩余的初始化工作我们会在后续实验内容中介绍, 目前你无需关心它们的细节, 最后monitor会调用<code>welcome()</code>函数输出欢迎信息. 现在你可以在<code>nemu/</code>目录下编译并运行NEMU了:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">make ISA=$ISA run</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="运行第一个程序"></a>运行第一个程序<a class="hash-link" href="#运行第一个程序" title="Direct link to heading">#</a></h4><p>这段模拟的是操作系统运行起来后的状态。（循环，等待接受用户指令）</p><p>Monitor的初始化工作结束后, <code>main()</code>函数会继续调用<code>engine_start()</code>函数 (在<code>nemu/src/engine/interpreter/init.c</code>中定义). 代码还会对设备进行初始化(目前无需关心), 然后进入用户界面主循环<code>ui_mainloop()</code>(在<code>nemu/src/monitor/debug/ui.c</code>中定义), 并输出NEMU的命令提示符:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(nemu)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><a href="https://blog.csdn.net/qq_33850438/article/details/80172275" target="_blank" rel="noopener noreferrer">浅谈linux的命令行解析参数之getopt_long函数</a></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">6、返回值：</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         （1）如果短选项找到，那么将返回短选项对应的字符。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         （2）如果长选项找到，如果flag为NULL，返回val。如果flag不为空，返回0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         （3）如果遇到一个选项没有在短字符、长字符里面。或者在长字符里面存在二义性的，返回“？”</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         （4）如果解析完所有字符没有找到（一般是输入命令参数格式错误，eg： 连斜杠都没有加的选项），返回“-1”</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         （5）如果选项需要参数，忘了添加参数。返回值取决于optstring，如果其第一个字符是“：”，则返回“：”，否则返回“？”。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">注意：</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        （1）longopts的最后一个元素必须是全0填充，否则会报段错误</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        （2）短选项中每个选项都是唯一的。而长选项如果简写，也需要保持唯一性。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">————————————————</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">版权声明：本文为CSDN博主「andy cong」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">原文链接：https://blog.csdn.net/qq_33850438/article/details/80172275</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="gdb调试"></a>GDB调试<a class="hash-link" href="#gdb调试" title="Direct link to heading">#</a></h4><p>GDB还自带一个叫TUI的简单界面. 在一个高度较高的窗口中运行GDB后, 输入<code>layout split</code>就可以切换到TUI, 这样你就可以同时从源代码和指令的角度来观察程序的行为了. 如果你想了解TUI的更多内容, STFW.</p><p>为了帮助你更高效地RTFSC, 你最好通过RTFM和STFW多认识GDB的一些命令和操作, 比如:</p><ul><li>单步执行进入你感兴趣的函数</li><li>单步执行跳过你不感兴趣的函数(例如库函数)</li><li>运行到函数末尾</li><li>打印变量或寄存器的值</li><li>扫描内存</li><li>查看调用栈</li><li>设置断点</li><li>设置监视点</li></ul><p>参考：http://localhost:9998/ics2020/1.3.html</p><p>通过预编译把 宏定义，也就是所谓的元编程展开，方便查看代码</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Compilation patterns</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$(OBJ_DIR)/%.o: src/%.c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @echo + CC $&lt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @mkdir -p $(dir $@)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @$(CC) $(CFLAGS) $(SO_CFLAGS) -c -o $@ $&lt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @$(CC) $(CFLAGS) $(SO_CFLAGS) -E -MF /dev/null $&lt; | \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      grep -ve &#x27;^#&#x27; | \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      clang-format - &gt; $(basename $@).i</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static inline def_EHelper(gp1) { // ???</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  EMPTY(0) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // EMPTY(idx)  =&gt;  EX(idx, inv)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // EX(idx, inv)  =&gt;  EXW(idx, inv, 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // !@%#&amp;%^!#@&amp;%!^@%#$%*^!#@*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="基础设施"></a>基础设施<a class="hash-link" href="#基础设施" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="解析命令"></a>解析命令<a class="hash-link" href="#解析命令" title="Direct link to heading">#</a></h4><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="单步执行"></a>单步执行<a class="hash-link" href="#单步执行" title="Direct link to heading">#</a></h4><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="打印寄存器"></a>打印寄存器<a class="hash-link" href="#打印寄存器" title="Direct link to heading">#</a></h4><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="扫描内存"></a>扫描内存<a class="hash-link" href="#扫描内存" title="Direct link to heading">#</a></h4><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="运行时环境"></a>运行时环境<a class="hash-link" href="#运行时环境" title="Direct link to heading">#</a></h2><p>一个事实是, 应用程序的运行都需要<a href="http://en.wikipedia.org/wiki/Runtime_system" target="_blank" rel="noopener noreferrer">运行时环境</a>的支持, 包括</p><ul><li>加载</li><li>销毁程序</li><li>以及提供程序运行时的各种动态链接库(你经常使用的库函数就是运行时环境提供的)等</li></ul><p>参考：<a href="https://nju-projectn.github.io/ics-pa-gitbook/ics2020/2.3.html" target="_blank" rel="noopener noreferrer">https://nju-projectn.github.io/ics-pa-gitbook/ics2020/2.3.html</a></p><p>只要有内存, 有结束运行的方式, 加上实现正确的指令, 就可以支撑最简单程序的运行了. 而这, 也可以算是最简单的运行时环境了.</p><p>这个例子也展示了运行时环境的一种普遍的存在方式: <strong>库</strong>. 通过库, 运行程序所需要的公共要素被抽象成API, 不同的架构只需要实现这些API, 也就相当于实现了支撑程序运行的运行时环境, 这提升了程序开发的效率: 需要的时候只要调用这些API, 就能使用运行时环境提供的相应功能.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="简单复杂的机器-冯诺依曼计算机系统"></a>简单复杂的机器: 冯诺依曼计算机系统<a class="hash-link" href="#简单复杂的机器-冯诺依曼计算机系统" title="Direct link to heading">#</a></h2><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="io"></a>IO<a class="hash-link" href="#io" title="Direct link to heading">#</a></h2><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  ~ lspci -t</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-[0000:00]-+-00.0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           +-01.0-[01]----00.0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           +-03.0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           +-05.0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           +-0a.0-[02]--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           +-0e.0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           +-1d.0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           +-1d.6</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           +-1d.7</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           +-1e.0-[03]--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           +-1f.0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           +-1f.1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           +-1f.2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           +-1f.3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           \-1f.4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  ~ lspci</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:00.0 Host bridge: Intel Corporation 82P965/G965 Memory Controller Hub (rev 02)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:01.0 PCI bridge: Intel Corporation 82G35 Express PCI Express Root Port (rev 02)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:03.0 Unassigned class [ff00]: Parallels, Inc. Virtual Machine Communication Interface</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:05.0 Ethernet controller: Red Hat, Inc Virtio network device</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:0a.0 PCI bridge: Digital Equipment Corporation DECchip 21150</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:0e.0 RAM memory: Red Hat, Inc Virtio memory balloon</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:1d.0 USB controller: Intel Corporation 82801FB/FBM/FR/FW/FRW (ICH6 Family) USB UHCI #1 (rev 02)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:1d.6 USB controller: NEC Corporation uPD720200 USB 3.0 Host Controller (rev 04)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:1d.7 USB controller: Intel Corporation 82801FB/FBM/FR/FW/FRW (ICH6 Family) USB2 EHCI Controller (rev 02)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:1e.0 PCI bridge: Intel Corporation 82801 PCI Bridge (rev f2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:1f.0 ISA bridge: Intel Corporation 82801HB/HR (ICH8/R) LPC Interface Controller (rev 02)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:1f.1 IDE interface: Intel Corporation 82801BA IDE U100 Controller (rev 05)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:1f.2 SATA controller: Intel Corporation 82801HR/HO/HH (ICH8R/DO/DH) 6 port SATA Controller [AHCI mode] (rev 02)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:1f.3 SMBus: Intel Corporation 82801H (ICH8 Family) SMBus Controller (rev 02)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">00:1f.4 Multimedia audio controller: Intel Corporation 82801BA/BAM AC&#x27;97 Audio Controller (rev 02)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">01:00.0 VGA compatible controller: Red Hat, Inc Virtio GPU (rev 01)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  ~ lsusb </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Bus 002 Device 003: ID 203a:fffc  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Bus 002 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">➜  ~ lsusb -t</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/:  Bus 04.Port 1: Dev 1, Class=root_hub, Driver=xhci_hcd/12p, 5000M</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/:  Bus 03.Port 1: Dev 1, Class=root_hub, Driver=xhci_hcd/2p, 480M</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/:  Bus 02.Port 1: Dev 1, Class=root_hub, Driver=uhci_hcd/2p, 12M</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    |__ Port 1: Dev 3, If 0, Class=Human Interface Device, Driver=usbhid, 12M</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    |__ Port 1: Dev 3, If 1, Class=Human Interface Device, Driver=usbhid, 12M</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/:  Bus 01.Port 1: Dev 1, Class=root_hub, Driver=ehci-pci/15p, 480M</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="重要收获"></a>重要收获<a class="hash-link" href="#重要收获" title="Direct link to heading">#</a></h2><ul><li><p>内存只是个字节序列</p></li><li><p>无论何种类型的指针都只是地址 + 对指向内存的解读</p></li><li><p>匿名结构体和匿名联合体 参考：<a href="https://blog.csdn.net/openblog/article/details/7548363" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/openblog/article/details/7548363</a></p></li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="dys-typora-open://mine/survival/docs/编程基础/操作系统/实践/计算机系统基础课程实验.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#开发环境配置" class="table-of-contents__link">开发环境配置</a></li><li><a href="#开天辟地的篇章-最简单的计算机" class="table-of-contents__link">开天辟地的篇章: 最简单的计算机</a><ul><li><a href="#在开始愉快的pa之旅之前" class="table-of-contents__link">在开始愉快的PA之旅之前</a></li><li><a href="#开天辟地的篇章" class="table-of-contents__link">开天辟地的篇章</a></li><li><a href="#nemu框架代码初探" class="table-of-contents__link">NEMU框架代码初探</a></li><li><a href="#基础设施" class="table-of-contents__link">基础设施</a></li></ul></li><li><a href="#运行时环境" class="table-of-contents__link">运行时环境</a></li><li><a href="#简单复杂的机器-冯诺依曼计算机系统" class="table-of-contents__link">简单复杂的机器: 冯诺依曼计算机系统</a></li><li><a href="#io" class="table-of-contents__link">IO</a></li><li><a href="#重要收获" class="table-of-contents__link">重要收获</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.4ec932fe.js"></script>
<script src="/runtime~main.3425bbd6.js"></script>
<script src="/main.4d172be4.js"></script>
<script src="/1.978a979f.js"></script>
<script src="/284.9b127a42.js"></script>
<script src="/285.87bc8610.js"></script>
<script src="/935f2afb.0ad17a86.js"></script>
<script src="/283.46b48473.js"></script>
<script src="/4c8ef43c.fb07c9e9.js"></script>
</body>
</html>