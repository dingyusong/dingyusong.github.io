<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Blog Atom Feed"><title data-react-helmet="true">并发编程 | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="并发编程 | My Site"><meta data-react-helmet="true" name="description" content="小技巧："><meta data-react-helmet="true" property="og:description" content="小技巧："><meta data-react-helmet="true" property="og:url" content="http://localhost:9999//docs/Apple/并发编程/并发编程"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://localhost:9999//docs/Apple/并发编程/并发编程"><link rel="stylesheet" href="/styles.8cfbcdec.css">
<link rel="preload" href="/styles.9ca0c92b.js" as="script">
<link rel="preload" href="/runtime~main.5bad3ec1.js" as="script">
<link rel="preload" href="/main.22d8e8fb.js" as="script">
<link rel="preload" href="/1.9cf17d37.js" as="script">
<link rel="preload" href="/261.52f5f543.js" as="script">
<link rel="preload" href="/262.169b345b.js" as="script">
<link rel="preload" href="/935f2afb.f2cfb3e3.js" as="script">
<link rel="preload" href="/260.17f75af6.js" as="script">
<link rel="preload" href="/32ae96d4.974fb9e2.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a><a class="navbar__item navbar__link" href="/docs/">基础</a><a class="navbar__item navbar__link" href="/docs/编程语言/编程语言">语言</a><a class="navbar__item navbar__link" href="/docs/工具/常用工具">工具</a><a class="navbar__item navbar__link" href="/docs/应用开发/应用开发">应用开发</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Apple/iOS开发/iOS开发">Apple</a><a class="navbar__item navbar__link" href="/docs/音视频/音视频">音视频</a><a class="navbar__item navbar__link" href="/docs/项目/项目">项目</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">基础</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/编程语言/编程语言">语言</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/工具/常用工具">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/应用开发/应用开发">应用开发</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/Apple/iOS开发/iOS开发">Apple</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/音视频">音视频</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/项目/项目">项目</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/iOS开发/iOS开发">iOS开发</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/macOS开发/macOS开发">macOS开发</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/库/库">库</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/逆向/iOS逆向">iOS逆向</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" href="/docs/Apple/并发编程/并发编程">并发编程</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/网络编程/网络编程">网络编程</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/开发工具/工具">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/跨平台和热更新/跨平台">跨平台</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/编译构建发布/编译构建发布">编译构建发布</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/崩溃分析/崩溃分析">崩溃分析</a></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">并发编程</h1></header><div class="markdown"><p>小技巧：</p><blockquote><p>对于多线程程序，打个断点，然后查看线程堆栈来学习。</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="pthread"></a>pthread<a class="hash-link" href="#pthread" title="Direct link to heading">#</a></h2><p><a href="https://pubs.opengroup.org/onlinepubs/7908799/xsh/pthread.h.html" target="_blank" rel="noopener noreferrer">https://pubs.opengroup.org/onlinepubs/7908799/xsh/pthread.h.html</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="同步"></a>同步<a class="hash-link" href="#同步" title="Direct link to heading">#</a></h2><p>并发的另一面是同步。也就是顺序性，按照顺序一个一个来。临界区代码（读写共享变量）的执行，不能同时进行，业务的逻辑，我需要有依赖，必须一个有结果之后才能进行下一个。由此衍生出锁，条件变量，信号量。</p><p>信号量是简化版的条件变量。</p><p>条件变量的条件需要自己处理，信号量简化为，整形变量和0的比较。</p><p>非简单的数值和0比较，而是需要各种逻辑操作的复杂场景，需要使用条件变量。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="rzpaas的闲置线程"></a>RZPaas的闲置线程<a class="hash-link" href="#rzpaas的闲置线程" title="Direct link to heading">#</a></h2><p>一个线程池的闲置线程</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="调用栈"></a>调用栈<a class="hash-link" href="#调用栈" title="Direct link to heading">#</a></h3><p>线程池的闲置线程的调用栈</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">0   libsystem_kernel.dylib              0x0000000195f6ebc0 __psynch_cvwait + 8</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1   libsystem_pthread.dylib             0x0000000195e911e4 _pthread_cond_wait + 680</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2   libc++.1.dylib                      0x0000000195fc2d44 std::__1::condition_variable::__do_timed_wait+ 52548 (std::__1::unique_lock&lt;std::__1::mutex&gt;&amp;, std::__1::chrono::time_point&lt;std::__1::chrono::system_clock, std::__1::chrono::duration&lt;long long, std::__1::ratio&lt;1l, 1000000000l&gt; &gt; &gt;) + 100</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3   RZPaas_iOS                          0x0000000102e7ae48 rz::Thread::ThreadFun() + 142920 (ThreadPool.cpp:28)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">4   RZPaas_iOS                          0x0000000102e7b464 void* std::__1::__thread_proxy&lt;std::__1::tuple&lt;std::__1::unique_ptr&lt;std::__1::__thread_struct, std::__1::default_delete&lt;std::__1::__thread_struct&gt; &gt;, void (rz::Thread::*)(), rz::Thread*&gt; &gt;(void*) + 144484 (thread:299)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">5   libsystem_pthread.dylib             0x0000000195e8d8fc _pthread_start + 168</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="主要的两个函数分析"></a>主要的两个函数分析<a class="hash-link" href="#主要的两个函数分析" title="Direct link to heading">#</a></h3><ul><li>线程入口函数</li></ul><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">void* std::__1::__thread_proxy&lt; F &gt;(void*)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><code>__thread_proxy</code> 代理了<code>rz::Thread::ThreadFun()</code></p><ul><li>等待条件变量</li></ul><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">std::__1::condition_variable::__do_timed_wait(E, D)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">A = std::__1::ratio&lt;1l, 1000000000l&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">B = std::__1::chrono::duration&lt;long long, A &gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">C = std::__1::chrono::system_clock</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">D = std::__1::chrono::time_point&lt;C, B &gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">E = std::__1::unique_lock&lt;std::__1::mutex&gt;&amp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">std::__1::condition_variable::__do_timed_wait(E, D)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">A = rz::Thread*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">B = void (rz::Thread::*)()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">C = std::__1::default_delete&lt;std::__1::__thread_struct&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">D = std::__1::__thread_struct</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">E = std::__1::unique_ptr&lt;D, C &gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">F = std::__1::tuple&lt;E, B, A&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">void* std::__1::__thread_proxy&lt; F &gt;(void*)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="rapaassdk"></a>RAPaasSDK<a class="hash-link" href="#rapaassdk" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">//启动线程池</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">void ThreadPool::Start() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (running) return;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    running = true;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (int i = 0; i &lt; RZPaaSConfig::dataFlowThreadNum; i++) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      std::shared_ptr&lt;Thread&gt; thread = std::make_shared&lt;Thread&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      threadPool.push_back(thread);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//线程构造函数</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thread::Thread() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  running = true;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  workThread = std::thread(&amp;Thread::ThreadFun, this);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//线程运行函数</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">void Thread::ThreadFun() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ProcessTask* task;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  while (running) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    task = ThreadPool::getTask();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (task != nullptr) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      auto _olog = RZLOG_GUARD(task-&gt;processName, &quot;threadPool run task overTime: &quot;, 200);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      task-&gt;taskFun();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      delete task;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      task = nullptr;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      working = false;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      std::unique_lock&lt;std::mutex&gt; lk(threadMX);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      conditionVariable.wait_for(lk, std::chrono::milliseconds(10));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      working = true;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="libcxx"></a>libcxx<a class="hash-link" href="#libcxx" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">template &lt;class _Fp, class ..._Args,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          class</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         &gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">thread::thread(_Fp&amp;&amp; __f, _Args&amp;&amp;... __args)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    typedef unique_ptr&lt;__thread_struct&gt; _TSPtr;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _TSPtr __tsp(new __thread_struct);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    typedef tuple&lt;_TSPtr, typename decay&lt;_Fp&gt;::type, typename decay&lt;_Args&gt;::type...&gt; _Gp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    unique_ptr&lt;_Gp&gt; __p(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            new _Gp(_VSTD::move(__tsp),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    _VSTD::__decay_copy(_VSTD::forward&lt;_Fp&gt;(__f)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    _VSTD::__decay_copy(_VSTD::forward&lt;_Args&gt;(__args))...));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int __ec = _VSTD::__libcpp_thread_create(&amp;__t_, &amp;__thread_proxy&lt;_Gp&gt;, __p.get());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (__ec == 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __p.release();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __throw_system_error(__ec, &quot;thread constructor failed&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">template &lt;class _Rep, class _Period&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cv_status</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">condition_variable::wait_for(unique_lock&lt;mutex&gt;&amp; __lk,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                             const chrono::duration&lt;_Rep, _Period&gt;&amp; __d)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    using namespace chrono;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (__d &lt;= __d.zero())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return cv_status::timeout;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    using __ns_rep = nanoseconds::rep;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    steady_clock::time_point __c_now = steady_clock::now();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#if defined(_LIBCPP_HAS_COND_CLOCKWAIT)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    using __clock_tp_ns = time_point&lt;steady_clock, nanoseconds&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __ns_rep __now_count_ns = _VSTD::__safe_nanosecond_cast(__c_now.time_since_epoch()).count();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    using __clock_tp_ns = time_point&lt;system_clock, nanoseconds&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __ns_rep __now_count_ns = _VSTD::__safe_nanosecond_cast(system_clock::now().time_since_epoch()).count();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#endif</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __ns_rep __d_ns_count = _VSTD::__safe_nanosecond_cast(__d).count();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (__now_count_ns &gt; numeric_limits&lt;__ns_rep&gt;::max() - __d_ns_count) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __do_timed_wait(__lk, __clock_tp_ns::max());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __do_timed_wait(__lk, __clock_tp_ns(nanoseconds(__now_count_ns + __d_ns_count)));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return steady_clock::now() - __c_now &lt; __d ? cv_status::no_timeout :</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                                 cv_status::timeout;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">void</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">condition_variable::__do_timed_wait(unique_lock&lt;mutex&gt;&amp; lk,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     chrono::time_point&lt;chrono::system_clock, chrono::nanoseconds&gt; tp) noexcept</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    using namespace chrono;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (!lk.owns_lock())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __throw_system_error(EPERM,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;condition_variable::timed wait: mutex not locked&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    nanoseconds d = tp.time_since_epoch();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (d &gt; nanoseconds(0x59682F000000E941))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        d = nanoseconds(0x59682F000000E941);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __libcpp_timespec_t ts;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    seconds s = duration_cast&lt;seconds&gt;(d);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    typedef decltype(ts.tv_sec) ts_sec;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _LIBCPP_CONSTEXPR ts_sec ts_sec_max = numeric_limits&lt;ts_sec&gt;::max();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (s.count() &lt; ts_sec_max)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ts.tv_sec = static_cast&lt;ts_sec&gt;(s.count());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ts.tv_nsec = static_cast&lt;decltype(ts.tv_nsec)&gt;((d - s).count());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ts.tv_sec = ts_sec_max;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ts.tv_nsec = giga::num - 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int ec = __libcpp_condvar_timedwait(&amp;__cv_, lk.mutex()-&gt;native_handle(), &amp;ts);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (ec != 0 &amp;&amp; ec != ETIMEDOUT)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __throw_system_error(ec, &quot;condition_variable timed_wait failed&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">int __libcpp_condvar_timedwait(__libcpp_condvar_t *__cv, __libcpp_mutex_t *__m,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                               __libcpp_timespec_t *__ts)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  return pthread_cond_timedwait(__cv, __m, __ts);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="libpthread"></a>libpthread<a class="hash-link" href="#libpthread" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">int</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pthread_cond_timedwait(pthread_cond_t *cond, pthread_mutex_t *mutex,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        const struct timespec *abstime)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return _pthread_cond_wait(cond, mutex, abstime, 0, _pthread_conformance());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * Suspend waiting for a condition variable.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * If conformance is not cancelable, we skip the pthread_testcancel(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * but keep the remaining conforming behavior.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">PTHREAD_NOEXPORT OS_NOINLINE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">int</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">_pthread_cond_wait(pthread_cond_t *cond, pthread_mutex_t *mutex,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            const struct timespec *abstime, int isRelative,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            pthread_conformance_t conforming)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int res;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    struct timespec then = { 0, 0 };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    bool timeout_elapsed = false;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (!_pthread_mutex_check_signature(mutex) &amp;&amp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            !_pthread_mutex_check_signature_init(mutex)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return EINVAL;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    bool ulock = _pthread_mutex_uses_ulock(mutex);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    uint32_t sig = ulock ? _PTHREAD_COND_SIG_ulock : _PTHREAD_COND_SIG_psynch;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    res = _pthread_cond_check_init(cond, &amp;sig);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (res != 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return res;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (conforming == PTHREAD_CONFORM_UNIX03_CANCELABLE) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        pthread_testcancel();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /* send relative time to kernel */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (abstime) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (abstime-&gt;tv_nsec &lt; 0 || abstime-&gt;tv_nsec &gt;= NSEC_PER_SEC) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // TODO: PTHREAD_STRICT candidate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return EINVAL;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (isRelative == 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            struct timespec now;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            struct timeval tv;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            __gettimeofday(&amp;tv, NULL);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            TIMEVAL_TO_TIMESPEC(&amp;tv, &amp;now);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if ((abstime-&gt;tv_sec == now.tv_sec) ?</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                (abstime-&gt;tv_nsec &lt;= now.tv_nsec) :</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                (abstime-&gt;tv_sec &lt; now.tv_sec)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                timeout_elapsed = true;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                /* Compute relative time to sleep */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                then.tv_nsec = abstime-&gt;tv_nsec - now.tv_nsec;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                then.tv_sec = abstime-&gt;tv_sec - now.tv_sec;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (then.tv_nsec &lt; 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    then.tv_nsec += NSEC_PER_SEC;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    then.tv_sec--;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            then.tv_sec = abstime-&gt;tv_sec;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            then.tv_nsec = abstime-&gt;tv_nsec;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if ((then.tv_sec == 0) &amp;&amp; (then.tv_nsec == 0)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                timeout_elapsed = true;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (!ulock &amp;&amp; cond-&gt;busy != NULL &amp;&amp; cond-&gt;busy != mutex) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // TODO: PTHREAD_STRICT candidate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return EINVAL;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     * If timeout is known to have elapsed, we still need to unlock and</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     * relock the mutex to allow other waiters to get in line and</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     * modify the condition state.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (timeout_elapsed) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        res = pthread_mutex_unlock(mutex);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (res != 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return res;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        res = pthread_mutex_lock(mutex);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (res != 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return res;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return ETIMEDOUT;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (ulock) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return _pthread_ulock_cond_wait(cond, mutex, &amp;then, conforming);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return _pthread_psynch_cond_wait(cond, mutex, &amp;then, conforming);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">static int</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">_pthread_psynch_cond_wait(pthread_cond_t *cond,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            pthread_mutex_t *mutex,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            const struct timespec *then,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            pthread_conformance_t conforming)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    uint32_t mtxgen, mtxugen, flags=0, updateval;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    uint32_t lcntval, ucntval, scntval;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    uint32_t nlval, ulval, savebits;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    volatile uint64_t *c_lsseqaddr;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    volatile uint32_t *c_lseqcnt, *c_useqcnt, *c_sseqcnt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    uint64_t oldval64, newval64, mugen, cvlsgen;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    uint32_t *npmtx = NULL;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    COND_GETSEQ_ADDR(cond, &amp;c_lsseqaddr, &amp;c_lseqcnt, &amp;c_useqcnt, &amp;c_sseqcnt);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    do {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        lcntval = *c_lseqcnt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ucntval = *c_useqcnt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        scntval = *c_sseqcnt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        oldval64 = (((uint64_t)scntval) &lt;&lt; 32);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        oldval64 |= lcntval;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /* remove c and p bits on S word */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        savebits = scntval &amp; PTH_RWS_CV_BITSALL;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ulval = (scntval &amp; PTHRW_COUNT_MASK);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        nlval = lcntval + PTHRW_INC;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        newval64 = (((uint64_t)ulval) &lt;&lt; 32);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        newval64 |= nlval;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } while (!os_atomic_cmpxchg(c_lsseqaddr, oldval64, newval64, seq_cst));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cond-&gt;busy = mutex;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int res = _pthread_mutex_droplock(mutex, &amp;flags, &amp;npmtx, &amp;mtxgen, &amp;mtxugen);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /* TBD: cases are for normal (non owner for recursive mutex; error checking)*/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (res != 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return EINVAL;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if ((flags &amp; _PTHREAD_MTX_OPT_NOTIFY) == 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        npmtx = NULL;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        mugen = 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        mugen = ((uint64_t)mtxugen &lt;&lt; 32) | mtxgen;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    flags &amp;= ~_PTHREAD_MTX_OPT_MUTEX;   /* reset the mutex bit as this is cvar */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cvlsgen = ((uint64_t)(ulval | savebits)&lt;&lt; 32) | nlval;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // SUSv3 requires pthread_cond_wait to be a cancellation point</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (conforming == PTHREAD_CONFORM_UNIX03_CANCELABLE) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        pthread_cleanup_push(_pthread_psynch_cond_cleanup, (void *)cond);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        updateval = __psynch_cvwait(cond, cvlsgen, ucntval, (pthread_mutex_t *)npmtx, mugen, flags, (int64_t)(then-&gt;tv_sec), (int32_t)(then-&gt;tv_nsec));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        pthread_testcancel();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        pthread_cleanup_pop(0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        updateval = __psynch_cvwait(cond, cvlsgen, ucntval, (pthread_mutex_t *)npmtx, mugen, flags, (int64_t)(then-&gt;tv_sec), (int32_t)(then-&gt;tv_nsec));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (updateval == (uint32_t)-1) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        int err = errno;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        switch (err &amp; 0xff) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        case ETIMEDOUT:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            res = ETIMEDOUT;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            break;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        case EINTR:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // spurious wakeup (unless canceled)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            res = 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            break;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        default:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            res = EINVAL;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            break;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // add unlock ref to show one less waiter</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _pthread_cond_updateval(cond, mutex, err, 0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } else if (updateval != 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Successful wait</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // The return due to prepost and might have bit states</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // update S and return for prepo if needed</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _pthread_cond_updateval(cond, mutex, 0, updateval);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pthread_mutex_lock(mutex);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return res;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="dys-typora-open://mine/survival/docs/Apple/并发编程/并发编程.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/Apple/逆向/iOS逆向"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« iOS逆向</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Apple/网络编程/网络编程"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">网络编程 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#pthread" class="table-of-contents__link">pthread</a></li><li><a href="#同步" class="table-of-contents__link">同步</a></li><li><a href="#rzpaas的闲置线程" class="table-of-contents__link">RZPaas的闲置线程</a><ul><li><a href="#调用栈" class="table-of-contents__link">调用栈</a></li><li><a href="#主要的两个函数分析" class="table-of-contents__link">主要的两个函数分析</a></li><li><a href="#rapaassdk" class="table-of-contents__link">RAPaasSDK</a></li><li><a href="#libcxx" class="table-of-contents__link">libcxx</a></li><li><a href="#libpthread" class="table-of-contents__link">libpthread</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.9ca0c92b.js"></script>
<script src="/runtime~main.5bad3ec1.js"></script>
<script src="/main.22d8e8fb.js"></script>
<script src="/1.9cf17d37.js"></script>
<script src="/261.52f5f543.js"></script>
<script src="/262.169b345b.js"></script>
<script src="/935f2afb.f2cfb3e3.js"></script>
<script src="/260.17f75af6.js"></script>
<script src="/32ae96d4.974fb9e2.js"></script>
</body>
</html>