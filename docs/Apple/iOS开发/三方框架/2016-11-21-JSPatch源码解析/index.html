<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Blog Atom Feed"><title data-react-helmet="true">2016-11-21-JSPatch源码解析 | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="2016-11-21-JSPatch源码解析 | My Site"><meta data-react-helmet="true" name="description" content="title: JSPatch源码解析"><meta data-react-helmet="true" property="og:description" content="title: JSPatch源码解析"><meta data-react-helmet="true" property="og:url" content="https://your-docusaurus-test-site.com/docs/Apple/iOS开发/三方框架/2016-11-21-JSPatch源码解析"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://your-docusaurus-test-site.com/docs/Apple/iOS开发/三方框架/2016-11-21-JSPatch源码解析"><link rel="stylesheet" href="/styles.8cfbcdec.css">
<link rel="preload" href="/styles.e736442d.js" as="script">
<link rel="preload" href="/runtime~main.500606b1.js" as="script">
<link rel="preload" href="/main.e34cadf8.js" as="script">
<link rel="preload" href="/1.3353372a.js" as="script">
<link rel="preload" href="/256.3f6603bc.js" as="script">
<link rel="preload" href="/257.427a7301.js" as="script">
<link rel="preload" href="/935f2afb.0ee8c40a.js" as="script">
<link rel="preload" href="/255.24175022.js" as="script">
<link rel="preload" href="/d520deb9.4ba70645.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a><a class="navbar__item navbar__link" href="/docs/编程基础/编程基础/编程基础">编程基础</a><a class="navbar__item navbar__link" href="/docs/编程语言/编程语言">编程语言</a><a class="navbar__item navbar__link" href="/docs/工具/常用工具">工具</a><a class="navbar__item navbar__link" href="/docs/应用开发/应用开发">应用开发</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Apple/iOS开发/iOS开发">Apple</a><a class="navbar__item navbar__link" href="/docs/音视频/音视频">音视频</a><a class="navbar__item navbar__link" href="/docs/项目/项目">项目</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/编程基础/编程基础/编程基础">编程基础</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/编程语言/编程语言">编程语言</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/工具/常用工具">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/应用开发/应用开发">应用开发</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/Apple/iOS开发/iOS开发">Apple</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/音视频">音视频</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/项目/项目">项目</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">2016-11-21-JSPatch源码解析</h1></header><div class="markdown"><p>title: JSPatch源码解析
date: 2016-11-21 10:49:51
categories: [iOS,三方框架]
tags: [JSPatch]
toc: true</p><hr><p>本文一几个demo来串一串JSPatch的实现原理，同时也对OC运行时的消息转发机制进行回顾和温习。</p><p>[toc]</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="基础"></a>基础<a class="hash-link" href="#基础" title="Direct link to heading">#</a></h1><p>解析demo：<a href="https://github.com/DingYusong/JSPatchDemoTutorial" target="_blank" rel="noopener noreferrer">https://github.com/DingYusong/JSPatchDemoTutorial</a></p><p>要从根本上熟练掌握JSPatch ，要了解以下基础知识。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="javascript"></a>JavaScript<a class="hash-link" href="#javascript" title="Direct link to heading">#</a></h2><ul><li><a href="http://es6.ruanyifeng.com/" target="_blank" rel="noopener noreferrer">ECMAScript 6 入门</a></li><li><a href="http://www.liaoxuefeng.com/wiki/001434446689867b27157e896e74d51a89c25cc8b43bdb3000" target="_blank" rel="noopener noreferrer">JavaScript教程</a></li></ul><p>参考文章：</p><ul><li><a href="https://github.com/whihail/JSPatch---comment" target="_blank" rel="noopener noreferrer">JSPatch---comment</a>  </li><li><a href="http://philonpang.github.io/blog/2015/06/26/jspatchxue-xi-yi-ji-iosping-tai-hotfixzai-xian-bu-ding-guan-li-fang-an-shi-xian/" target="_blank" rel="noopener noreferrer">IOS平台Hotfix框架:JSPatch学习笔记及和WaxPatch的集成</a>  </li><li><a href="https://segmentfault.com/a/1190000003870981" target="_blank" rel="noopener noreferrer">JSPatch 实现原理详解 (整改版)</a></li></ul><p>Objective-C Runtime</p><p><a href="http://justsee.iteye.com/blog/2163777" target="_blank" rel="noopener noreferrer">Objective-C Runtime</a></p><p><a href="https://opensource.apple.com/source/objc4/" target="_blank" rel="noopener noreferrer">objc源码</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="c语言基础"></a>C语言基础<a class="hash-link" href="#c语言基础" title="Direct link to heading">#</a></h2><p>指向结构体变量的指针</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">结构指针变量说明的一般形式为:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct 结构名 *结构指针变量名</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">例如，在前面的例题中定义了 stu 这个结构，如要说明一个指向 stu 的指针变量 pstu， 可写为:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct stu *pstu;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct stu {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      int num;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      char *name;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      char sex;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      float score;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } boy1={102,&quot;Zhang ping&quot;,&#x27;M&#x27;,78.5},*pstu;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">第185页</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">main() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pstu=&amp;boy1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    printf(&quot;Number=%d\nName=%s\n&quot;,boy1.num,boy1.name);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    printf(&quot;Sex=%c\nScore=%f\n\n&quot;,boy1.sex,boy1.score);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    printf(&quot;Number=%d\nName=%s\n&quot;,(*pstu).num,(*pstu).name);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    printf(&quot;Sex=%c\nScore=%f\n\n&quot;,(*pstu).sex,(*pstu).score);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    printf(&quot;Number=%d\nName=%s\n&quot;,pstu-&gt;num,pstu-&gt;name);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    printf(&quot;Sex=%c\nScore=%f\n\n&quot;,pstu-&gt;sex,pstu-&gt;score);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>类型定义符typedef</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">C语言不仅提供了丰富的数据类型，而且还允许由用户自己定义类型说明符，也就是说 允许由用户为数据类型取“别名”。类型定义符 typedef 即可用来完成此功能。例如，有整 型量 a,b,其说明如下:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">int a,b;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                       第193页</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">其中 int 是整型变量的类型说明符。int 的完整写法为 integer，为了增加程序的可读性， 可把整型说明符用 typedef 定义为:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    typedef int INTEGER</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">这以后就可用 INTEGER 来代替 int 作整型变量的类型说明了。 例如:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">INTEGER a,b; 它等效于:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">int a,b;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">用 typedef 定义数组、指针、结构等类型将带来很大的方便，不仅使程序书写简单而且</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">使意义更为明确，因而增强了可读性。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">例如:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef char NAME[20]; 表示 NAME 是字符数组类型，数组长度为 20。然后可 用 NAME 说明变量，如:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NAME a1,a2,s1,s2; 完全等效于:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">char a1[20],a2[20],s1[20],s2[20] 又如:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        typedef struct stu</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        { char name[20];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          int age;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          char sex;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">} STU;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">定义 STU 表示 stu 的结构类型，然后可用 STU 来说明结构变量:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">STU body1,body2; typedef 定义的一般形式为:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef 原类型名 新类型名</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">其中原类型名中含有定义部分，新类型名一般用大写表示，以便于区别。 有时也可用宏定义来代替 typedef 的功能，但是宏定义是由预处理完成的，而 typedef</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">则是在编译时完成的，后者更为灵活方便。</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><a href="http://www.cocoachina.com/ios/20141008/9844.html" target="_blank" rel="noopener noreferrer">理解 Objective-C Runtime</a></p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="流程"></a>流程<a class="hash-link" href="#流程" title="Direct link to heading">#</a></h1><p>通过几个简单的demo来梳理一下JSPatch的执行的流程。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="通过jspatch调用oc方法。"></a>通过JSPatch调用OC方法。<a class="hash-link" href="#通过jspatch调用oc方法。" title="Direct link to heading">#</a></h2><p>我们就具体示例来分析。</p><p>在我的demo-1分支，实现了一个通过下发js脚本弹出了一个alertView。</p><p>我们来看看他是如何实现的。</p><p>第一句：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var alertView = require(&#x27;UIAlertView&#x27;).alloc().init();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="require"></a>require<a class="hash-link" href="#require" title="Direct link to heading">#</a></h3><p>先看<code>require(&#x27;UIAlertView&#x27;)</code></p><p>很显然根据JS的语法，require是一个挂载全局下的函数。看一下他的实现。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  var _require = function(clsName) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (!global[clsName]) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      global[clsName] = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __clsName: clsName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return global[clsName]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  global.require = function() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var lastRequire</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (var i = 0; i &lt; arguments.length; i ++) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      arguments[i].split(&#x27;,&#x27;).forEach(function(clsName) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        lastRequire = _require(clsName.trim())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return lastRequire</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><code>require</code>的<code>arguments=[&#x27;UIAlertView&#x27;] </code>  ,调用<code>_require(UIAlertView)</code> 完成后在global对象下挂载了一个<code>UIAlertView</code>的js对象，对象的内容是</p><p><code>require(&#x27;UIAlertView&#x27;)</code>执行完成的时候效果如下：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">global.UIAlertView = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __clsName: UIAlertView</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>那么第一句就变成了：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var alertView = global.UIAlertView.alloc().init();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="调用类方法"></a>调用类方法<a class="hash-link" href="#调用类方法" title="Direct link to heading">#</a></h3><p><code>UIAlertView</code>这个对象JS环境下是没有alloc方法的，显然直接执行是行不通的。</p><p>我满来看一下这段JS代码的执行入口：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [NSURLConnection sendAsynchronousRequest:[NSURLRequest requestWithURL:[NSURL URLWithString:@&quot;http://localhost:3601/demo.js&quot;]] queue:[NSOperationQueue mainQueue] completionHandler:^(NSURLResponse *response, NSData *data, NSError *connectionError) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        NSString *script = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [JPEngine evaluateScript:script];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>进入这个方法<code>[JPEngine evaluateScript:script];</code>发现其实下面这段script</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var alertView = require(&#x27;UIAlertView&#x27;).alloc().init();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">alertView.setTitle(&#x27;Alert&#x27;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">alertView.setMessage(&#x27;AlertView from js&#x27;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">alertView.addButtonWithTitle(&#x27;OK&#x27;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">alertView.show();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>被正则匹配替换成了如下这段代码是一个大的自执行函数：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">;(function(){try{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">var alertView = require(&#x27;UIAlertView&#x27;).__c(&quot;alloc&quot;)().__c(&quot;init&quot;)();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">alertView.__c(&quot;setTitle&quot;)(&#x27;Alert&#x27;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">alertView.__c(&quot;setMessage&quot;)(&#x27;AlertView from js&#x27;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">alertView.__c(&quot;addButtonWithTitle&quot;)(&#x27;OK&#x27;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">alertView.__c(&quot;show&quot;)();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}catch(e){_OC_catch(e.message, e.stack)}})();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>第一句代码其实变成了这样：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var alertView = global.UIAlertView.__c(&quot;alloc&quot;)().__c(&quot;init&quot;)();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>看第一锻函数<code>global.UIAlertView.__c(&quot;alloc&quot;)()</code> 就是<code>__C</code>函数，参数为<code>alloc</code>。很巧妙的点在于将OC方法转换成了一个参数，这是整个JSPatch的核心，此处相当于一个路由中心。</p><p><code>__C</code>函数哪里来的？UIAlert是这样一个对象啊<code>global.UIAlertView = { __clsName: UIAlertView }</code>，哪来的<code>__c</code>函数，别急，是否还记得<code>startEngine </code></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">+ (void)startEngine</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    NSString *path = [[NSBundle bundleForClass:[self class]] pathForResource:@&quot;JSPatch&quot; ofType:@&quot;js&quot;];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (!path) _exceptionBlock(@&quot;can&#x27;t find JSPatch.js&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    NSString *jsCore = [[NSString alloc] initWithData:[[NSFileManager defaultManager] contentsAtPath:path] encoding:NSUTF8StringEncoding];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if ([_context respondsToSelector:@selector(evaluateScript:withSourceURL:)]) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [_context evaluateScript:jsCore withSourceURL:[NSURL URLWithString:@&quot;JSPatch.js&quot;]];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [_context evaluateScript:jsCore];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>先不管前面的一大堆，后面发现他向JSContext里注入了一段JS，由此可见这个<code>__C</code>必定是从这里注入的js环境的。那么查看JSPatch.js,找到如下代码：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-javascript codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> _customMethods </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">__c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">methodName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> slf </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">this</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf </span><span class="token keyword" style="font-style:italic">instanceof</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Boolean</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">methodName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">methodName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">bind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">throw</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;.&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> methodName </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27; is undefined&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__isSuper</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;&amp;</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">_OC_superClsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__realClsName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__realClsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> clsName </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">clsName </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;&amp;</span><span class="token plain"> _ocCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> methodType </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;instMethods&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;clsMethods&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">_ocCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">methodType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">methodName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__isSuper</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> _ocCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">methodType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">methodName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">bind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> args </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Array</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">prototype</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">slice</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">call</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">_methodFunc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> methodName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__isSuper</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">super</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> slf </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">this</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__realClsName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__realClsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">__obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> __clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> __isSuper</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">performSelectorInOC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> slf </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">this</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> args </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Array</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">prototype</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">slice</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">call</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">__isPerformInOC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> sel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> cb</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">performSelector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> slf </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">this</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> args </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Array</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">prototype</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">slice</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">call</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">_methodFunc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">splice</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__isSuper</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> method </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> _customMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">_customMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">hasOwnProperty</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">method</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token known-class-name class-name" style="color:rgb(255, 203, 107)">Object</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">defineProperty</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 107)">Object</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">prototype</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> _customMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">method</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> configurable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> enumerable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>_customMethods  是一个对象包含 <code>__C</code>,<code>super</code>,<code>performSelectorInOC</code>,<code>performSelector</code> 这四个函数属性。</p><p>下面有个for循环对_customMethods对象进行遍历。给基类Object添加<code>__C</code>,<code>super</code>,<code>performSelectorInOC</code>,<code>performSelector</code> 这4个方法。</p><p>而所有的JS类都是继承<code>Object</code>的，所以<code>UIAlertView</code>也能使用<code>__C</code>方法。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var alertView = global.UIAlertView.__c(&quot;alloc&quot;)().__c(&quot;init&quot;)();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>所以到此这句代码就合理了。</p><p>再来看看<code>__C</code>是如何执行的。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-javascript codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">methodName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> slf </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">this</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf </span><span class="token keyword" style="font-style:italic">instanceof</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Boolean</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">methodName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">methodName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">bind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">throw</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;.&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> methodName </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27; is undefined&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__isSuper</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;&amp;</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">_OC_superClsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__realClsName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__realClsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> clsName </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">clsName </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;&amp;</span><span class="token plain"> _ocCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> methodType </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;instMethods&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;clsMethods&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">_ocCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">methodType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">methodName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__isSuper</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> _ocCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">methodType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">methodName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">bind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> args </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Array</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">prototype</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">slice</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">call</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">_methodFunc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__obj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> methodName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> slf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">__isSuper</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>此处的this可以理解为<code>UIAlertView</code> methodName 是alloc。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">global.UIAlertView = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __clsName: UIAlertView</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>而目前来看<code>_ocCls</code> 是个空对象，自然走到了最后一步。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-javascript codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">_methodFunc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword null nil" style="font-style:italic">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token maybe-class-name">UIAlertView</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> alloc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword null nil" style="font-style:italic">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><code>_methodFunc</code>如下：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-javascript codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">_methodFunc</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">instance</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> clsName</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> methodName</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> args</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> isSuper</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> isPerformSelector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> selectorName </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> methodName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">isPerformSelector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      methodName </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> methodName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">replace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token regex">/__/g</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      selectorName </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> methodName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">replace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token regex">/_/g</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;:&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">replace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token regex">/-/g</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;_&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> marchArr </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> selectorName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token regex">/:/g</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> numOfArgs </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> marchArr </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> marchArr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> numOfArgs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        selectorName </span><span class="token operator" style="color:rgb(137, 221, 255)">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;:&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> ret </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> instance </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">_OC_callI</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">instance</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> selectorName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> isSuper</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                         </span><span class="token function" style="color:rgb(130, 170, 255)">_OC_callC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">clsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> selectorName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">_formatOCToJS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">_OC_callC(UIAlertView, alloc, [])</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>这个是引擎里面注入的方法。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    context[@&quot;_OC_callC&quot;] = ^id(NSString *className, NSString *selectorName, JSValue *arguments) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return callSelector(className, selectorName, arguments, nil, NO);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">callSelector(UIAlertView, alloc, [], nil, NO);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>callSelector函数非常长，这个函数涉及到OC的消息传递机制，算是整个JSPatch的OC端的核心了。函数我就不贴在这里，咱们一步一步的分析。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static id callSelector(NSString *className, NSString *selectorName, JSValue *arguments, JSValue *instance, BOOL isSuper)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Class cls = instance ? [instance class] : NSClassFromString(className);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SEL selector = NSSelectorFromString(selectorName);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>cls为UIAlertView  selector为alloc。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        methodSignature = [cls methodSignatureForSelector:selector];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        methodSignature = fixSignature(methodSignature);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (!methodSignature) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            _exceptionBlock([NSString stringWithFormat:@&quot;unrecognized selector %@ for class %@&quot;, selectorName, className]);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return nil;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        invocation= [NSInvocation invocationWithMethodSignature:methodSignature];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [invocation setTarget:cls];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [invocation invoke];</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>1.根据alloc 创建NSMethodSignature 签名对象 methodSignature </p><p>2.根据签名对象methodSignature创建NSInvocation 对象invocation</p><p>3.设置签名对象的target为 UIAlertView。</p><p>4.invoke 执行。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">            void *result;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            [invocation getReturnValue:&amp;result];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            //For performance, ignore the other methods prefix with alloc/new/copy/mutableCopy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if ([selectorName isEqualToString:@&quot;alloc&quot;] || [selectorName isEqualToString:@&quot;new&quot;] ||</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                [selectorName isEqualToString:@&quot;copy&quot;] || [selectorName isEqualToString:@&quot;mutableCopy&quot;]) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                returnValue = (__bridge_transfer id)result;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                returnValue = (__bridge id)result;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return formatOCToJS(returnValue);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static id formatOCToJS(id obj)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if ([obj isKindOfClass:[NSString class]] || [obj isKindOfClass:[NSDictionary class]] || [obj isKindOfClass:[NSArray class]] || [obj isKindOfClass:[NSDate class]]) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return _autoConvert ? obj: _wrapObj([JPBoxing boxObj:obj]);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if ([obj isKindOfClass:[NSNumber class]]) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return _convertOCNumberToString ? [(NSNumber*)obj stringValue] : obj;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if ([obj isKindOfClass:NSClassFromString(@&quot;NSBlock&quot;)] || [obj isKindOfClass:[JSValue class]]) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return obj;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return _wrapObj(obj);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static NSDictionary *_wrapObj(id obj)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (!obj || obj == _nilObj) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return @{@&quot;__isNil&quot;: @(YES)};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return @{@&quot;__obj&quot;: obj, @&quot;__clsName&quot;: NSStringFromClass([obj isKindOfClass:[JPBoxing class]] ? [[((JPBoxing *)obj) unbox] class]: [obj class])};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var ret = instance ? _OC_callI(instance, selectorName, args, isSuper):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                         _OC_callC(clsName, selectorName, args)          //如果instance值为YES，则为实例对象，否则为类对象</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return _formatOCToJS(ret)            //将调用OC方法的返回值转化为js对象 返回</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">obj = {__obj: UIAlertView, __clsName: &quot;UIAlertView&quot;}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>至此，第一个方法 <code>require(&#x27;UIAlertView&#x27;).alloc()</code>流程结束。return一个对象为：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">obj = {__obj: UIAlertView, __clsName: &quot;UIAlertView&quot;}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="调用实例方法"></a>调用实例方法<a class="hash-link" href="#调用实例方法" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="无参数"></a>无参数<a class="hash-link" href="#无参数" title="Direct link to heading">#</a></h4><p>承接上文应该是：<code>obj.init();</code>进一步转为为<code>obj.__c(&quot;init&quot;)()</code></p><p>本次是实例方法。</p><p>应为<code>slf.__obj=UIAlertView</code>所以此次<code>__C</code>函数应该</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">_methodFunc(UIAlertView, &#x27;UIAlertView&#x27;, init, [], null)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>很自然的走到了<code>_OC_callI</code>函数。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">callSelector(nil, init, [], UIAlertView*, null);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static id callSelector(NSString *className, NSString *selectorName, JSValue *arguments, JSValue *instance, BOOL isSuper)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>JSValue的toObject转成对象了。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [_JSMethodSignatureLock lock];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (!_JSMethodSignatureCache[cls]) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            _JSMethodSignatureCache[(id&lt;NSCopying&gt;)cls] = [[NSMutableDictionary alloc]init];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        methodSignature = _JSMethodSignatureCache[cls][selectorName];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (!methodSignature) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            methodSignature = [cls instanceMethodSignatureForSelector:selector];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            methodSignature = fixSignature(methodSignature);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            _JSMethodSignatureCache[cls][selectorName] = methodSignature;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [_JSMethodSignatureLock unlock];</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>实例方法的缓存，下次调用就直接从缓存里面取，不用再生成NSMethodSignature方法签名对象了。</p><p>执行完<code>obj.__c(&quot;init&quot;)()</code> 则alertview变量就变成了。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var alertView = {__obj: UIAlertView, __clsName: &quot;UIAlertView&quot;}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>同样后面的几句也是同样的道理。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">;(function(){try{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">var alertView = require(&#x27;UIAlertView&#x27;).__c(&quot;alloc&quot;)().__c(&quot;init&quot;)();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">alertView.__c(&quot;setTitle&quot;)(&#x27;Alert&#x27;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">alertView.__c(&quot;setMessage&quot;)(&#x27;AlertView from js&#x27;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">alertView.__c(&quot;addButtonWithTitle&quot;)(&#x27;OK&#x27;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">alertView.__c(&quot;show&quot;)();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}catch(e){_OC_catch(e.message, e.stack)}})();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>说一说有区别的点，实例函数传参。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="有参数"></a>有参数<a class="hash-link" href="#有参数" title="Direct link to heading">#</a></h4><p>对settitle</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id argumentsObj = formatJSToOC(arguments);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;__NSArrayM 0x6040004411d0&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Alert</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>这一大块都是设置NSinvocation的参数。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    NSUInteger numberOfArguments = methodSignature.numberOfArguments;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    NSInteger inputArguments = [(NSArray *)argumentsObj count];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (inputArguments &gt; numberOfArguments - 2) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // calling variable argument method, only support parameter type `id` and return type `id`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        id sender = instance != nil ? instance : cls;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        id result = invokeVariableParameterMethod(argumentsObj, methodSignature, sender, selector);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return formatOCToJS(result);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (NSUInteger i = 2; i &lt; numberOfArguments; i++) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        const char *argumentType = [methodSignature getArgumentTypeAtIndex:i];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        id valObj = argumentsObj[i-2];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        switch (argumentType[0] == &#x27;r&#x27; ? argumentType[1] : argumentType[0]) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                #define JP_CALL_ARG_CASE(_typeString, _type, _selector) \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                case _typeString: {                              \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    _type value = [valObj _selector];                     \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    [invocation setArgument:&amp;value atIndex:i];\</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    break; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_CASE(&#x27;c&#x27;, char, charValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_CASE(&#x27;C&#x27;, unsigned char, unsignedCharValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_CASE(&#x27;s&#x27;, short, shortValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_CASE(&#x27;S&#x27;, unsigned short, unsignedShortValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_CASE(&#x27;i&#x27;, int, intValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_CASE(&#x27;I&#x27;, unsigned int, unsignedIntValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_CASE(&#x27;l&#x27;, long, longValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_CASE(&#x27;L&#x27;, unsigned long, unsignedLongValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_CASE(&#x27;q&#x27;, long long, longLongValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_CASE(&#x27;Q&#x27;, unsigned long long, unsignedLongLongValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_CASE(&#x27;f&#x27;, float, floatValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_CASE(&#x27;d&#x27;, double, doubleValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_CASE(&#x27;B&#x27;, BOOL, boolValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            case &#x27;:&#x27;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                SEL value = nil;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (valObj != _nilObj) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    value = NSSelectorFromString(valObj);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                [invocation setArgument:&amp;value atIndex:i];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                break;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            case &#x27;{&#x27;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                NSString *typeString = extractStructName([NSString stringWithUTF8String:argumentType]);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JSValue *val = arguments[i-2];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                #define JP_CALL_ARG_STRUCT(_type, _methodName) \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if ([typeString rangeOfString:@#_type].location != NSNotFound) {    \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    _type value = [val _methodName];  \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    [invocation setArgument:&amp;value atIndex:i];  \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    break; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_STRUCT(CGRect, toRect)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_STRUCT(CGPoint, toPoint)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_STRUCT(CGSize, toSize)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                JP_CALL_ARG_STRUCT(NSRange, toRange)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                @synchronized (_context) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    NSDictionary *structDefine = _registeredStruct[typeString];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    if (structDefine) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        size_t size = sizeOfStructTypes(structDefine[@&quot;types&quot;]);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        void *ret = malloc(size);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        getStructDataWithDict(ret, valObj, structDefine);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        [invocation setArgument:ret atIndex:i];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        free(ret);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        break;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                break;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            case &#x27;*&#x27;:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            case &#x27;^&#x27;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if ([valObj isKindOfClass:[JPBoxing class]]) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    void *value = [((JPBoxing *)valObj) unboxPointer];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    if (argumentType[1] == &#x27;@&#x27;) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        if (!_TMPMemoryPool) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            _TMPMemoryPool = [[NSMutableDictionary alloc] init];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        if (!_markArray) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            _markArray = [[NSMutableArray alloc] init];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        memset(value, 0, sizeof(id));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        [_markArray addObject:valObj];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    [invocation setArgument:&amp;value atIndex:i];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    break;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            case &#x27;#&#x27;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if ([valObj isKindOfClass:[JPBoxing class]]) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    Class value = [((JPBoxing *)valObj) unboxClass];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    [invocation setArgument:&amp;value atIndex:i];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    break;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            default: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (valObj == _nullObj) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    valObj = [NSNull null];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    [invocation setArgument:&amp;valObj atIndex:i];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    break;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (valObj == _nilObj ||</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    ([valObj isKindOfClass:[NSNumber class]] &amp;&amp; strcmp([valObj objCType], &quot;c&quot;) == 0 &amp;&amp; ![valObj boolValue])) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    valObj = nil;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    [invocation setArgument:&amp;valObj atIndex:i];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    break;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if ([(JSValue *)arguments[i-2] hasProperty:@&quot;__isBlock&quot;]) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    JSValue *blkJSVal = arguments[i-2];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    Class JPBlockClass = NSClassFromString(@&quot;JPBlock&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    if (JPBlockClass &amp;&amp; ![blkJSVal[@&quot;blockObj&quot;] isUndefined]) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        __autoreleasing id cb = [JPBlockClass performSelector:@selector(blockWithBlockObj:) withObject:[blkJSVal[@&quot;blockObj&quot;] toObject]];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        [invocation setArgument:&amp;cb atIndex:i];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        __autoreleasing id cb = genCallbackBlock(arguments[i-2]);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        [invocation setArgument:&amp;cb atIndex:i];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    [invocation setArgument:&amp;valObj atIndex:i];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>设置完成之后invoke执行和上面一样。</p><p>获取返回值类型<code>methodReturnType</code></p><p><code>strcpy(returnType, [methodSignature methodReturnType]); </code></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (strncmp(returnType, &quot;v&quot;, 1) != 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    //非空类型</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><a href="http://www.runoob.com/cprogramming/c-function-strncmp.html" target="_blank" rel="noopener noreferrer">http://www.runoob.com/cprogramming/c-function-strncmp.html</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="修改已有方法"></a>修改已有方法<a class="hash-link" href="#修改已有方法" title="Direct link to heading">#</a></h2><ol><li>拿到要修改方法的imp指针。</li><li>拿到要修改方法的参数类型。</li><li>新增一个方法指向原来的方法的imp。（保留旧方法，但是改名了）</li><li>把旧方法的selector指向新的imp实现。（达到修改方法的目的了）</li></ol><p>这几个过程用了很多runtime接口方法。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">当调用一个 NSObject 对象不存在的方法时，并不会马上抛出异常，而是会经过多层转发，层层调用对象的 -resolveInstanceMethod:, -forwardingTargetForSelector:, -methodSignatureForSelector:, -forwardInvocation: 等方法，其中最后 -forwardInvocation: 是会有一个 NSInvocation 对象，这个 NSInvocation 对象保存了这个方法调用的所有信息，包括 Selector 名，参数和返回值类型，最重要的是有所有参数值，可以从这个 NSInvocation 对象里拿到调用的所有参数值。我们可以想办法让每个需要被 JS 替换的方法调用最后都调到 -forwardInvocation:，就可以解决无法拿到参数值的问题了。</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>神来之笔：</p><p>一个特殊的全局IMP：<code>_objc_msgForward</code></p><p>直接通过class_replaceMethod将方法的IMP 替换成 <code>_objc_msgForward</code> 这样调用这个方法时就会走到 <code>-forwardInvocation:</code>。</p><p>最后一个问题，我们把 UIViewController 的 <code>-forwardInvocation:</code> 方法的实现给替换掉了，如果程序里真有用到这个方法对消息进行转发，原来的逻辑怎么办？首先我们在替换 <code>-forwardInvocation:</code> 方法前会新建一个方法 <code>-ORIGforwardInvocation:</code>，保存原来的实现IMP，在新的 <code>-forwardInvocation:</code> 实现里做了个判断，如果转发的方法是我们想改写的，就走我们的逻辑，若不是，就调 <code>-ORIGforwardInvocation:</code> 走原来的流程。</p><p>要看源代码的话请切换到demo-2。demo为修改People的实例方法和类方法的实现。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@interface People : NSObject</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-(void)eat;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">+(NSInteger)handsNumber;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@implementation People</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-(void)eat{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    NSLog(@&quot;eating one time&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">+(NSInteger)handsNumber{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">defineClass(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &#x27;People&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        eat: function () {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            self.ORIGeat();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            console.log(&#x27;eat two times&#x27;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        handsNumber: function () {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return 2;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>未修改之前是这样的：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-07-25 17:54:04.062150+0800 JSPatchDemoTutorial[44808:17595827] People has 1 hand</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-07-25 17:54:04.062330+0800 JSPatchDemoTutorial[44808:17595827] eating one time</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>修改之后是这样的：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-07-25 17:50:04.728957+0800 JSPatchDemoTutorial[44570:17586864] People has 2 hand</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-07-25 17:50:04.731803+0800 JSPatchDemoTutorial[44570:17586864] eating one time</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2018-07-25 17:50:04.732548+0800 JSPatchDemoTutorial[44570:17586864] JSPatch.log: eat two times</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>线面一句一句的来分析。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="修改类方法"></a>修改类方法<a class="hash-link" href="#修改类方法" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">+(NSInteger)handsNumber{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>require就不说了。</p><p>下面看一看defineClass 函数。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  global</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method-variable function-variable method function property-access" style="color:rgb(130, 170, 255)">defineClass</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">declaration</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> properties</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> instMethods</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> clsMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> newInstMethods </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> newClsMethods </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">properties </span><span class="token keyword" style="font-style:italic">instanceof</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Array</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      clsMethods </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> instMethods</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      instMethods </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> properties</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      properties </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword null nil" style="font-style:italic">null</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">forEach</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">instMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          instMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">_propertiesGetFun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> nameOfSet </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;set&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">substr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">toUpperCase</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">substr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">instMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">nameOfSet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          instMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">nameOfSet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">_propertiesSetFun</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> realClsName </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> declaration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">split</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;:&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">trim</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">_formatDefineMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">instMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> newInstMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> realClsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">_formatDefineMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">clsMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> newClsMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> realClsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> ret </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">_OC_defineClass</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">declaration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> newInstMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> newClsMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> className </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> ret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;cls&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> superCls </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> ret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;superCls&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _ocCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">className</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      instMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      clsMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">superCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;&amp;</span><span class="token plain"> _ocCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">superCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> funcName </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> _ocCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">superCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;instMethods&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _ocCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">className</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;instMethods&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">funcName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> _ocCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">superCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;instMethods&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">funcName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> funcName </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> _ocCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">superCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;clsMethods&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _ocCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">className</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;clsMethods&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">funcName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> _ocCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">superCls</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;clsMethods&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">funcName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">_setupJSMethod</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">className</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> instMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> realClsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">_setupJSMethod</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">className</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> clsMethods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> realClsName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">require</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">className</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="修改实例方法"></a>修改实例方法<a class="hash-link" href="#修改实例方法" title="Direct link to heading">#</a></h3><blockquote><p>SPatch 的基本原理就是：JS 传递字符串给 OC，OC 通过 Runtime 接口调用和替换 OC 方法。</p></blockquote><p>我们可以通过类名/方法名反射得到相应的类和方法：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Class class = NSClassFromString(&quot;UIViewController&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">id viewController = [[class alloc] init];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SEL selector = NSSelectorFromString(&quot;viewDidLoad&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[viewController performSelector:selector];</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>也可以替换某个类的方法为新的实现：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static void newViewDidLoad(id slf, SEL sel) {}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class_replaceMethod(class, selector, newViewDidLoad, @&quot;&quot;);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>还可以新注册一个类，为类添加方法：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Class cls = objc_allocateClassPair(superCls, &quot;JPObject&quot;, 0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">objc_registerClassPair(cls);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class_addMethod(cls, selector, implement, typedesc);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="参考文档"></a>参考文档<a class="hash-link" href="#参考文档" title="Direct link to heading">#</a></h1><ul><li><a href="https://segmentfault.com/a/1190000003870981" target="_blank" rel="noopener noreferrer">JSPatch 实现原理详解 (整改版)</a></li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="dys-typora-open://mine/survival/docs/Apple/iOS开发/三方框架/2016-11-21-JSPatch源码解析.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#javascript" class="table-of-contents__link">JavaScript</a></li><li><a href="#c语言基础" class="table-of-contents__link">C语言基础</a></li><li><a href="#通过jspatch调用oc方法。" class="table-of-contents__link">通过JSPatch调用OC方法。</a><ul><li><a href="#require" class="table-of-contents__link">require</a></li><li><a href="#调用类方法" class="table-of-contents__link">调用类方法</a></li><li><a href="#调用实例方法" class="table-of-contents__link">调用实例方法</a></li></ul></li><li><a href="#修改已有方法" class="table-of-contents__link">修改已有方法</a><ul><li><a href="#修改类方法" class="table-of-contents__link">修改类方法</a></li><li><a href="#修改实例方法" class="table-of-contents__link">修改实例方法</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.e736442d.js"></script>
<script src="/runtime~main.500606b1.js"></script>
<script src="/main.e34cadf8.js"></script>
<script src="/1.3353372a.js"></script>
<script src="/256.3f6603bc.js"></script>
<script src="/257.427a7301.js"></script>
<script src="/935f2afb.0ee8c40a.js"></script>
<script src="/255.24175022.js"></script>
<script src="/d520deb9.4ba70645.js"></script>
</body>
</html>