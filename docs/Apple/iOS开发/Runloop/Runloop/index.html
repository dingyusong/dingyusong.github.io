<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Blog Atom Feed"><title data-react-helmet="true">Runloop | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Runloop | My Site"><meta data-react-helmet="true" name="description" content="Runloop"><meta data-react-helmet="true" property="og:description" content="Runloop"><meta data-react-helmet="true" property="og:url" content="http://localhost:9999//docs/Apple/iOS开发/Runloop/Runloop"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://localhost:9999//docs/Apple/iOS开发/Runloop/Runloop"><link rel="stylesheet" href="/styles.8cfbcdec.css">
<link rel="preload" href="/styles.9f2bd08d.js" as="script">
<link rel="preload" href="/runtime~main.b9916a1e.js" as="script">
<link rel="preload" href="/main.aad198f0.js" as="script">
<link rel="preload" href="/1.c6142e7c.js" as="script">
<link rel="preload" href="/259.bd219e04.js" as="script">
<link rel="preload" href="/260.8c75c7b8.js" as="script">
<link rel="preload" href="/935f2afb.b83995d3.js" as="script">
<link rel="preload" href="/258.77a3145c.js" as="script">
<link rel="preload" href="/94f04a0e.a5922850.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a><a class="navbar__item navbar__link" href="/docs/">基础</a><a class="navbar__item navbar__link" href="/docs/编程语言/编程语言">语言</a><a class="navbar__item navbar__link" href="/docs/工具/常用工具">工具</a><a class="navbar__item navbar__link" href="/docs/应用开发/应用开发">应用开发</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Apple/iOS开发/iOS开发">Apple</a><a class="navbar__item navbar__link" href="/docs/音视频/音视频">音视频</a><a class="navbar__item navbar__link" href="/docs/项目/项目">项目</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">基础</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/编程语言/编程语言">语言</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/工具/常用工具">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/应用开发/应用开发">应用开发</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/Apple/iOS开发/iOS开发">Apple</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/音视频">音视频</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/项目/项目">项目</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Runloop</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="runloop"></a>Runloop<a class="hash-link" href="#runloop" title="Direct link to heading">#</a></h1><p>[toc]</p><p>顾名思义
运行循环
在程序运行过程中循环做一些事情</p><p><img alt="image-20211012215632058" src="/assets/images/image-20211012215632058-9fb55dca100bcd3ac3ad0fe9b39107be.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="应用范畴"></a>应用范畴<a class="hash-link" href="#应用范畴" title="Direct link to heading">#</a></h2><p>定时器（Timer）、PerformSelector
GCD Async Main Queue
事件响应、手势识别、界面刷新
网络请求
AutoreleasePool</p><p>没有Runloop执行完13行代码就退出了</p><p><img alt="image-20211012215614478" src="/assets/images/image-20211012215614478-d8f6b041d88f20afedbea49f29da3d1a.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="runloop的基本作用"></a>RunLoop的基本作用<a class="hash-link" href="#runloop的基本作用" title="Direct link to heading">#</a></h2><p>保持程序的持续运行
处理App中的各种事件（比如触摸事件、定时器事件等）
节省CPU资源，提高程序性能：该做事时做事，该休息时休息
......</p><p><img alt="image-20211012215825840" src="/assets/images/image-20211012215825840-6be2f01c812bd099dec8c0418a323864.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="nsrunloop对象"></a>NSRunLoop对象<a class="hash-link" href="#nsrunloop对象" title="Direct link to heading">#</a></h2><p>iOS中有2套API来访问和使用RunLoop
Foundation：NSRunLoop</p><p>Core Foundation：CFRunLoopRef</p><p>NSRunLoop和CFRunLoopRef都代表着RunLoop对象
NSRunLoop是基于CFRunLoopRef的一层OC包装
CFRunLoopRef是开源的
<a href="https://opensource.apple.com/tarballs/CF/" target="_blank" rel="noopener noreferrer">https://opensource.apple.com/tarballs/CF/</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="runloop与线程"></a>Runloop与线程<a class="hash-link" href="#runloop与线程" title="Direct link to heading">#</a></h2><p>每条线程都有唯一的一个与之对应的RunLoop对象</p><p>RunLoop保存在一个全局的Dictionary里，线程作为key，RunLoop作为value</p><p>线程刚创建时并没有RunLoop对象，RunLoop会在第一次获取它时创建</p><p>RunLoop会在线程结束时销毁</p><ul><li>主线程的RunLoop已经自动获取（创建），子线程默认没有开启RunLoop。<ul><li>因为子线程没有必要开启Runloop，大部分情况下是一个任务执行完成就退出了。需要保活的，可以开启Runloop。</li></ul></li></ul><p>​	</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="获取runloop对象"></a>获取Runloop对象<a class="hash-link" href="#获取runloop对象" title="Direct link to heading">#</a></h2><p>Foundation
[NSRunLoop currentRunLoop]; // 获得当前线程的RunLoop对象
[NSRunLoop mainRunLoop]; // 获得主线程的RunLoop对象</p><p>Core Foundation
CFRunLoopGetCurrent(); // 获得当前线程的RunLoop对象
CFRunLoopGetMain(); // 获得主线程的RunLoop对象</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="runloop相关的类"></a>RunLoop相关的类<a class="hash-link" href="#runloop相关的类" title="Direct link to heading">#</a></h2><p>Core Foundation中关于RunLoop的5个类
CFRunLoopRef
CFRunLoopModeRef
CFRunLoopSourceRef
CFRunLoopTimerRef
CFRunLoopObserverRef</p><p><img alt="image-20211012220131581" src="/assets/images/image-20211012220131581-31733f83dac8bba7f1f78b71b4308134.png"></p><p><img alt="image-20211012220141130" src="/assets/images/image-20211012220141130-9d89e698a251e82f289abb7e2c349fd1.png"></p><p><img alt="image-20211012220156017" src="/assets/images/image-20211012220156017-2336b4f28d30d0f309681fd35ea634bd.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="cfrunloopmoderef"></a>CFRunLoopModeRef<a class="hash-link" href="#cfrunloopmoderef" title="Direct link to heading">#</a></h2><p>CFRunLoopModeRef代表RunLoop的运行模式</p><p>一个RunLoop包含若干个Mode，每个Mode又包含若干个Source0/Source1/Timer/Observer</p><p>RunLoop启动时只能选择其中一个Mode，作为currentMode</p><p>如果需要切换Mode，只能退出当前Loop，再重新选择一个Mode进入
不同组的Source0/Source1/Timer/Observer能分隔开来，互不影响</p><p>如果Mode里没有任何Source0/Source1/Timer/Observer，RunLoop会立马退出</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="常见的2种mode"></a>常见的2种Mode<a class="hash-link" href="#常见的2种mode" title="Direct link to heading">#</a></h3><p>kCFRunLoopDefaultMode（NSDefaultRunLoopMode）：App的默认Mode，通常主线程是在这个Mode下运行</p><p>UITrackingRunLoopMode：界面跟踪 Mode，用于 ScrollView 追踪触摸滑动，保证界面滑动时不受其他 Mode 影响</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="cfrunloopobserverref"></a>CFRunLoopObserverRef<a class="hash-link" href="#cfrunloopobserverref" title="Direct link to heading">#</a></h2><p><img alt="image-20211012220329834" src="/assets/images/image-20211012220329834-35b0deb2b89eeb251903f43296b5a362.png"></p><p><img alt="image-20211012220404532" src="/assets/images/image-20211012220404532-9a6b98c4e8521c183eb371e16549de2a.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="runloop的运行逻辑"></a>RunLoop的运行逻辑<a class="hash-link" href="#runloop的运行逻辑" title="Direct link to heading">#</a></h2><ul><li><p>Source0
触摸事件处理
performSelector:onThread:</p></li><li><p>Source1
基于Port的线程间通信
系统事件捕捉</p></li><li><p>Timers
NSTimer
performSelector:withObject:afterDelay:</p></li><li><p>Observers
用于监听RunLoop的状态
UI刷新（BeforeWaiting）
Autorelease pool（BeforeWaiting）</p></li></ul><p>01、通知Observers：进入Loop
02、通知Observers：即将处理Timers
03、通知Observers：即将处理Sources
04、处理Blocks
05、处理Source0（可能会再次处理Blocks）
06、如果存在Source1，就跳转到第8步
07、通知Observers：开始休眠（等待消息唤醒）
08、通知Observers：结束休眠（被某个消息唤醒）
01&gt; 处理Timer
02&gt; 处理GCD Async To Main Queue
03&gt; 处理Source1
09、处理Blocks
10、根据前面的执行结果，决定如何操作
01&gt; 回到第02步
02&gt; 退出Loop
11、通知Observers：退出Loop</p><p><img alt="image-20211012220604739" src="/assets/images/image-20211012220604739-5d0b938111391c53621edd42096c1e00.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="runloop休眠的实现原理"></a>RunLoop休眠的实现原理<a class="hash-link" href="#runloop休眠的实现原理" title="Direct link to heading">#</a></h2><p><img alt="image-20211012220631434" src="/assets/images/image-20211012220631434-c13195538dde2f3dfc7ced1324959605.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="runloop在实际开中的应用"></a>RunLoop在实际开中的应用<a class="hash-link" href="#runloop在实际开中的应用" title="Direct link to heading">#</a></h2><p>控制线程生命周期（线程保活）</p><p>解决NSTimer在滑动时停止工作的问题</p><p>监控应用卡顿</p><p>性能优化</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="runloop案例分析"></a>Runloop案例分析<a class="hash-link" href="#runloop案例分析" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="案例分析1：nstimer"></a>案例分析1：NSTimer<a class="hash-link" href="#案例分析1：nstimer" title="Direct link to heading">#</a></h3><p><img alt="image-20211011105425050" src="/assets/images/image-20211011105425050-57767b359c0c7aca17e1856c94fcc91a.png"></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(lldb) bt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">* thread #1, queue = &#x27;com.apple.main-thread&#x27;, stop reason = breakpoint 1.1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * frame #0: 0x000000010f9623e0 Interview03-RunLoop`__41-[ViewController touchesBegan:withEvent:]_block_invoke(.block_descriptor=0x000000010f964108, timer=0x0000600000d412c0) at ViewController.m:130:9</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #1: 0x00007fff20844188 Foundation`__NSFireTimer + 67</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #2: 0x00007fff2036a6c6 CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ + 20</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #3: 0x00007fff2036a1c2 CoreFoundation`__CFRunLoopDoTimer + 923</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #4: 0x00007fff20369781 CoreFoundation`__CFRunLoopDoTimers + 265</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #5: 0x00007fff20363dc0 CoreFoundation`__CFRunLoopRun + 2010</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #6: 0x00007fff20363103 CoreFoundation`CFRunLoopRunSpecific + 567</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #7: 0x00007fff2c851cd3 GraphicsServices`GSEventRunModal + 139</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #8: 0x00007fff24ffbe63 UIKitCore`-[UIApplication _run] + 928</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #9: 0x00007fff25000a53 UIKitCore`UIApplicationMain + 101</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #10: 0x000000010f962468 Interview03-RunLoop`main(argc=1, argv=0x00007ffee029dc10) at main.m:14:16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #11: 0x000000010f971e1e dyld_sim`start_sim + 10</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(lldb) </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="案例分析2：socket通信"></a>案例分析2：Socket通信<a class="hash-link" href="#案例分析2：socket通信" title="Direct link to heading">#</a></h3><p><img alt="image-20211011105715533" src="/assets/images/image-20211011105715533-0f29a8b69702f8e0b735bf1c39cbc565.png"></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(lldb) bt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">* thread #1, queue = &#x27;com.apple.main-thread&#x27;, stop reason = breakpoint 15.1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * frame #0: 0x000000010184c100 macdemo2`-[RZLimitSpeedUploadHelper stream:handleEvent:](self=0x000060000254b1e0, _cmd=&quot;stream:handleEvent:&quot;, stream=0x0000600003356f40, eventCode=NSStreamEventHasSpaceAvailable) at RZLimitSpeedUploadHelper.m:137:35</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #1: 0x00007fff204d1005 CoreFoundation`_signalEventSync + 219</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #2: 0x00007fff204d0f02 CoreFoundation`_cfstream_solo_signalEventSync + 266</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #3: 0x00007fff204d0dba CoreFoundation`_CFStreamSignalEvent + 454</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #4: 0x00007fff2479f46b CFNetwork`___lldb_unnamed_symbol1857$$CFNetwork + 213</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #5: 0x00007fff204d0a4b CoreFoundation`__CFSocketPerformV0 + 1018</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #6: 0x00007fff204a82bc CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + 17</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #7: 0x00007fff204a8224 CoreFoundation`__CFRunLoopDoSource0 + 180</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #8: 0x00007fff204a7fa4 CoreFoundation`__CFRunLoopDoSources0 + 242</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #9: 0x00007fff204a69cc CoreFoundation`__CFRunLoopRun + 893</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #10: 0x00007fff204a5f8c CoreFoundation`CFRunLoopRunSpecific + 563</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #11: 0x00007fff286ee1f3 HIToolbox`RunCurrentEventLoopInMode + 292</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #12: 0x00007fff286edf55 HIToolbox`ReceiveNextEventCommon + 587</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #13: 0x00007fff286edcf3 HIToolbox`_BlockUntilNextEventMatchingListInModeWithFilter + 70</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #14: 0x00007fff22caf172 AppKit`_DPSNextEvent + 864</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #15: 0x00007fff22cad945 AppKit`-[NSApplication(NSEvent) _nextEventMatchingEventMask:untilDate:inMode:dequeue:] + 1364</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="案例分析3：子线程执行任务"></a>案例分析3：子线程执行任务<a class="hash-link" href="#案例分析3：子线程执行任务" title="Direct link to heading">#</a></h3><p><img alt="image-20211011105954041" src="/assets/images/image-20211011105954041-547a6371ae423b9fba716ae5ebce5de2.png"></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(lldb) bt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">* thread #9, stop reason = breakpoint 1.1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * frame #0: 0x000000010e88a174 Interview03-线程保活`__41-[ViewController touchesBegan:withEvent:]_block_invoke(.block_descriptor=0x0000600002952e20) at ViewController.m:32:43</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #1: 0x000000010e889f56 Interview03-线程保活`-[MJPermenantThread __executeTask:](self=0x0000600002525380, _cmd=&quot;__executeTask:&quot;, task=0x000000010e88a160) at MJPermenantThread.m:99:5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #2: 0x00007fff2084258c Foundation`__NSThreadPerformPerform + 207</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #3: 0x00007fff20369e25 CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + 17</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #4: 0x00007fff20369d1d CoreFoundation`__CFRunLoopDoSource0 + 180</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #5: 0x00007fff203691f2 CoreFoundation`__CFRunLoopDoSources0 + 242</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #6: 0x00007fff20363951 CoreFoundation`__CFRunLoopRun + 875</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #7: 0x00007fff20363103 CoreFoundation`CFRunLoopRunSpecific + 567</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #8: 0x000000010e889c69 Interview03-线程保活`__25-[MJPermenantThread init]_block_invoke(.block_descriptor=0x000000010e88c0f8) at MJPermenantThread.m:47:13</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #9: 0x00007fff20842142 Foundation`__NSThread__start__ + 999</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #10: 0x00007fff6bfee8fc libsystem_pthread.dylib`_pthread_start + 224</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #11: 0x00007fff6bfea443 libsystem_pthread.dylib`thread_start + 15</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(lldb) </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="案例分析4：监听observer"></a>案例分析4：监听Observer<a class="hash-link" href="#案例分析4：监听observer" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(lldb) bt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">* thread #1, queue = &#x27;com.apple.main-thread&#x27;, stop reason = breakpoint 3.1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * frame #0: 0x000000010b4f626c Interview03-RunLoop`__29-[ViewController viewDidLoad]_block_invoke(.block_descriptor=0x000000010b4f80c8, observer=0x00006000002d03c0, activity=kCFRunLoopEntry) at ViewController.m:100:48</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #1: 0x00007fff20368c77 CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__ + 23</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #2: 0x00007fff2036349c CoreFoundation`__CFRunLoopDoObservers + 541</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #3: 0x00007fff2036308a CoreFoundation`CFRunLoopRunSpecific + 446</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #4: 0x00007fff2c851cd3 GraphicsServices`GSEventRunModal + 139</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #5: 0x00007fff24ffbe63 UIKitCore`-[UIApplication _run] + 928</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #6: 0x00007fff25000a53 UIKitCore`UIApplicationMain + 101</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #7: 0x000000010b4f6468 Interview03-RunLoop`main(argc=1, argv=0x00007ffee4709c10) at main.m:14:16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #8: 0x000000010b505e1e dyld_sim`start_sim + 10</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(lldb) </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="runloop调用栈"></a>Runloop调用栈<a class="hash-link" href="#runloop调用栈" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #3: 0x00007fff20369e25 CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + 17</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #4: 0x00007fff20369d1d CoreFoundation`__CFRunLoopDoSource0 + 180</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #5: 0x00007fff203691f2 CoreFoundation`__CFRunLoopDoSources0 + 242</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #6: 0x00007fff20363951 CoreFoundation`__CFRunLoopRun + 875</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #7: 0x00007fff20363103 CoreFoundation`CFRunLoopRunSpecific + 567</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #2: 0x00007fff2036a6c6 CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ + 20</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #3: 0x00007fff2036a1c2 CoreFoundation`__CFRunLoopDoTimer + 923</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #4: 0x00007fff20369781 CoreFoundation`__CFRunLoopDoTimers + 265</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #5: 0x00007fff20363dc0 CoreFoundation`__CFRunLoopRun + 2010</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #6: 0x00007fff20363103 CoreFoundation`CFRunLoopRunSpecific + 567</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #1: 0x00007fff20368c77 CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__ + 23</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #2: 0x00007fff2036349c CoreFoundation`__CFRunLoopDoObservers + 541</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #3: 0x00007fff2036308a CoreFoundation`CFRunLoopRunSpecific + 446</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="source1"></a>Source1<a class="hash-link" href="#source1" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(lldb) b __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Breakpoint 9: where = CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__, address = 0x00007fff2036a6c8</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">(lldb) bt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">* thread #1, queue = &#x27;com.apple.main-thread&#x27;, stop reason = breakpoint 9.1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  * frame #0: 0x00007fff2036a6c8 CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #1: 0x00007fff20369abe CoreFoundation`__CFRunLoopDoSource1 + 607</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #2: 0x00007fff20363ff8 CoreFoundation`__CFRunLoopRun + 2578</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #3: 0x00007fff20363103 CoreFoundation`CFRunLoopRunSpecific + 567</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #4: 0x00007fff2c851cd3 GraphicsServices`GSEventRunModal + 139</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #5: 0x00007fff24ffbe63 UIKitCore`-[UIApplication _run] + 928</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #6: 0x00007fff25000a53 UIKitCore`UIApplicationMain + 101</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #7: 0x0000000104b383f8 Interview03-RunLoop`main(argc=1, argv=0x00007ffeeb0c7c10) at main.m:14:16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    frame #8: 0x0000000104b47e1e dyld_sim`start_sim + 10</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(lldb) </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">2021-10-11 14:18:49.837749+0800 Interview03-RunLoop[43991:1876885] kCFRunLoopBeforeTimers - kCFRunLoopDefaultMode</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2021-10-11 14:18:49.838001+0800 Interview03-RunLoop[43991:1876885] kCFRunLoopBeforeSources - kCFRunLoopDefaultMode</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2021-10-11 14:18:49.838190+0800 Interview03-RunLoop[43991:1876885] kCFRunLoopBeforeWaiting - kCFRunLoopDefaultMode</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2021-10-11 14:18:49.859221+0800 Interview03-RunLoop[43991:1876885] kCFRunLoopAfterWaiting - kCFRunLoopDefaultMode</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(lldb) </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><img alt="image-20211011141930666" src="/assets/images/image-20211011141930666-478ee638f9439f70a850da18055a8c08.png"></p><p>Call Out</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    static void __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    static void __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    static void __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    static void __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    static void __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    static void __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><a href="https://www.cnblogs.com/kenshincui/p/6823841.html" target="_blank" rel="noopener noreferrer">iOS刨根问底-深入理解RunLoop</a></p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="autoreleasepool"></a>autoreleasepool<a class="hash-link" href="#autoreleasepool" title="Direct link to heading">#</a></h1><p><a href="https://draveness.me/autoreleasepool" target="_blank" rel="noopener noreferrer">https://draveness.me/autoreleasepool</a></p><p>参考文档</p><ul><li><a href="https://draveness.me/autoreleasepool" target="_blank" rel="noopener noreferrer">自动释放池的前世今生 ---- 深入解析 autoreleasepool</a></li></ul><p>autoreleasepool 以一个队列数组的形式实现,主要通过下列三个函数完成.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">1. `objc_autoreleasepoolPush`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2. `objc_autoreleasepoolPop`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3. `objc_autorelease`</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>看函数名就可以知道，对 autorelease 分别执行 push，和 pop 操作。销毁对象时执行release操作。</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="dys-typora-open://mine/survival/docs/Apple/iOS开发/Runloop/Runloop.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#应用范畴" class="table-of-contents__link">应用范畴</a></li><li><a href="#runloop的基本作用" class="table-of-contents__link">RunLoop的基本作用</a></li><li><a href="#nsrunloop对象" class="table-of-contents__link">NSRunLoop对象</a></li><li><a href="#runloop与线程" class="table-of-contents__link">Runloop与线程</a></li><li><a href="#获取runloop对象" class="table-of-contents__link">获取Runloop对象</a></li><li><a href="#runloop相关的类" class="table-of-contents__link">RunLoop相关的类</a></li><li><a href="#cfrunloopmoderef" class="table-of-contents__link">CFRunLoopModeRef</a><ul><li><a href="#常见的2种mode" class="table-of-contents__link">常见的2种Mode</a></li></ul></li><li><a href="#cfrunloopobserverref" class="table-of-contents__link">CFRunLoopObserverRef</a></li><li><a href="#runloop的运行逻辑" class="table-of-contents__link">RunLoop的运行逻辑</a></li><li><a href="#runloop休眠的实现原理" class="table-of-contents__link">RunLoop休眠的实现原理</a></li><li><a href="#runloop在实际开中的应用" class="table-of-contents__link">RunLoop在实际开中的应用</a></li><li><a href="#runloop案例分析" class="table-of-contents__link">Runloop案例分析</a><ul><li><a href="#案例分析1：nstimer" class="table-of-contents__link">案例分析1：NSTimer</a></li><li><a href="#案例分析2：socket通信" class="table-of-contents__link">案例分析2：Socket通信</a></li><li><a href="#案例分析3：子线程执行任务" class="table-of-contents__link">案例分析3：子线程执行任务</a></li><li><a href="#案例分析4：监听observer" class="table-of-contents__link">案例分析4：监听Observer</a></li><li><a href="#runloop调用栈" class="table-of-contents__link">Runloop调用栈</a></li><li><a href="#source1" class="table-of-contents__link">Source1</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.9f2bd08d.js"></script>
<script src="/runtime~main.b9916a1e.js"></script>
<script src="/main.aad198f0.js"></script>
<script src="/1.c6142e7c.js"></script>
<script src="/259.bd219e04.js"></script>
<script src="/260.8c75c7b8.js"></script>
<script src="/935f2afb.b83995d3.js"></script>
<script src="/258.77a3145c.js"></script>
<script src="/94f04a0e.a5922850.js"></script>
</body>
</html>