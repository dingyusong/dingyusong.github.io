<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Blog Atom Feed"><title data-react-helmet="true">内存管理 | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="内存管理 | My Site"><meta data-react-helmet="true" name="description" content="内存管理"><meta data-react-helmet="true" property="og:description" content="内存管理"><meta data-react-helmet="true" property="og:url" content="http://localhost:9999//docs/编程语言/Objective-C/内存管理"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://localhost:9999//docs/编程语言/Objective-C/内存管理"><link rel="stylesheet" href="/styles.8cfbcdec.css">
<link rel="preload" href="/styles.aaa24a49.js" as="script">
<link rel="preload" href="/runtime~main.7eeb3d64.js" as="script">
<link rel="preload" href="/main.7a041c89.js" as="script">
<link rel="preload" href="/1.62b3ea65.js" as="script">
<link rel="preload" href="/257.bb7ed37e.js" as="script">
<link rel="preload" href="/258.ed1b30f8.js" as="script">
<link rel="preload" href="/935f2afb.55f5968c.js" as="script">
<link rel="preload" href="/256.a7530d90.js" as="script">
<link rel="preload" href="/0f221bb7.70518217.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a><a class="navbar__item navbar__link" href="/docs/">编程基础</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/编程语言/编程语言">编程语言</a><a class="navbar__item navbar__link" href="/docs/工具/常用工具">工具</a><a class="navbar__item navbar__link" href="/docs/应用开发/应用开发">应用开发</a><a class="navbar__item navbar__link" href="/docs/Apple/iOS开发/iOS开发">Apple</a><a class="navbar__item navbar__link" href="/docs/音视频/音视频">音视频</a><a class="navbar__item navbar__link" href="/docs/项目/项目">项目</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">编程基础</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/编程语言/编程语言">编程语言</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/工具/常用工具">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/应用开发/应用开发">应用开发</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/iOS开发/iOS开发">Apple</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/音视频">音视频</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/项目/项目">项目</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">内存管理</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="内存管理"></a>内存管理<a class="hash-link" href="#内存管理" title="Direct link to heading">#</a></h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="属性的内存管理语义"></a>属性的内存管理语义<a class="hash-link" href="#属性的内存管理语义" title="Direct link to heading">#</a></h2><p>内存管理</p><p>而我们使用copy,strong,retain,weak,assign区别就在：</p><p><strong>1.是否开辟新的内存</strong>
<strong>2.是否对地址C有引用计数增加</strong></p><p>1.是否开辟新的内存</p><p>开辟：</p><p>copy</p><p>可变类型对其赋值时。</p><p>2.是否对原对象地址有引用计数增加</p><p>copy：</p><p>可变类型对其赋值时。不增加。</p><p>不可变类型赋值时，增加，相当于retain。</p><p><strong>我们称会对数据地址增加引用计数的为强引用，不改变引用计数的为弱引用</strong></p><p><a href="https://github.com/DingYusong/MemoryManagementDemo" target="_blank" rel="noopener noreferrer">https://github.com/DingYusong/MemoryManagementDemo</a></p><ul><li>copy</li></ul><p>是否开辟新的内存？
可变类型对其赋值时。开辟新的内存。指针指向新的内存区域。（得到的是不可变类型）
不可变类型赋值时。不开辟。相当于retain。</p><p>是否对对象内存地址有引用计数增加？
可变类型对其赋值时。不增加。（因为直接开辟了新的内存）
不可变类型赋值时。增加。相当于retain。（没有开辟新的内存）</p><p>此属性只对那些实行了NSCopying协议的对象类型有效。</p><p>copy与mutableCopy：
copy修饰符，相当于strong+copy。
copy的结果是得到一个不可变对象。
mutableCopy的结果是得到一个可变对象。</p><p>参考： <a href="https://www.zybuluo.com/MicroCai/note/50592" target="_blank" rel="noopener noreferrer">iOS 集合的深复制与浅复制</a></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objectivec codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">@property</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">nonatomic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> copy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> NSString </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">@property</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">nonatomic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> strong</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> NSString </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">name1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    NSMutableString </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">string </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">NSMutableString stringWithString</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token string" style="color:rgb(195, 232, 141)">@&quot;origin&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">self</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//等价于</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">self</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">name1 </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">string copy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ul><li>strong</li></ul><p>是否开辟新的内存？
不会</p><p>是否对对象内存地址有引用计数增加？
增加</p><ul><li>retain</li></ul><p>是否开辟新的内存？
不会</p><p>是否对对象内存地址有引用计数增加？
增加</p><p>什么情况下使用？
在出现循环引用的时候，一般用weak。因为强循环引用不做外力处理(比如强制将某个引用置为nil)的话，引用计数不会归零，对象不会释放，会导致内存泄漏。</p><ul><li>weak</li></ul><p>特性：</p><ol><li>不会开辟新的内存</li><li>属性所指对象不会有引用计数增加</li><li>属性所指的对象遭到摧毁时，属性值也会清空,自动置为nil。（如果用assign修饰，则不会自动置为nil，自动置为nil这个特性可以防止野指针出现，给nil发消息不会crash，给野指针发消息会crash。对于对象类型来说，使用weak比使用assign安全，所以一般指向对象的属性不用assign修饰）</li></ol><p>什么情况下使用？
在出现循环引用的时候，一般用weak。因为强循环引用不做外力处理(比如强制将某个引用置为nil)的话，引用计数不会归零，对象不会释放，会导致内存泄漏。</p><ul><li>assign</li></ul><p>特性：</p><ol><li>不会开辟新的内存</li><li>属性所指如果是对象则对象不会有引用计数增加。</li><li>assign修饰的属性一般用来指向基本数据类型，注意：指向对象的话不会自动置为nil！</li></ol><p>对于纯量（scalar type）数据类型或者叫基本数据类型，不存在引用计数一说。这点和OC对象的ARC机制有很大的差别。对一个基本数据类型的属性进行赋值，则直接修改了对应栈地址的内容。而对一个OC对象的属性赋值，则是将对象的堆地址给到对应栈空间。栈空间随着程序的消亡而消亡。（请补一补程序运行的内存结构）ARC一般是对堆区的处理。参考：<a href="https://blog.csdn.net/u013480070/article/details/100154725" target="_blank" rel="noopener noreferrer">iOS程序的内存布局</a></p><blockquote><p><a href="https://www.cnblogs.com/wskb/p/10970761.html" target="_blank" rel="noopener noreferrer">基本数据类型和对象的区别</a>
(1) 基本数据类型的存储原理：所有的简单数据类型不存在“引用”的概念，基本数据类型都是直接存储在内存中的栈上的，数据本身的值就是存储在栈空间里面，Java语言里面八种数据类型是这种存储模型；
(2) 引用类型的存储原理：引用类型继承于Object类（也是引用类型）都是按照Java里面存储对象的内存模型来进行数据存储的，使用Java堆和栈来进行这种类型的数据存储，简单地讲，“<strong>引用</strong>”(存储对象在内存堆上的地址)是<strong>存储在有序的栈上</strong>的，而<strong>对象本身的值存储在堆上</strong>的；
<strong>不论是基本数据类型还是引用类型，他们都会先在栈中分配一块内存，对于基本类型来说，这块区域包含的是基本类型的内容；而对于引用类型来说，这块区域包含的是指向真正内容的指针，真正的内容被手动的分配在堆上。</strong></p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="从内存管理角度去理解nsstring"></a>从内存管理角度去理解NSString<a class="hash-link" href="#从内存管理角度去理解nsstring" title="Direct link to heading">#</a></h2><p><a href="http://www.infoq.com/cn/articles/deep-understanding-of-tagged-pointer/" target="_blank" rel="noopener noreferrer">深入理解Tagged Pointer</a></p><p><a href="http://www.cocoachina.com/ios/20150918/13449.html" target="_blank" rel="noopener noreferrer">【译】采用Tagged Pointer的字符串</a></p><h2></h2><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="block的内存管理"></a>Block的内存管理<a class="hash-link" href="#block的内存管理" title="Direct link to heading">#</a></h2><ol><li>Block默认创建在栈上。</li><li>block捕获局部变量则会复制到堆上（这会表现在对强引用对象的引用计数加2）。block捕获全局变量则还在栈中。默认可以改变全局变量，默认不能改变局部变量。</li><li>栈上跟随宿主生命周期，堆上有自己的生命周期。</li><li>Block和self循环引用解决。根本原则：打破强循环引用，将引用计数降为0。</li></ol><p><a href="https://www.jianshu.com/p/9e2c36482cc2" target="_blank" rel="noopener noreferrer">简述@weakify、@strongify</a></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">1. id weak weakSelf = self;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   或者 weak __typeof(&amp;*self)weakSelf = self该方法可以设置宏</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2. id __block weakSelf = self;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>或者将其中一方强制制空 <code>xxx = nil</code>。</p><p>检测代码中是否存在循环引用问题，可使用 Facebook 开源的一个检测工具  <a href="https://github.com/facebook/FBRetainCycleDetector" target="_blank" rel="noopener noreferrer"><strong><em>FBRetainCycleDetector</em></strong></a> 。</p><p>代码块本质上是和其他变量类似，可以看做是一个对象，可以赋值，传递，拷贝等。不同的是，代码块存储的数据是一个函数体，所以他也可以看做是函数。使用代码块是，你可以像调用其他标准函数一样，传入参数数，并得到返回值。</p><p>脱字符（^）是块的语法标记。按照我们熟悉的参数语法规约所定义的返回值以及块的主体（也就是可以执行的代码）。</p><p><img src="http://wiso.liwenhui520.com/20191127157482264218740.png" alt="20191127157482264218740.png"></p><p>按照调用函数的方式调用块对象变量就可以了：</p><p>int result = myBlock(4); // result是 28</p><p> <strong>、代码用在字符串数组排序</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"> NSArray *stringArray = [NSArray arrayWithObjects:@&quot;abc 1&quot;, @&quot;abc 21&quot;, @&quot;abc 12&quot;,@&quot;abc 13&quot;,@&quot;abc 05&quot;,nil]; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> NSComparator sortBlock = ^(id string1, id string2) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   return [string1 compare:string2]; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> }; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> NSArray *sortArray = [stringArray sortedArrayUsingComparator:sortBlock]; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> NSLog(@&quot;sortArray:%@&quot;, sortArray); </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>运行结果：<strong>sortArray:(</strong></p><p>  <strong>&quot;abc 05&quot;,</strong></p><p>  <strong>&quot;abc 1&quot;,</strong></p><p>  <strong>&quot;abc 12&quot;,</strong></p><p>  <strong>&quot;abc 13&quot;,</strong></p><p>  <strong>&quot;abc 21&quot;</strong></p><p><strong>)</strong></p><p> <strong>2、代码块的递归调用</strong></p><p>代码块想要递归调用，代码块变量必须是全局变量或者是静态变量，这样在程序启动的时候代码块变量就初始化了，可以递归调用</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"> static void (^ const blocks)(int) = ^(int i) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   if (i &gt; 0) { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     NSLog(@&quot;num:%d&quot;, i); </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     blocks(i - 1); </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   } </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> }; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> blocks(3); </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>运行打印结果：</p><p><strong>num:3</strong></p><p><strong>num:2</strong></p><p><strong>num:1</strong></p><p> <strong>、在代码块中使用局部变量和全局变量</strong></p><p>在代码块中可以使用和改变全局变量</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"> int global = 1000; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> int main(int argc, const char * argv[]) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   @autoreleasepool { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     void(^block)(void) = ^(void) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       global++; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       NSLog(@&quot;global:%d&quot;, global); </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     block(); </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     NSLog(@&quot;global:%d&quot;, global); </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   } </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   return 0; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> } </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>运行打印结果：</p><p><strong>global:1001</strong></p><p><strong>global:1001</strong></p><p>而局部变量可以使用，但是不能改变。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"> int local = 500; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> void(^block)(void) = ^(void) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    local++; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   NSLog(@&quot;local:%d&quot;, local); </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> }; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> block(); </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSLog(@&quot;local:%d&quot;, local); </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>在代码块中改变局部变量编译不通过。怎么在代码块中改变局部变量呢？在局部变量前面加上关键字：__block</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"> __block int local = 500; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> void(^block)(void) = ^(void) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   local++; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   NSLog(@&quot;local:%d&quot;, local); </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">block(); </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSLog(@&quot;local:%d&quot;, local); </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>运行结果：<strong>local:501</strong></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="关键字"></a>关键字<a class="hash-link" href="#关键字" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">     __strong： 赋值给这个变量的对象会自动被retain一次，如果在block中引用它，block也会retain它一次。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     __unsafe_unretained： 赋值给这个变量不会被retain，也就是说被他修饰的变量的存在不能保证持有对象的可靠性，它可能已经被释放了，而且留下了一个不安全的指针。不会被block retain。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     __week：类似于__unsafe_unretained，只是如果所持有的对象被释放后，变量会自动被设置为nil，这样更安全些，不过只在IOS5.0以上的系统支持，同样不会被block retain。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      __block 关键字修饰一个变量，表示这个变量能在block中被修改（值修改，而不是修改对象中的某一个属性，可以理解为修改指针的指向）。会被自动retain。</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>参考文档：</p><ul><li><a href="https://www.cnblogs.com/DamonTang/archive/2012/12/31/2840690.html" target="_blank" rel="noopener noreferrer">IOS中的block和retain cycle (经典)</a></li><li><a href="https://www.jianshu.com/p/fe772a3536ca" target="_blank" rel="noopener noreferrer">iOS <strong>weak和</strong>strong在Block中的使用</a></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="block的内存结构"></a>Block的内存结构<a class="hash-link" href="#block的内存结构" title="Direct link to heading">#</a></h3><p><img src="http://wiso.liwenhui520.com/20200827159853981124273.png" alt="20200827159853981124273.png"></p><p><img src="http://wiso.liwenhui520.com/2020082715985398638079.png" alt="2020082715985398638079.png"></p><p><img src="http://wiso.liwenhui520.com/20200827159853988924682.png" alt="20200827159853988924682.png"></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// @implementation DYSCat</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct __DYSCat__dys_run_block_impl_0 {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  struct __block_impl impl;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  struct __DYSCat__dys_run_block_desc_0* Desc;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  __DYSCat__dys_run_block_impl_0(void *fp, struct __DYSCat__dys_run_block_desc_0 *desc, int flags=0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    impl.isa = &amp;_NSConcreteStackBlock;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    impl.Flags = flags;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    impl.FuncPtr = fp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Desc = desc;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">static long __DYSCat__dys_run_block_func_0(struct __DYSCat__dys_run_block_impl_0 *__cself, NSInteger a, NSInteger b) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return a+b;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">static struct __DYSCat__dys_run_block_desc_0 {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  size_t reserved;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  size_t Block_size;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">} __DYSCat__dys_run_block_desc_0_DATA = { 0, sizeof(struct __DYSCat__dys_run_block_impl_0)};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">static void _I_DYSCat_dys_run(DYSCat * self, SEL _cmd) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    NSInteger (*add)(NSInteger,NSInteger) = ((long (*)(NSInteger, NSInteger))&amp;__DYSCat__dys_run_block_impl_0((void *)__DYSCat__dys_run_block_func_0, &amp;__DYSCat__dys_run_block_desc_0_DATA));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ((NSInteger (*)(__block_impl *, NSInteger, NSInteger))((__block_impl *)add)-&gt;FuncPtr)((__block_impl *)add, 1, 3);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// @end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><img src="http://wiso.liwenhui520.com/20200827159853999716701.png" alt="20200827159853999716701.png"></p><p>结构体：</p><p>block的结构体命名 <code>__文件名__方法名_block_impl_数字</code></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct __DYSCat__dys_run_block_impl_0 {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  struct __block_impl impl;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  struct __DYSCat__dys_run_block_desc_0* Desc;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  __DYSCat__dys_run_block_impl_0(void *fp, struct __DYSCat__dys_run_block_desc_0 *desc, int flags=0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    impl.isa = &amp;_NSConcreteStackBlock;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    impl.Flags = flags;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    impl.FuncPtr = fp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Desc = desc;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="dys-typora-open://mine/survival/docs/编程语言/Objective-C/内存管理.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#属性的内存管理语义" class="table-of-contents__link">属性的内存管理语义</a></li><li><a href="#从内存管理角度去理解nsstring" class="table-of-contents__link">从内存管理角度去理解NSString</a></li><li><a href="#block的内存管理" class="table-of-contents__link">Block的内存管理</a><ul><li><a href="#关键字" class="table-of-contents__link">关键字</a></li><li><a href="#block的内存结构" class="table-of-contents__link">Block的内存结构</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.aaa24a49.js"></script>
<script src="/runtime~main.7eeb3d64.js"></script>
<script src="/main.7a041c89.js"></script>
<script src="/1.62b3ea65.js"></script>
<script src="/257.bb7ed37e.js"></script>
<script src="/258.ed1b30f8.js"></script>
<script src="/935f2afb.55f5968c.js"></script>
<script src="/256.a7530d90.js"></script>
<script src="/0f221bb7.70518217.js"></script>
</body>
</html>