<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Blog Atom Feed"><title data-react-helmet="true">Objective-C-C-CPP交互 | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Objective-C-C-CPP交互 | My Site"><meta data-react-helmet="true" name="description" content="Objective-C-C-CPP交互"><meta data-react-helmet="true" property="og:description" content="Objective-C-C-CPP交互"><meta data-react-helmet="true" property="og:url" content="http://localhost:9999//docs/编程语言/Objective-C/Objective-C-C-CPP交互"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://localhost:9999//docs/编程语言/Objective-C/Objective-C-C-CPP交互"><link rel="stylesheet" href="/styles.8cfbcdec.css">
<link rel="preload" href="/styles.65a50636.js" as="script">
<link rel="preload" href="/runtime~main.b175e2de.js" as="script">
<link rel="preload" href="/main.777b260c.js" as="script">
<link rel="preload" href="/1.5f7a006f.js" as="script">
<link rel="preload" href="/260.fc337f83.js" as="script">
<link rel="preload" href="/261.cd474b1f.js" as="script">
<link rel="preload" href="/935f2afb.42cf00cb.js" as="script">
<link rel="preload" href="/259.fa9b4b3b.js" as="script">
<link rel="preload" href="/71f8bd3d.3e16e6fe.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a><a class="navbar__item navbar__link" href="/docs/">基础</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/编程语言/编程语言">语言</a><a class="navbar__item navbar__link" href="/docs/工具/常用工具">工具</a><a class="navbar__item navbar__link" href="/docs/应用开发/应用开发">应用开发</a><a class="navbar__item navbar__link" href="/docs/Apple/iOS开发/iOS开发">Apple</a><a class="navbar__item navbar__link" href="/docs/音视频/音视频">音视频</a><a class="navbar__item navbar__link" href="/docs/项目/项目">项目</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">基础</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/编程语言/编程语言">语言</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/工具/常用工具">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/应用开发/应用开发">应用开发</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/iOS开发/iOS开发">Apple</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/音视频">音视频</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/项目/项目">项目</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Objective-C-C-CPP交互</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="objective-c-c-cpp交互"></a>Objective-C-C-CPP交互<a class="hash-link" href="#objective-c-c-cpp交互" title="Direct link to heading">#</a></h1><p>[toc]</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="oc和c交互-objective-c"></a>OC和C++交互-Objective-C++<a class="hash-link" href="#oc和c交互-objective-c" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="数据"></a>数据<a class="hash-link" href="#数据" title="Direct link to heading">#</a></h3><p>C++ 和 Objective-C 对象都可以作为对方的实例变量。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/* Hello.mm</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * Compile with: g++ -x objective-c++ -framework Foundation Hello.mm  -o hello</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#import &lt;Foundation/Foundation.h&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class Hello {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        id greeting_text;  // holds an NSString</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Hello() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            greeting_text = @&quot;Hello, world!&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Hello(const char* initial_greeting_text) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            greeting_text = [[NSString alloc] initWithUTF8String:initial_greeting_text];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        void say_hello() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            printf(&quot;%s\n&quot;, [greeting_text UTF8String]);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@interface Greeting : NSObject {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @private</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Hello *hello;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- (id)init;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- (void)dealloc;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- (void)sayGreeting;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- (void)sayGreeting:(Hello*)greeting;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@implementation Greeting</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- (id)init {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    self = [super init];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (self) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        hello = new Hello();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return self;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- (void)dealloc {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    delete hello;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [super dealloc];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- (void)sayGreeting {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    hello-&gt;say_hello();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- (void)sayGreeting:(Hello*)greeting {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    greeting-&gt;say_hello();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">int main() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Greeting *greeting = [[Greeting alloc] init];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [greeting sayGreeting];                         // &gt; Hello,  world!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Hello *hello = new Hello(&quot;Bonjour, monde!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [greeting sayGreeting:hello];                   // &gt; Bonjour,  monde!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    delete hello;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [greeting release];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [pool release];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="过程"></a>过程<a class="hash-link" href="#过程" title="Direct link to heading">#</a></h3><p>C++方法可以调用OC方法，OC方法也可以调用C++方法。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="面向对象"></a>面向对象<a class="hash-link" href="#面向对象" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="继承"></a>继承<a class="hash-link" href="#继承" title="Direct link to heading">#</a></h4><p>OC类和C++类不能相互继承</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">class Base { /* ... */ };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@interface ObjCClass: Base ... @end // ERROR!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class Derived: public ObjCClass ... // ERROR!</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="声明"></a>声明<a class="hash-link" href="#声明" title="Direct link to heading">#</a></h4><p>可以在 Objective-C 类声明中声明 C++ 类。编译器将此类类视为已在全局命名空间中声明。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@interface Foo {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> class Bar { ... } // OK</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Bar *barPtr; // OK</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Objective-C 允许将 C 结构（无论是否在 Objective-C 声明中声明）用作实例变量。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@interface Foo {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   struct CStruct { ... };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   struct CStruct bigIvar; // OK</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">} ... @end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="虚函数"></a>虚函数<a class="hash-link" href="#虚函数" title="Direct link to heading">#</a></h4><p>在 Mac OS X 10.4 及更高版本上，如果设置<code>fobjc-call-cxx-cdtors</code>编译器标志，则可以使用包含虚函数和非平凡用户定义的零参数构造函数和析构函数的 C++ 类的实例作为实例变量。（<code>fobjc-call-cxx-cdtors</code>编译器标志在 gcc-4.2 中默认设置。）构造函数在<code>alloc</code>方法（特别是 inside <code>class_createInstance</code>）中调用，在它们所属的 Objective-C 对象被分配之后立即按照声明顺序调用。使用的构造函数是“公共无参数就地构造函数”。析构函数在<code>dealloc</code>方法（特别是 inside <code>object_dispose</code>）中调用，在它们所属的 Objective-C 对象被释放之前，以相反的声明顺序调用。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="命名空间"></a>命名空间<a class="hash-link" href="#命名空间" title="Direct link to heading">#</a></h3><p>Objective-C 没有嵌套命名空间的概念。您不能在 C++ 命名空间中声明 Objective-C 类，也不能在 Objective-C 类中声明命名空间。</p><p>Objective-C 类、协议和类别不能在 C++ 模板内声明，C++ 模板也不能在 Objective-C 接口、协议或类别的范围内声明。</p><p>但是，Objective-C 类可以用作 C++ 模板参数。C++ 模板参数也可以用作 Objective-C 消息表达式中的接收器或参数（虽然不是选择器）。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="c语法歧义和冲突"></a>C++语法歧义和冲突<a class="hash-link" href="#c语法歧义和冲突" title="Direct link to heading">#</a></h3><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="限制"></a>限制<a class="hash-link" href="#限制" title="Direct link to heading">#</a></h3><p>Objective-C++ 不向Objective-C 类添加C++ 特性，也不向C++ 类添加Objective-C 特性。</p><p>例如，您不能使用 Objective-C 语法来调用 C++ 对象，不能向 Objective-C 对象添加构造函数或析构函数，并且不能互换使用关键字<code>this</code>和<code>self</code>。类层次结构是分开的；</p><p>C++ 类不能从 Objective-C 类继承，Objective-C 类不能从 C++ 类继承。</p><p>此外，不支持多语言异常处理。也就是说，Objective-C 代码中抛出的异常无法在 C++ 代码中捕获，相反，C++ 代码中抛出的异常无法在 Objective-C 代码中捕获。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="rtfm"></a>RTFM<a class="hash-link" href="#rtfm" title="Direct link to heading">#</a></h3><ul><li><p><a href="https://developer.apple.com/library/archive/technotes/tn2185/_index.html#//apple_ref/doc/uid/DTS10004200" target="_blank" rel="noopener noreferrer">C++ Tips and Tricks for Mac OS X</a></p></li><li><p><a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/CppRuntimeEnv/CPPRuntimeEnv.html#//apple_ref/doc/uid/TP40001666" target="_blank" rel="noopener noreferrer">C++ Runtime Environment Programming Guide</a></p></li><li><p><a href="http://web.archive.org/web/20101203170217/http://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/ObjectiveC/Articles/ocCPlusPlus.html" target="_blank" rel="noopener noreferrer">Using C++ With Objective-C</a></p></li><li><p><a href="https://developer.apple.com/forums/thread/76892" target="_blank" rel="noopener noreferrer">Where is the Objective-C Plus Plus (ObjC++) documentation?</a></p></li><li><p><a href="https://clang.llvm.org/docs/AutomaticReferenceCounting.html#c-c-compatibility-for-structs-and-unions-with-non-trivial-members" target="_blank" rel="noopener noreferrer">c-c-compatibility-for-structs-and-unions-with-non-trivial-members</a></p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="参考文档"></a>参考文档<a class="hash-link" href="#参考文档" title="Direct link to heading">#</a></h3><ul><li><a href="https://github.com/enums/EMCVLib" target="_blank" rel="noopener noreferrer">https://github.com/enums/EMCVLib</a></li><li><a href="https://blog.yuusann.com/posts/article/17013" target="_blank" rel="noopener noreferrer">聊聊你不知道的 Objective-C++</a></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="objective-c和c的转换---toll-free-bridging"></a>Objective-C和C的转换 - Toll-Free Bridging<a class="hash-link" href="#objective-c和c的转换---toll-free-bridging" title="Direct link to heading">#</a></h2><p>对象所有权在谁，谁负责对象的生命周期。</p><p>Foundation对象是可以通过ARC进行管理的。</p><p>Core Foundation则需要调用<code>CFRetain</code>,<code>CFRelease</code>等方法手动管理生命周期。</p><p>我们需要告诉编译器如何管理生命周期。通过以下三个关键字来控制：</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="__bridge"></a>__bridge<a class="hash-link" href="#__bridge" title="Direct link to heading">#</a></h3><p>进行OC指针和CF指针之间的转换，不涉及对象所有权转换。</p><p>举例：OC -&gt; CF，所有权在Foundation，不需要手动管理</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSString * str = [NSString stringWithFormat:@&quot;%ld&quot;,random()];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CFStringRef cf_str = (__bridge CFStringRef)str;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSLog(@&quot;%ld&quot;,(long)CFStringGetLength(cf_str));</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>举例：CF -&gt; OC，所有权在CF，需要手动管理内存</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CFStringRef cf_str = CFStringCreateWithFormat (NULL, NULL, CFSTR(&quot;%d&quot;), rand());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSString * str = (__bridge NSString *)cf_str;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSLog(@&quot;%ld&quot;,(long)str.length);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//这一行很有必要，不然会内存泄漏</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CFRelease(cf_str);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static void (cppcallback)(int errorCode, void *ctx);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@implementation RZLogan</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- (void)uploadAllAsync:(RZUploadAllCallBack)handler {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _uploadCallBack = handler;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return logan-&gt;uploadAllAsync(cppcallback);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">static void (cppcallback)(int errorCode, void *ctx) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    RZLogan *rzlogan = (__bridge RZLogan *)ctx;   </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>直接将OC指针类型转为<code>void *</code> C指针类型，会报错</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Cast of Objective-C pointer type &#x27;RZLogan *&#x27; to C pointer type &#x27;void *&#x27; requires a bridged cast</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><img alt="image-20211022111221940" src="/assets/images/image-20211022111221940-1d8b67aae6b658231985575a8742a241.png"></p><p>直接将C指针类型<code>void *</code>转为OC指针类型<code>RZLogan *</code> 也会报错。</p><p><img alt="image-20211022111544807" src="/assets/images/image-20211022111544807-569f5a7fc4e2c58458d88468b2564678.png"></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Cast of C pointer type &#x27;void *&#x27; to Objective-C pointer type &#x27;RZLogan *&#x27; requires a bridged cast</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>正解：__bradge</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">- (void)uploadAllAsync:(RZUploadAllCallBack)handler {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _uploadCallBack = handler;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return logan-&gt;uploadAllAsync(cppcallback,(__bradge void *)self);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">static void (cppcallback)(int errorCode, void *ctx) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    RZLogan *rzlogan = (__bridge RZLogan *)ctx;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if(rzlogan.uploadCallBack) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        rzlogan.uploadCallBack(errorCode);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        rzlogan.uploadCallBack = nil;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="__bridge_retained"></a>__bridge_retained<a class="hash-link" href="#__bridge_retained" title="Direct link to heading">#</a></h3><p>将一个OC指针转换为一个CF指针，同时移交所有权，意味着你需要手动调用CFRelease来释放这个指针。这个关键字等价于CFBridgingRetain函数。</p><p>举例</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSString * str = [NSString stringWithFormat:@&quot;%ld&quot;,random()];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CFStringRef cf_str = (__bridge_retained CFStringRef)str;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSLog(@&quot;%ld&quot;,(long)CFStringGetLength(cf_str));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CFRelease(cf_str);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="__bridge_transfer"></a>__bridge_transfer<a class="hash-link" href="#__bridge_transfer" title="Direct link to heading">#</a></h3><p>将一个CF指针转换为OC指针，同时移交所有权，ARC负责管理这个OC指针的生命周期。这个关键字等价于CFBridgingRelease</p><p>举例</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CFStringRef cf_str = CFStringCreateWithFormat(NULL, NULL, CFSTR(&quot;%d&quot;), rand());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSString * str = (__bridge_transfer  NSString *)cf_str;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSLog(@&quot;%ld&quot;,(long)str.length);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The compiler does not automatically manage the lifetimes of Core Foundation objects. You tell the compiler about the ownership semantics of objects using either a cast (defined in <code>objc/runtime.h</code>) or a Core Foundation-style macro (defined in <code>NSObject.h</code>):</p><ul><li><p><code>__bridge</code> transfers a pointer between Objective-C and Core Foundation with no transfer of ownership.</p></li><li><p><code>__bridge_retained</code> or <code>CFBridgingRetain</code> casts an Objective-C pointer to a Core Foundation pointer and also transfers ownership to you.</p><p>You are responsible for calling <code>CFRelease</code> or a related function to relinquish ownership of the object.</p></li><li><p><code>__bridge_transfer</code> or <code>CFBridgingRelease</code> moves a non-Objective-C pointer to Objective-C and also transfers ownership to ARC.</p><p>ARC is responsible for relinquishing ownership of the object.</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="rtfm-1"></a>RTFM<a class="hash-link" href="#rtfm-1" title="Direct link to heading">#</a></h3><ul><li><p><a href="https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFDesignConcepts/Articles/tollFreeBridgedTypes.html#//apple_ref/doc/uid/TP40010677" target="_blank" rel="noopener noreferrer">https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFDesignConcepts/Articles/tollFreeBridgedTypes.html#//apple_ref/doc/uid/TP40010677</a></p></li><li><p><a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/CocoaEncyclopedia/Toll-FreeBridgin/Toll-FreeBridgin.html" target="_blank" rel="noopener noreferrer">https://developer.apple.com/library/archive/documentation/General/Conceptual/CocoaEncyclopedia/Toll-FreeBridgin/Toll-FreeBridgin.html</a></p></li><li><p><a href="https://developer.apple.com/library/archive/releasenotes/ObjectiveC/RN-TransitioningToARC/Introduction/Introduction.html#//apple_ref/doc/uid/TP40011226" target="_blank" rel="noopener noreferrer">Transitioning to ARC Release Notes</a></p></li><li><p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/GarbageCollection/Articles/gcCoreFoundation.html#//apple_ref/doc/uid/TP40006687" target="_blank" rel="noopener noreferrer">Garbage Collection Programming Guide</a></p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="参考文档-1"></a>参考文档<a class="hash-link" href="#参考文档-1" title="Direct link to heading">#</a></h3><ul><li><p><a href="https://blog.csdn.net/Hello_Hwc/article/details/80094632" target="_blank" rel="noopener noreferrer">深入理解Toll-Free Bridging</a></p></li><li><p><a href="https://www.jianshu.com/p/5fbe5478e24b" target="_blank" rel="noopener noreferrer">iOS __bridge那些事</a></p></li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="dys-typora-open://mine/survival/docs/编程语言/Objective-C/Objective-C-C-CPP交互.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#oc和c交互-objective-c" class="table-of-contents__link">OC和C++交互-Objective-C++</a><ul><li><a href="#数据" class="table-of-contents__link">数据</a></li><li><a href="#过程" class="table-of-contents__link">过程</a></li><li><a href="#面向对象" class="table-of-contents__link">面向对象</a></li><li><a href="#命名空间" class="table-of-contents__link">命名空间</a></li><li><a href="#c语法歧义和冲突" class="table-of-contents__link">C++语法歧义和冲突</a></li><li><a href="#限制" class="table-of-contents__link">限制</a></li><li><a href="#rtfm" class="table-of-contents__link">RTFM</a></li><li><a href="#参考文档" class="table-of-contents__link">参考文档</a></li></ul></li><li><a href="#objective-c和c的转换---toll-free-bridging" class="table-of-contents__link">Objective-C和C的转换 - Toll-Free Bridging</a><ul><li><a href="#__bridge" class="table-of-contents__link">__bridge</a></li><li><a href="#__bridge_retained" class="table-of-contents__link">__bridge_retained</a></li><li><a href="#__bridge_transfer" class="table-of-contents__link">__bridge_transfer</a></li><li><a href="#rtfm-1" class="table-of-contents__link">RTFM</a></li><li><a href="#参考文档-1" class="table-of-contents__link">参考文档</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.65a50636.js"></script>
<script src="/runtime~main.b175e2de.js"></script>
<script src="/main.777b260c.js"></script>
<script src="/1.5f7a006f.js"></script>
<script src="/260.fc337f83.js"></script>
<script src="/261.cd474b1f.js"></script>
<script src="/935f2afb.42cf00cb.js"></script>
<script src="/259.fa9b4b3b.js"></script>
<script src="/71f8bd3d.3e16e6fe.js"></script>
</body>
</html>