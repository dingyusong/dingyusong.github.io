<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Blog Atom Feed"><title data-react-helmet="true">视频采集 | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="视频采集 | My Site"><meta data-react-helmet="true" name="description" content="iOS/macOS 视频采集"><meta data-react-helmet="true" property="og:description" content="iOS/macOS 视频采集"><meta data-react-helmet="true" property="og:url" content="http://localhost:9999//docs/音视频/Video/视频采集"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://localhost:9999//docs/音视频/Video/视频采集"><link rel="stylesheet" href="/styles.8cfbcdec.css">
<link rel="preload" href="/styles.aaa24a49.js" as="script">
<link rel="preload" href="/runtime~main.7eeb3d64.js" as="script">
<link rel="preload" href="/main.7a041c89.js" as="script">
<link rel="preload" href="/1.62b3ea65.js" as="script">
<link rel="preload" href="/257.bb7ed37e.js" as="script">
<link rel="preload" href="/258.ed1b30f8.js" as="script">
<link rel="preload" href="/935f2afb.55f5968c.js" as="script">
<link rel="preload" href="/256.a7530d90.js" as="script">
<link rel="preload" href="/b961bef2.a1642402.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a><a class="navbar__item navbar__link" href="/docs/">编程基础</a><a class="navbar__item navbar__link" href="/docs/编程语言/编程语言">编程语言</a><a class="navbar__item navbar__link" href="/docs/工具/常用工具">工具</a><a class="navbar__item navbar__link" href="/docs/应用开发/应用开发">应用开发</a><a class="navbar__item navbar__link" href="/docs/Apple/iOS开发/iOS开发">Apple</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/音视频/音视频">音视频</a><a class="navbar__item navbar__link" href="/docs/项目/项目">项目</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">编程基础</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/编程语言/编程语言">编程语言</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/工具/常用工具">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/应用开发/应用开发">应用开发</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/iOS开发/iOS开发">Apple</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/音视频/音视频">音视频</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/项目/项目">项目</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/音视频">音视频</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">音视频/音频</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/Audio/Audio">Audio</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/Audio/音频采集">音频采集</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/Audio/音频存储">音频存储</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/Audio/音频处理">音频处理</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/Audio/音频编解码">音频编解码</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/Audio/音频播放">音频播放</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">音视频/视频</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/音视频/Video/Video">Video</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/音视频/Video/视频采集">视频采集</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/音视频/Video/视频存储">视频存储</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/音视频/Video/视频处理">视频处理</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/音视频/Video/视频编解码">视频编解码</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/音视频/Video/视频渲染">视频渲染</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/同步/音视频同步">音视频同步</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/封装/音视频封装">音视频封装</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/传输/音视频传输">音视频传输</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/服务端/服务器">服务器</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">音视频/重要框架</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/学习资料/三方框架/FFMpeg/FFmpeg">FFmpeg</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/学习资料/三方框架/WebRTC/WebRTC">WebRTC</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">视频采集</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="iosmacos-视频采集"></a>iOS/macOS 视频采集<a class="hash-link" href="#iosmacos-视频采集" title="Direct link to heading">#</a></h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集管理"></a>采集管理<a class="hash-link" href="#采集管理" title="Direct link to heading">#</a></h2><p>谁来管理采集？采集的开始和结束，采集的配置工作等。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="avcapturesession"></a><code>AVCaptureSession</code><a class="hash-link" href="#avcapturesession" title="Direct link to heading">#</a></h3><p>我们用AVCaptureSession 来管理采集。</p><p><code>AVCaptureSession</code> 维持一个包含输入和输出的拓扑结构。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">- (BOOL)canAddOutput:(AVCaptureOutput *)output;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- (void)addOutput:(AVCaptureOutput *)output;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><a href="https://developer.apple.com/documentation/avfoundation/cameras_and_media_capture/setting_up_a_capture_session?language=objc" target="_blank" rel="noopener noreferrer">https://developer.apple.com/documentation/avfoundation/cameras_and_media_capture/setting_up_a_capture_session?language=objc</a></p><p><img alt="Block diagram of the basic capture session architecture: an AVCaptureSession acquires data from an AVCaptureDevice through AVCaptureDeviceInput, and provides data to one or more AVCaptureOutput objects." src="/assets/images/47df73b5-5cba-4c41-894d-b0a2fb600d1c-20210321074130477-d54dc290f0d295e81efd14165a60cd0a.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集的输入"></a>采集的输入<a class="hash-link" href="#采集的输入" title="Direct link to heading">#</a></h2><p>既然要采集数据，数据在哪里，从哪里来？</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集设备--avcapturedevice"></a>采集设备 <code> AVCaptureDevice</code><a class="hash-link" href="#采集设备--avcapturedevice" title="Direct link to heading">#</a></h3><p>数据从设备采集而来。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集方向"></a>采集方向<a class="hash-link" href="#采集方向" title="Direct link to heading">#</a></h3><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="权限问题"></a>权限问题<a class="hash-link" href="#权限问题" title="Direct link to heading">#</a></h3><p>摄像头涉及到用户的隐私，给不给你授权，决定下一步的采集能不能成功。</p><p><a href="https://developer.apple.com/documentation/avfoundation/cameras_and_media_capture/requesting_authorization_for_media_capture_on_ios?language=objc" target="_blank" rel="noopener noreferrer">https://developer.apple.com/documentation/avfoundation/cameras_and_media_capture/requesting_authorization_for_media_capture_on_ios?language=objc</a></p><p><a href="https://developer.apple.com/documentation/avfoundation/cameras_and_media_capture/requesting_authorization_for_media_capture_on_macos?language=objc" target="_blank" rel="noopener noreferrer">https://developer.apple.com/documentation/avfoundation/cameras_and_media_capture/requesting_authorization_for_media_capture_on_macos?language=objc</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集的设置"></a>采集的设置<a class="hash-link" href="#采集的设置" title="Direct link to heading">#</a></h3><p>怎么采集？</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集的大小-分辨率"></a>采集的大小-分辨率<a class="hash-link" href="#采集的大小-分辨率" title="Direct link to heading">#</a></h4><p>你要采集的是多大的数据？也就是常说的分辨率。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">You use the sessionPreset property to customize the quality level, bitrate, or other settings for the output. Most common capture configurations are available through session presets; however, some specialized options (such as high frame rate) require directly setting a capture format on an AVCaptureDevice instance.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>30帧以下的采集分辨率设置可用：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@property(nonatomic, copy) AVCaptureSessionPreset sessionPreset;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>30帧以上的采集分辨率设置可用：</p><p>activeFormat</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">To enable capture settings not supported by any session presets (such as high frame rate), change the value of the activeFormat property on the appropriate capture device. When you change the device’s format, the session preset automatically changes to this value, indicating that the AVCaptureSession object has relinquished responsibility for configuring its inputs and outputs. (Instead, the capture device’s active format dictates the quality of service level provided at the outputs). To return to automatic configuration, use the session’s sessionPreset property to choose another preset.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>总结 activeFormat 支持高帧率，设置device的activeFormat后，session就放弃了inputs and outputs 的设置。此时session的sessionPreset值是 AVCaptureSessionPresetInputPriority。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Note</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">In iOS, directly configuring a capture device’s activeFormat property changes the capture session’s preset to AVCaptureSessionPresetInputPriority. Upon making this change, the capture session no longer automatically configures the capture format when you call the startRunning method or call the commitConfiguration method after changing the session topology.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">In macOS, a capture session can still automatically configure the capture format after you make changes. To prevent automatic changes to the capture format in macOS, follow the advice listed under the lockForConfiguration: method.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>设置activeFormat这个值之后，iOS就直接生效了，session不会在自动配置了。但是Mac不行。Mac如果不想让session自动配置该咋办呢？</p><p><code>- (BOOL)lockForConfiguration:(NSError * _Nullable *)outError;</code></p><p>官方提供了两个建议如下：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Note</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">In iOS, directly configuring a capture device’s activeFormat property changes the capture session’s preset to AVCaptureSessionPresetInputPriority. Upon making this change, the capture session no longer automatically configures the capture format when you call the startRunning method or call the commitConfiguration method after changing the session topology (that is, adding, removing, or rearranging capture inputs and outputs). In macOS, a capture session can still automatically configure the capture format after you make changes. To prevent automatic changes to the capture format in macOS, follow these steps:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Lock the device with the lockForConfiguration: method.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Change the device’s activeFormat property.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Begin capture with the session’s startRunning method.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Unlock the device with the unlockForConfiguration method.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Or, to prevent automatic changes after modifying session topology in macOS:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Lock the device with the lockForConfiguration: method.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Call the session’s beginConfiguration method, change topology, then call the commitConfiguration method.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Unlock the device with the unlockForConfiguration method.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集的频率-帧率"></a>采集的频率-帧率<a class="hash-link" href="#采集的频率-帧率" title="Direct link to heading">#</a></h4><p>多久采集一次？也就是常说的帧率。</p><ul><li>对mac设置帧率是不生效的。mac只能采集出来30帧。</li></ul><p><strong>浮点数的不准确性</strong></p><p>这可能是最详细的CMTime教程: <a href="https://www.jianshu.com/p/f02aad2e7ff5" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/f02aad2e7ff5</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="cmtime"></a>CMTime<a class="hash-link" href="#cmtime" title="Direct link to heading">#</a></h3><p>虽然Apple已经有很多数据结构来表示Mac和iOS平台上的时间，但是在iOS4和Mac OS X 10.7 推出的时候，加上了CMTime和CMTimeRange。CMTime的类型定义如下：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objectivec codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">typedef</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     CMTimeValue    value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     CMTimeScale    timescale</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     CMTimeFlags    flags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     CMTimeEpoch    epoch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> CMTime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-kotlin codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public typealias CMTimeValue = Int64</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public typealias CMTimeScale = Int32</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>显然，<code>CMTime</code>定义是一个C语言的结构体，CMTime是以分数的形式表示时间，<code>value</code>表示分子，<code>timescale</code>表示分母，<code>flags</code>是位掩码，表示时间的指定状态。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集的输出"></a>采集的输出<a class="hash-link" href="#采集的输出" title="Direct link to heading">#</a></h2><p>采集到的数据，怎么输出，放到什么地方？</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="输出的格式"></a>输出的格式<a class="hash-link" href="#输出的格式" title="Direct link to heading">#</a></h3><p>机器采集后的原生数据，一般需要经过解码或者在编码（decode or re-encode）后输出。</p><p>编解码本质上是改变数据格式。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/*!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> @property videoSettings</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> @abstract</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Specifies the settings used to decode or re-encode video before it is output by the receiver.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> @discussion</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    See AVVideoSettings.h for more information on how to construct a video settings dictionary. To receive samples in their device native format, set this property to an empty dictionary (i.e. [NSDictionary dictionary]). To receive samples in a default uncompressed format, set this property to nil. Note that after this property is set to nil, subsequent querying of this property will yield a non-nil dictionary reflecting the settings used by the AVCaptureSession&#x27;s current sessionPreset.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    On iOS, the only supported key is kCVPixelBufferPixelFormatTypeKey. Supported pixel formats are kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange, kCVPixelFormatType_420YpCbCr8BiPlanarFullRange and kCVPixelFormatType_32BGRA.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@property(nonatomic, copy, null_resettable) NSDictionary&lt;NSString *, id&gt; *videoSettings;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>通过 videoSettings 可以得到的格式。</p><ul><li>device native format</li><li>default uncompressed format</li><li>指定的格式（iOS只有3种）</li></ul><p>Mac支持的设置多一些：参见 AVVideoSettings.h</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="mac支持的输出格式"></a>mac支持的输出格式<a class="hash-link" href="#mac支持的输出格式" title="Direct link to heading">#</a></h4><p>对应的是机器硬件支持的format</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    NSLog(@&quot;ff------ff:availableVideoCVPixelFormatTypes:%@&quot;,videoOutput.availableVideoCVPixelFormatTypes);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (NSInteger i = 0; i&lt;videoOutput.availableVideoCVPixelFormatTypes.count; i++) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        UInt32 fcode = [(videoOutput.availableVideoCVPixelFormatTypes[i]) unsignedIntValue];        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        NSLog(@&quot;kkk----%s&quot;,FourCC2Str(fcode));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">2021-04-02 16:20:21.576302+0800 pass-sdk-demo-m1-macOS[1980:1207589] ff------ff:availableVideoCVPixelFormatTypes:(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    846624121,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    2037741171,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    875704438,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    875704422,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    32,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    1111970369</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2021-04-02 16:20:21.576409+0800 pass-sdk-demo-m1-macOS[1980:1207589] kkk----2vuy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2021-04-02 16:20:21.576465+0800 pass-sdk-demo-m1-macOS[1980:1207589] kkk----yuvs</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2021-04-02 16:20:21.576504+0800 pass-sdk-demo-m1-macOS[1980:1207589] kkk----420v</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2021-04-02 16:20:21.576577+0800 pass-sdk-demo-m1-macOS[1980:1207589] kkk----420f</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2021-04-02 16:20:21.576676+0800 pass-sdk-demo-m1-macOS[1980:1207589] kkk----</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2021-04-02 16:20:21.576775+0800 pass-sdk-demo-m1-macOS[1980:1207589] kkk----BGRA</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="mac硬件支持的format"></a>mac硬件支持的format<a class="hash-link" href="#mac硬件支持的format" title="Direct link to heading">#</a></h4><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">+ (void)printSupportDeviceFormatsOfDevice:(AVCaptureDevice *)device {    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for (AVCaptureDeviceFormat *format in [device formats]) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        NSLog(@&quot;支持的类型：%@&quot;,format);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>AVCaptureVideoDataOutput 设置videoSettings 的分辨率是一个期望值，mac会返回一个最合适的分辨率，至于是如何找的，这个目前我还不知道。目前来看，他的寻找算法和webrtc 有些相似。取长宽的绝对值的最小值。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="保存到文件"></a>保存到文件<a class="hash-link" href="#保存到文件" title="Direct link to heading">#</a></h3><ul><li>Mac沙盒</li></ul><p><img alt="image-20210402113605597" src="/assets/images/image-20210402113605597-36f003a71b7e7fe13cf6905abe2b9e65.png"></p><p>macOS-Cocoa开发之沙盒机制及访问Sandbox之外的文件：<a href="https://www.jianshu.com/p/c8785cb864e9" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/c8785cb864e9</a></p><p>不上架的时候，可以关闭沙盒，方便调试。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="查看文件信息"></a>查看文件信息<a class="hash-link" href="#查看文件信息" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="mediainfo"></a>mediaInfo<a class="hash-link" href="#mediainfo" title="Direct link to heading">#</a></h4><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="yuveye"></a>yuvEye<a class="hash-link" href="#yuveye" title="Direct link to heading">#</a></h4><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="分析工具"></a>分析工具<a class="hash-link" href="#分析工具" title="Direct link to heading">#</a></h4><p>H264/H265/YUV码流分析工具推荐(一)：<a href="https://blog.csdn.net/u010164190/article/details/108551087" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/u010164190/article/details/108551087</a></p><hr><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采样工具"></a><strong>采样工具</strong><a class="hash-link" href="#采样工具" title="Direct link to heading">#</a></h5><p>iOS/macOS用什么来采集视频数据？</p><ul><li><code>AVCaptureSession</code></li></ul><p>AVFoundation 框架下专门有一部分讲解Capture。</p><p><img alt="image-20210202214731561" src="/assets/images/image-20210202214731561-6a6d5e422ec6e7e6baa8a9f6e57385bf.png"></p><p>重点类：<code>AVCaptureSession</code></p><p><strong>AVCaptureDevice</strong>: 信号采集硬件设备(摄像头、麦克风、屏幕等)</p><p><strong>AVCaptureInput</strong>: 设备输入信号</p><p><strong>AVCaptureOutput</strong>：设备输出信号</p><p><strong>AVCaptureSession</strong>：AVCaptureSession是整个Capture的核心。类似于RunLoop，它不断的从输入源获取数据，然后分发给各个输出源。</p><p><strong>AVCaptureConnection</strong>：AVCaptureConnections是Session和Output中间的控制节点。每个Output与Session建立连接后，都会分配一个默认的AVCpatureConnection</p><p><strong>AVCapturePreviewLayer</strong>：预览层，是一个CALayer对象，提供摄像头的预览功能，照片以及视频就是通过把AVCapturePreviewLayer添加到UIView 的layer上来显示</p><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="捕获格式"></a>捕获格式<a class="hash-link" href="#捕获格式" title="Direct link to heading">#</a></h6><p><code>AVCaptureDeviceFormat</code> </p><p>参考：<a href="https://www.jianshu.com/p/155efb36e041" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/155efb36e041</a></p><ol><li>只能在几个支持的捕获格式中选择。否则会报出异常。</li><li>设置活动捕获格式前后需要加锁。</li></ol><p>sessionPreset</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="时间戳"></a>时间戳<a class="hash-link" href="#时间戳" title="Direct link to heading">#</a></h5><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集设置"></a>采集设置<a class="hash-link" href="#采集设置" title="Direct link to heading">#</a></h5><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="设备类型"></a>设备类型<a class="hash-link" href="#设备类型" title="Direct link to heading">#</a></h6><p>AVCaptureDeviceType</p><p>设备类型<a href="https://developer.apple.com/documentation/avfoundation/avcapturedevicetype?changes=latest_minor&amp;language=objc" target="_blank" rel="noopener noreferrer">AVCaptureDeviceType</a>是使用<code>typedef</code>修饰的标识符，提供各种设备类型，与<code>+ defaultDeviceWithDeviceType:mediaType:position:</code>方法和<code>AVCaptureDeviceDiscoverySession</code>类一起使用。</p><table><thead><tr><th>设备类型<code>AVCaptureDeviceType</code></th><th>描述</th></tr></thead><tbody><tr><td><code>AVCaptureDeviceTypeBuiltInMicrophone</code></td><td>一个内置的麦克风</td></tr><tr><td><code>AVCaptureDeviceTypeBuiltInWideAngleCamera</code></td><td>内置广角相机,这些装置适用于一般用途。</td></tr><tr><td><code>AVCaptureDeviceTypeBuiltInTelephotoCamera</code></td><td>内置长焦相机，比广角相机的焦距长。这种类型只是将窄角设备与配备两种类型的摄像机的硬件上的宽角设备区分开来。要确定摄像机设备的实际焦距，可以检查<code>AVCaptureDevice</code>的<code>format</code>数组中的<code>AVCaptureDeviceFormat</code>对象。</td></tr><tr><td><code>AVCaptureDeviceTypeBuiltInDualCamera</code></td><td>广角相机和长焦相机的组合，创建了一个拍照，录像的<code>AVCaptureDevice</code>。具有和深度捕捉，增强变焦和双图像捕捉功能。</td></tr><tr><td><code>AVCaptureDeviceTypeBuiltInTrueDepthCamera</code></td><td>相机和其他传感器的组合，创建了一个捕捉设备，能够拍照、视频和深度捕捉。</td></tr><tr><td><code>AVCaptureDeviceTypeBuiltInDuoCamera</code></td><td><code>iOS 10.2</code> 之后添加自动变焦功能，该值功能被<code>AVCaptureDeviceTypeBuiltInDualCamera</code>替代</td></tr></tbody></table><p>作者：苏沫离
链接：<a href="https://www.jianshu.com/p/155efb36e041" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/155efb36e041</a>
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="设备位置"></a>设备位置<a class="hash-link" href="#设备位置" title="Direct link to heading">#</a></h6><p>前置还是后置</p><p>AVCaptureDevicePosition</p><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="设备选择"></a>设备选择<a class="hash-link" href="#设备选择" title="Direct link to heading">#</a></h6><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集格式-avtiveformat"></a>采集格式-avtiveformat<a class="hash-link" href="#采集格式-avtiveformat" title="Direct link to heading">#</a></h6><p>AVCaptureDeviceFormat</p><p>一个perset 一个activeformat。</p><p>When using a session preset, the session automatically controls the capture device’s active format. However, some specialized capture options (such as high frame rate) are not available in session presets. For these options, you can set the capture device’s active format instead. Doing so changes the associated capture session’s preset to <a href="doc://com.apple.documentation/documentation/avfoundation/avcapturesessionpresetinputpriority?language=objc" target="_blank" rel="noopener noreferrer"><code>AVCaptureSessionPresetInputPriority</code></a>.</p><p>高帧率 必须得使用 activeformat。</p><p> 阻止activeformat 自动改变的方法。</p><p> <a href="https://developer.apple.com/documentation/avfoundation/avcapturedevice/1387810-lockforconfiguration?language=objc" target="_blank" rel="noopener noreferrer">https://developer.apple.com/documentation/avfoundation/avcapturedevice/1387810-lockforconfiguration?language=objc</a></p><p>参考：</p><p><a href="https://stackoverflow.com/questions/36689578/avfoundation-capturing-video-with-custom-resolution/40097057" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/36689578/avfoundation-capturing-video-with-custom-resolution/40097057</a></p><p><a href="https://stackoverflow.com/questions/15608931/mac-osx-avfoundation-video-capture" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/15608931/mac-osx-avfoundation-video-capture</a></p><p> <a href="https://stackoverflow.com/questions/36689578/avfoundation-capturing-video-with-custom-resolution/40097057" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/36689578/avfoundation-capturing-video-with-custom-resolution/40097057</a></p><ul><li>选择最佳format</li></ul><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  kCVPixelFormatType_420YpCbCr8BiPlanarFullRange  = &#x27;420f&#x27;, /* Bi-Planar Component Y&#x27;CbCr 8-bit 4:2:0, full-range (luma=[0,255] chroma=[1,255]).  baseAddr points to a big-endian CVPlanarPixelBufferInfo_YCbCrBiPlanar struct */ </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p> 注意一个FourCharCode</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"> pixelFormat</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> ios:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange = &#x27;420v&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> kCVPixelFormatType_420YpCbCr8BiPlanarFullRange  = &#x27;420f&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> mac:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange = &#x27;420v&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> kCVPixelFormatType_422YpCbCr8_yuvs = &#x27;yuvs&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> 如果要求采样420的话，那么mac就只能用 420v。ios如果要和mac统一的话，最好也用420v。</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集帧大小"></a>采集帧大小<a class="hash-link" href="#采集帧大小" title="Direct link to heading">#</a></h6><p>第一种方式：</p><p><code>@property(nonatomic, copy) AVCaptureSessionPreset sessionPreset;</code></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _session = [AVCaptureSession new];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [_session setSessionPreset:AVCaptureSessionPreset352x288];</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>第二种方式：</p><p>AVCaptureDevice.formats</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">An AVCaptureDeviceFormat object describes in detail the video, image, or audio parameters of a specific mode of capture. If you need access to capture settings not covered by an AVCaptureSession preset, you can set the activeFormat property to any of the formats in this array.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">You can observe changes to the value of this property using Key-value observing.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="yuv420采样之后的数据大小"></a>YUV420采样之后的数据大小<a class="hash-link" href="#yuv420采样之后的数据大小" title="Direct link to heading">#</a></h5><p>每个Y/U/V的采样点用<strong>8bit</strong>来表示，即1Bytes.</p><ul><li>720p</li></ul><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">1280 * 720 * 8 *(1 + 1/4 + 1/4) / 8 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">= 1382400 Bytes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">= 1350 KB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">约= 1.318359375 M</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>大约是<strong>1.3M</strong>。</p><ul><li>1080p</li></ul><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">1920 * 1080 * 8 *(1 + 1/4 + 1/4) / 8 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">= 3110400 Bytes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">=  3037.5 KB</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">约= 2.966308594 M</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>大约<strong>3M</strong>。</p><ul><li>640*360</li></ul><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">640*360*8*(1+1/4+1/4)/8</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">=345600 Bytes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">=337.5KB</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>作者：FlyingPenguin
链接：<a href="https://www.jianshu.com/p/b14391ca8fdf" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/b14391ca8fdf</a>
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p>xcode Mac工程配置 采集注意：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> 当mac app开启了hardened runtime时，如果entitlement文件没有正确设置，会导致程序在获取权限时崩溃。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> entitlements文件中添加com.apple.security.device.camera设置为YES即可</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> hardruntime 有关的entitlement说明见链接</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> ————————————————</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> 版权声明：本文为CSDN博主「CaicaiNo.1」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> 原文链接：https://blog.csdn.net/shengpeng3344/article/details/103558765</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> */</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><img alt="image-20210318183505041" src="/assets/images/image-20210318183505041-ea8ba3cc4c76ffcc4c4a5b22ecdc4d42.png"></p><p><img alt="image-20210318183448988" src="/assets/images/image-20210318183448988-00bf3830be40c8fc6f961307895ff980.png"></p><p>参考：iOS自定义相机/参数调节/视频速率调节/视频合并：<a href="https://www.jianshu.com/p/06ed571fb3b5" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/06ed571fb3b5</a></p><p>参考：OC之AVCaptureDevice <a href="https://www.jianshu.com/p/155efb36e041" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/155efb36e041</a></p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="颜色编码色彩空间"></a>颜色编码/色彩空间<a class="hash-link" href="#颜色编码色彩空间" title="Direct link to heading">#</a></h5><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="rgb"></a>RGB<a class="hash-link" href="#rgb" title="Direct link to heading">#</a></h6><p>RGB（红、绿、蓝）只是众多颜色空间的一种。采用这种编码方法，每种颜色都可用三个变量来表示-红色绿色以及蓝色的强度。记录及显示彩色图像时，RGB是最常见的一种方案。</p><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="yuv"></a>YUV<a class="hash-link" href="#yuv" title="Direct link to heading">#</a></h6><p>YUV模型首先将亮度这一人眼最为敏感的要素抽离了出来，形成一个只有亮度信息的平面，然后才是描述具体色彩的U和V平面，分别具有色度（Chrominance）和浓度（Chroma）信息。</p><p><img alt="img" src="/assets/images/Barn-yuv-4e144e0ac5c81add849283d805e623a0.png"></p><p>YUV三个通道的不同信息
从上到下分别为Y、U、V
图片来自于<a href="https://upload.wikimedia.org/wikipedia/commons/2/29/Barn-yuv.png" target="_blank" rel="noopener noreferrer">Wikipedia</a></p><ul><li>为什么使用YUV？</li></ul><p>那么为什么有了RGB我们仍然需要YUV呢？我们要回到人类刚拥有彩色电视的时候，在那段从黑白电视向彩色电视的过渡期，电视系统需要提供对黑白电视的兼容性，另外还要考虑到电视广播系统那有限的带宽，如果使用RGB颜色模型，那么传输带宽就是原来的三倍。主要是以上两个原因，能够兼容黑白电视系统和更为节省带宽的YUV色彩模型就被发明了出来，它与RGB之间是无损转换的。</p><p>有问有答：什么是YUV、YPbPr、YCbCr？：<a href="https://www.expreview.com/72374.html" target="_blank" rel="noopener noreferrer">https://www.expreview.com/72374.html</a></p><p>而YPbPr、YCbCr只是YUV在不同领域中的具现化罢了，其实就是一个东西。</p><blockquote><p>可以看一下自己的戴尔显示器 颜色选项 有输入颜色格式选项可以选择RGB 和 YPbPr。</p></blockquote><ul><li><a href="https://welkinchen.pixnet.net/blog/post/5446075-yuv%2c-ypbpr-%26-ycbcr-%E5%B7%AE%E7%95%B0" target="_blank" rel="noopener noreferrer">YUV, YPbPr &amp; YCbCr 差異</a></li></ul><p>YUV (YPbPr/YCbCr) 指的都是色差訊號, 不同的是YPbPr 是類比色差訊號, YCbCr 是數位色差訊號.
( 起先 YUV 應該是指 YPbPr , 但應該看成YUV YPbPr/YCbCr  )</p><p>事實上如前面所說，YCbCr是數位處理傳輸訊號，YPbPr是類比傳輸訊號</p><ul><li>RGB和YUV</li></ul><p><a href="https://www.jianshu.com/p/cd7e73005ac4" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/cd7e73005ac4</a></p><ul><li>YUV格式通常有两大类：打包（packed）格式和平面（planar）格式。</li></ul><p>前者将YUV分量存放在同一个数组中，通常是几个相邻的像素组成一个宏像素（macro-pixel）；而后者使用三个数组分开存放YUV三个分量，就像是一个三维平面一样。</p><ul><li>YUV420 </li></ul><p>4:2:0并不意味着只有Y，Cb而没有Cr分量。它指得是对每行扫描线来说，只有一种色度分量以2:1的抽样率存储。相邻的扫描行存储不同的色度分量，也就是说，如果一行是4:2:0的话，下一行就是4:0:2，再下一行是4:2:0...以此类推。</p><p><img alt="image-20211005125901383" src="/assets/images/image-20211005125901383-102e2cfaeccd77d78d53f835169c569c.png"></p><hr><p>数据量计算</p><p>YUV = Y*1.5</p><p>YUV = RGB/2</p><p>使用YUV采集，数据量直接少一半。</p><ul><li>既然YUV更有优势，为什么还要保留RGB呢？</li></ul><p>因为目前人类发明的所有彩色的输入输出设备，本质上都只支持RGB数据。哪怕设备允许YUV的输入输出，那也是经过内部的数据转换而间接支持。</p><p>yuv和rgb各有什么优点？：<a href="https://www.zhihu.com/question/24994945" target="_blank" rel="noopener noreferrer">https://www.zhihu.com/question/24994945</a></p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="格式转换pixelformat-转换"></a>格式转换(PixelFormat 转换)<a class="hash-link" href="#格式转换pixelformat-转换" title="Direct link to heading">#</a></h5><p>ios调用系统框架采集出的视频YUV格式默认为NV12.</p><p><img alt="img" src="data:image/gif;base64,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"></p><p>参考：视频存储格式YUV420 NV12 NV21 i420 YV12：<a href="https://www.jianshu.com/p/e67f79f10c65" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/e67f79f10c65</a></p><p>I420:又叫YU12，安卓的模式。存储顺序是先存Y，再存U，最后存V。YYYYUUUVVV</p><p>NV12:IOS只有这一种模式。存储顺序是先存Y，再UV交替存储。YYYYUVUVUV</p><p>NV21:安卓的模式。存储顺序是先存Y，再存U，再VU交替存储。YYYYVUVUVU</p><p>NV12 NV21 i420 YV12 这些是yuv420的存储格式。也就是采集出来的数据如何组织？组织数据的不同，就是不同的模式。</p><p>YUV420包含YUV420p与YUV420sp, 区别在于plane数量分别为3和2. </p><p>YUV420p分为YV12和YU12(i420), 根据uv分量的顺序不同YUV420p分为YV12和YU12(i420), </p><p>YUV420sp分为NV12和NV21. YUV420sp中uv分量是杂糅在一个plane中以uvuv或者vuvu的顺序存储与第二个plane.</p><p>需求： 目前需要将 nv12 转成 i420 统一处理。</p><p>为满足不同业务需求,我们需要把nv12转换为i420或者rgba等格式.
libYUV库和ffmpeg都可以帮助我们轻松搞定.(推荐libyuv库,性能比ffmpeg高出很多).</p><p>libyuv提供 这种转换能力。</p><p><a href="https://chromium.googlesource.com/libyuv/libyuv/" target="_blank" rel="noopener noreferrer">https://chromium.googlesource.com/libyuv/libyuv/</a></p><p>采集的时候指定格式</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        NSDictionary *settings = @{(NSString *)kCVPixelBufferPixelFormatTypeKey : @(kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                   (NSString *)kCVPixelBufferWidthKey : @(self.videoConfig.dimension.width),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                   (NSString *)kCVPixelBufferHeightKey : @(self.videoConfig.dimension.height)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>主要是：<code>PixelFormatType</code></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">发现有四个，分别如下：</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kCVPixelFormatType_420YpCbCr8Planar</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kCVPixelFormatType_420YpCbCr8PlanarFullRange</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kCVPixelFormatType_420YpCbCr8BiPlanarFullRange</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">作者：片片碎</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">链接：https://www.jianshu.com/p/e67f79f10c65</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">来源：简书</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>​    //获得平面数</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CVPixelBufferRef pixelBuffer = CMSampleBufferGetImageBuffer(sampleBuffer);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CVPixelBufferLockBaseAddress(pixelBuffer, 0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    //获得平面数</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int numberOfPlanes = (int)CVPixelBufferGetPlaneCount(pixelBuffer);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>结论：Planar是3  而BiPlanar是2</p><p>而VideoRange和FullRange是取值范围</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange = &#x27;420v&#x27;, /* Bi-Planar Component Y&#x27;CbCr 8-bit 4:2:0, video-range (luma=[16,235] chroma=[16,240]).  baseAddr points to a big-endian CVPlanarPixelBufferInfo_YCbCrBiPlanar struct */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kCVPixelFormatType_420YpCbCr8BiPlanarFullRange  = &#x27;420f&#x27;, /* Bi-Planar Component Y&#x27;CbCr 8-bit 4:2:0, full-range (luma=[0,255] chroma=[1,255]).  baseAddr points to a big-endian CVPlanarPixelBufferInfo_YCbCrBiPlanar struct */</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Nv12 to i420</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CVPixelBufferRef pixelBuffer = CMSampleBufferGetImageBuffer(sampleBuffer);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CVPixelBufferLockBaseAddress(pixelBuffer, 0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    //获得平面数</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int numberOfPlanes = (int)CVPixelBufferGetPlaneCount(pixelBuffer);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    assert(numberOfPlanes == 2);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (numberOfPlanes != 2) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        CVPixelBufferUnlockBaseAddress(pixelBuffer, 0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int width = (int)CVPixelBufferGetWidth(pixelBuffer);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int height = (int)CVPixelBufferGetHeight(pixelBuffer);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    void *src_y = CVPixelBufferGetBaseAddressOfPlane(pixelBuffer, 0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    void *src_uv = CVPixelBufferGetBaseAddressOfPlane(pixelBuffer, 1);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        //内存对齐</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int src_stride_y = (int)CVPixelBufferGetBytesPerRowOfPlane(pixelBuffer, 0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int src_stride_uv = (int)CVPixelBufferGetBytesPerRowOfPlane(pixelBuffer, 1);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    void *i420 = malloc(width * height * 2);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    void *dst_y = i420;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    void *dst_u = dst_y + width * height;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    void *dst_v = dst_u + width * height / 4;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int dst_stride_y = width;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int dst_stride_u = width / 2;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    int dst_stride_v = width / 2;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    NV12ToI420(src_y, src_stride_y,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               src_uv, src_stride_uv,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               dst_y, dst_stride_y,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               dst_u, dst_stride_u,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               dst_v, dst_stride_v,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               width, height);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>深入理解 CVPixelBufferRef</strong>：<a href="https://zhuanlan.zhihu.com/p/24762605" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/24762605</a></p><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="跨距-stride"></a>跨距-stride<a class="hash-link" href="#跨距-stride" title="Direct link to heading">#</a></h6><p>转一个yuv的stride知识：<a href="https://www.jianshu.com/p/907896648310" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/907896648310</a></p><p>我们都知道现在计算机的cpu都是32位或者64位的cpu，他们一次最少读取4、8个字节，如果少于这些，反而要做一些额外的工作，会花更长的时间。所有会有一个概念叫做内存对齐，将结构体的长度设为4、8的倍数。</p><p>跨距就是指图像中的一行图像数据所占的存储空间的长度，它是一个大于等于图像宽度的内存对齐的长度。</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集参考文档"></a>采集参考文档<a class="hash-link" href="#采集参考文档" title="Direct link to heading">#</a></h5><p><a href="https://objccn.io/issue-21-3/" target="_blank" rel="noopener noreferrer"><strong>iOS 上的相机捕捉</strong></a></p><p>OC之AVCaptureDevice: <a href="https://www.jianshu.com/p/155efb36e041" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/155efb36e041</a></p><p>Activeformat: <a href="https://developer.apple.com/documentation/avfoundation/avcapturedevice/1387810-lockforconfiguration?language=objc" target="_blank" rel="noopener noreferrer">https://developer.apple.com/documentation/avfoundation/avcapturedevice/1387810-lockforconfiguration?language=objc</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="问题"></a>问题<a class="hash-link" href="#问题" title="Direct link to heading">#</a></h2><p>更新capturesetting 会导致mac界面卡顿。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma mark - setter</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- (void)setVideoConfig:(DbyCapturerConfig)videoConfig</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _videoConfig = videoConfig;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    dispatch_async(self.sessionQueue, ^{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        //设置分辨率和帧率</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [self.session beginConfiguration];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#if TARGET_OS_OSX</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        NSDictionary *settings = @{(NSString *)kCVPixelBufferPixelFormatTypeKey : @(kCVPixelFormatType_420YpCbCr8BiPlanarFullRange),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                   (NSString *)kCVPixelBufferWidthKey : @(self.videoConfig.dimension.width),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                   (NSString *)kCVPixelBufferHeightKey : @(self.videoConfig.dimension.height)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        self.videoOutput.videoSettings = settings;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#endif</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        NSInteger dstRate;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [RZVideoUtil setCaptureFrameRate:videoConfig.frameRate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                  dstSize:videoConfig.dimension</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                forDevice:self.currentDevice</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                          resultFrameRate:&amp;dstRate];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [self.session commitConfiguration];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>报错信息</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">2021-09-30 14:25:06.224700+0800 rzpaas_example_mac[32928:7429203] [] CMIOHardware.cpp:379:CMIOObjectGetPropertyData Error: 2003332927, failed</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="dys-typora-open://mine/survival/docs/音视频/Video/视频采集.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/音视频/Video/Video"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Video</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/音视频/Video/视频存储"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">视频存储 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#采集管理" class="table-of-contents__link">采集管理</a><ul><li><a href="#avcapturesession" class="table-of-contents__link"><code>AVCaptureSession</code></a></li></ul></li><li><a href="#采集的输入" class="table-of-contents__link">采集的输入</a><ul><li><a href="#采集设备--avcapturedevice" class="table-of-contents__link">采集设备 <code> AVCaptureDevice</code></a></li><li><a href="#采集方向" class="table-of-contents__link">采集方向</a></li><li><a href="#权限问题" class="table-of-contents__link">权限问题</a></li><li><a href="#采集的设置" class="table-of-contents__link">采集的设置</a></li><li><a href="#cmtime" class="table-of-contents__link">CMTime</a></li></ul></li><li><a href="#采集的输出" class="table-of-contents__link">采集的输出</a><ul><li><a href="#输出的格式" class="table-of-contents__link">输出的格式</a></li><li><a href="#保存到文件" class="table-of-contents__link">保存到文件</a></li><li><a href="#查看文件信息" class="table-of-contents__link">查看文件信息</a></li></ul></li><li><a href="#问题" class="table-of-contents__link">问题</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.aaa24a49.js"></script>
<script src="/runtime~main.7eeb3d64.js"></script>
<script src="/main.7a041c89.js"></script>
<script src="/1.62b3ea65.js"></script>
<script src="/257.bb7ed37e.js"></script>
<script src="/258.ed1b30f8.js"></script>
<script src="/935f2afb.55f5968c.js"></script>
<script src="/256.a7530d90.js"></script>
<script src="/b961bef2.a1642402.js"></script>
</body>
</html>