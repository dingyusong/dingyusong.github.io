<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Blog Atom Feed"><title data-react-helmet="true">音频采集 | My Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="音频采集 | My Site"><meta data-react-helmet="true" name="description" content="iOS/macOS 音频采集"><meta data-react-helmet="true" property="og:description" content="iOS/macOS 音频采集"><meta data-react-helmet="true" property="og:url" content="http://localhost:9999//docs/音视频/Audio/音频采集"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://localhost:9999//docs/音视频/Audio/音频采集"><link rel="stylesheet" href="/styles.8cfbcdec.css">
<link rel="preload" href="/styles.fb1c19b8.js" as="script">
<link rel="preload" href="/runtime~main.cc14fc68.js" as="script">
<link rel="preload" href="/main.c6b7f4ce.js" as="script">
<link rel="preload" href="/1.a9a8f0c0.js" as="script">
<link rel="preload" href="/258.6205818a.js" as="script">
<link rel="preload" href="/259.e50796f0.js" as="script">
<link rel="preload" href="/935f2afb.41d9bdbd.js" as="script">
<link rel="preload" href="/257.eedf933d.js" as="script">
<link rel="preload" href="/ba930f5b.96c14989.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a><a class="navbar__item navbar__link" href="/docs/">基础</a><a class="navbar__item navbar__link" href="/docs/编程语言/编程语言">语言</a><a class="navbar__item navbar__link" href="/docs/工具/常用工具">工具</a><a class="navbar__item navbar__link" href="/docs/应用开发/应用开发">应用开发</a><a class="navbar__item navbar__link" href="/docs/Apple/iOS开发/iOS开发">Apple</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/音视频/音视频">音视频</a><a class="navbar__item navbar__link" href="/docs/项目/项目">项目</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">基础</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/编程语言/编程语言">语言</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/工具/常用工具">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/应用开发/应用开发">应用开发</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/Apple/iOS开发/iOS开发">Apple</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/音视频/音视频">音视频</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/项目/项目">项目</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/音视频">音视频</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">音视频/音频</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/音视频/Audio/Audio">Audio</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/音视频/Audio/音频采集">音频采集</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/音视频/Audio/音频存储">音频存储</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/音视频/Audio/音频处理">音频处理</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/音视频/Audio/音频编解码">音频编解码</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/音视频/Audio/音频播放">音频播放</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">音视频/视频</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/Video/Video">Video</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/Video/视频采集">视频采集</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/Video/视频存储">视频存储</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/Video/视频处理">视频处理</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/Video/视频编解码">视频编解码</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/Video/视频渲染">视频渲染</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/同步/音视频同步">音视频同步</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/封装/音视频封装">音视频封装</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/传输/音视频传输">音视频传输</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/音视频/服务端/服务器">服务器</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">音视频/重要框架</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/学习资料/三方框架/FFMpeg/FFmpeg">FFmpeg</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/音视频/学习资料/三方框架/WebRTC/WebRTC">WebRTC</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">音频采集</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="iosmacos-音频采集"></a>iOS/macOS 音频采集<a class="hash-link" href="#iosmacos-音频采集" title="Direct link to heading">#</a></h1><p>采集常见问题？</p><ol><li><p>几个声道一起采集？</p></li><li><p>一秒采集多少次？</p></li><li><p>一个点用多少位来表示？</p></li><li><p>采集出来的数据多久往外送一次？一次送的数据有多大？</p></li><li><p>如果是双声道，往外送的数据格式是怎样的？</p></li><li><p>如何处理输入设备切换了？</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集管理"></a>采集管理<a class="hash-link" href="#采集管理" title="Direct link to heading">#</a></h2><p>谁来管理采集？采集的开始和结束，采集的配置工作等。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集的输入"></a>采集的输入<a class="hash-link" href="#采集的输入" title="Direct link to heading">#</a></h2><p>既然要采集数据，数据在哪里，从哪里来？</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集的输出"></a>采集的输出<a class="hash-link" href="#采集的输出" title="Direct link to heading">#</a></h2><p>采集到的数据，怎么输出，放到什么地方？</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="音频采集"></a>音频采集<a class="hash-link" href="#音频采集" title="Direct link to heading">#</a></h4><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="audio-unit"></a>Audio Unit<a class="hash-link" href="#audio-unit" title="Direct link to heading">#</a></h5><p>虽然苹果有一个Audio Unit 框架，但是可以从头文件里看出，Audio Unit所有头文件都是对AudioToolbox头文件的封装。所以我们需要学习AudioToolbox框架。</p><p><img alt="image-20210202220017241" src="/assets/images/image-20210202220017241-caa7bb302d3a9098779f1f2c71ba48ae.png"></p><p><img alt="image-20210202220404351" src="/assets/images/image-20210202220404351-f888399c44ca9496d9cf2a8404dabc0e.png"></p><p>Audio Unit采集音频可以看 AudioToolbox 的AudioUnit v2 API部分，和Deprecated Symbols 的<code>AUGraph</code></p><p><img alt="image-20210202220833714" src="/assets/images/image-20210202220833714-959fe4cce1cf7ed2a6ce898046fd434b.png"></p><p>重点类：AudioUnit，AUGraph, AudioStreamBasicDescription, AVAudioFormat</p><p>学习重点：</p><ul><li>熟练掌握AudioToolbox框架下AudioUnit v2 API部分</li><li>熟练掌握AudioToolbox框架下Audio Queue Services部分</li><li>熟练掌握AudioToolbox框架下Deprecated Symbols部分的 Audio Unit Processing Graph Services部分</li><li><a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioUnitHostingGuide_iOS/Introduction/Introduction.html#//apple_ref/doc/uid/TP40009492" target="_blank" rel="noopener noreferrer">Audio Unit Hosting Guide for iOS</a></li></ul><p>设计到的框架</p><ul><li><p><code>AudioToolbox</code>：AudioUnit，AUGraph</p></li><li><p><code>CoreAudioTypes</code>-&gt;<code>CoreAudioType Structures</code>-&gt;<code>AudioStreamBasicDescription</code></p></li><li><p><code>AVFoundation</code>-&gt;<code>Audio Playback, Recording, and Processing</code> -&gt;<code>AVAudioEngine</code>-&gt;<code>Audio Settings and Formats</code>-&gt;<code>AVAudioFormat</code></p><p>示例代码：</p></li></ul><ol><li><p>耳返  使用AUGraph实现麦克风输入，耳机输出</p><p><code>ios_demos/audio/demo/audio_unit_demo/audio_unit_ios/IOPassThrough</code></p></li><li><p>录音</p><p><code>ios_demos/audio/demo/audio_unit_demo/audio_unit_ios/InputOnly</code></p></li></ol><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="pcm"></a>pcm<a class="hash-link" href="#pcm" title="Direct link to heading">#</a></h5><p>采样格式</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/*! </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @enum       AVAudioCommonFormat</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @constant   AVAudioOtherFormat</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    A format other than one of the common ones below.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @constant   AVAudioPCMFormatFloat32</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    Native-endian floats (this is the standard format).</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @constant   AVAudioPCMFormatFloat64</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    Native-endian doubles.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @constant   AVAudioPCMFormatInt16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    Signed 16-bit native-endian integers.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @constant   AVAudioPCMFormatInt32</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    Signed 32-bit native-endian integers.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef NS_ENUM(NSUInteger, AVAudioCommonFormat) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AVAudioOtherFormat = 0,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AVAudioPCMFormatFloat32 = 1,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AVAudioPCMFormatFloat64 = 2,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AVAudioPCMFormatInt16 = 3,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AVAudioPCMFormatInt32 = 4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">} NS_ENUM_AVAILABLE(10_10, 8_0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">recorderInfo.outputStreamDesc = *([[AVAudioFormat alloc] initWithCommonFormat:AVAudioPCMFormatInt16 sampleRate:16000 channels:1 interleaved:NO].streamDescription);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ul><li>采样参数</li></ul><p>怎么采样？</p><p>采样率多少？</p><p>44100HZ</p><p>几个声道采样？</p><p>采样点用多少位数据记录？</p><p>经常见到这样的描述: 44100HZ 16bit stereo 或者 22050HZ 8bit mono 等等.
- 44100HZ 16bit stereo:
每秒钟有 44100 次采样, 采样数据用 16 位(2字节)记录, 双声道(立体声);
- 22050HZ 8bit  mono:
每秒钟有 22050 次采样, 采样数据用 8 位(1字节)记录, 单声道;</p><p>作者：FlyingPenguin
链接：<a href="https://www.jianshu.com/p/e568f94cdf6a" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/e568f94cdf6a</a>
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><ul><li>PCM数据存储格式</li></ul><p><img alt="img" src="/assets/images/1720840-ab85a155d2061835-96fd9fb7919ab4153be01e3bd2aa9874.png"></p><p><a href="https://developer.apple.com/documentation/avfaudio/avaudiocommonformat?language=objc" target="_blank" rel="noopener noreferrer">https://developer.apple.com/documentation/avfaudio/avaudiocommonformat?language=objc</a></p><blockquote><p><strong>带P和不带P的数据类型的区别：</strong></p><p>P表示Planar（平面），其数据格式排列方式为 :</p><p>LLLLLLRRRRRRLLLLLLRRRRRRLLLLLLRRRRRRL...（ <strong>**每个LLLLLLRRRRRR为一个音频帧**</strong>）</p><p>而不带P的数据格式（即交错排列）排列方式为：</p><p>LRLRLRLRLRLRLRLRLRLRLRLRLRLRLRLRLRLRL... （ <strong>每个LR为一个音频样本</strong> ）</p><p><strong>注：</strong>L表示左声道一个采样点数据，R表示右声道一个采样点数据</p></blockquote><p>每个声道都是16个bit,然后LRLRLRLR,不过此处需要注意这叫做&quot;交错立体声存储&quot;,还有一种存储方式叫做&quot;双单声道&quot;,比较少见日常可以暂时当它不存在,是以LLLLLLLLLLLLLLL.....RRRRRRRRRRRRRR......存储的.</p><p>参考：<a href="https://www.zhihu.com/question/29721784" target="_blank" rel="noopener noreferrer">https://www.zhihu.com/question/29721784</a></p><p>iOS 中AVAudioFormat有个属性 interleaved 交错，常用应该是yes。也就是 AVAudioPCMFormatInt16 不带p的。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="采集"></a>采集<a class="hash-link" href="#采集" title="Direct link to heading">#</a></h2><ol><li>几个声道一起采集？采样sample，数据帧frame，数据包packet，是什么意思？有什么关系？</li></ol><p>Channel： 一个声道是单声道，两个声道是双声道。对应 <code>AudioStreamBasicDescription</code> 中的 <code>mChannelsPerFrame</code> 字段。</p><ul><li>在音频数据中， 一个采样就是 n 个通道的一个数据集合，一个数据帧就是一个采样 one frame = one sample。</li><li>在 pcm 音频中 one packet = one frame</li><li>在压缩音频中 one packet = n frame, 如 one AAC packet = 1024 sample frames</li></ul><ol start="2"><li>一秒采集多少次？</li></ol><p>SampleRate： 采样率。对应 <code>AudioStreamBasicDescription</code> 中的 <code>mSampleRate</code> 字段。</p><ol start="3"><li>一个点用多少位来表示？一帧数据有多少字节？</li></ol><p>位宽：对应 <code>AudioStreamBasicDescription</code> 中的 <code>mBitsPerChannel</code> 字段。这个很好理解，需要用01二进制标识模拟信号的高低值，那么用多少位来表示呢？这个位数叫位宽。很显然位数越大，能表示的范围也就越广，声音表示也就越精细，但是同时，数据量也就越大。ios一般用16位整形表示。一个声道，采一次是2字节。</p><p>一帧数据有多少字节：对应 <code>AudioStreamBasicDescription</code> 中的 <code>mBytesPerFrame</code> 字段。 一帧就是一个采样。一个采样就是所有通道采集一次的数据集合。</p><ul><li>交错类型 mBitsPerChannel / 8 * mChannelsPerFrame</li><li>非交错类型 mBitsPerChannel / 8</li></ul><ol start="4"><li>采出来的数据是什么格式的？</li></ol><p>对应 <code>AudioStreamBasicDescription</code> 中的 <code>mFormatID</code> 字段。最常见的是pcm也就是第一个。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kAudioFormatLinearPCM               = &#x27;lpcm&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kAudioFormatMPEG4AAC                = &#x27;aac &#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kAudioFormatMPEGLayer3              = &#x27;.mp3&#x27;,</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>这个格式是最后形成的文件的格式。pcm是未压缩的原始数据。aac和mp3是压缩过的数据。还有一个格式是采集出来的缓冲区中的数据格式。</p><ol start="5"><li>采集出来放到缓冲区中的数据是怎么放的？</li></ol><p>对应 <code>AudioStreamBasicDescription</code> 中的 <code>mFormatFlags</code> 字段</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    m_streamFormat.mFormatFlags     = kLinearPCMFormatFlagIsSignedInteger | kLinearPCMFormatFlagIsPacked;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>kAudioFormatFlagIsFloat</strong></p><p>是否是浮点数， 没有设置，默认是 int 类型</p><p><strong>kAudioFormatFlagIsBigEndian</strong></p><p>是否是大端， 没有设置，默认是小端</p><p><a href="https://www.cnblogs.com/pure/archive/2013/04/21/3034066.html" target="_blank" rel="noopener noreferrer">Big-Endian &amp; Little-Endian</a></p><p>大端模式Big-Endian就是高位字节排放在内存的低地址端，低位字节排放在内存的高地址端。</p><p>小端模式Little-Endian就是低位字节排放在内存的低地址端，高位字节排放在内存的高地址端。</p><p><img alt="image-20210218221422118" src="/assets/images/image-20210218221422118-8d39589e905f671901787ab178962a3f.png"></p><p><strong>kAudioFormatFlagIsSignedInteger</strong></p><p>是否是 signed int， 没有设置，默认是 unsigned int</p><p><strong>kAudioFormatFlagIsPacked</strong></p><p>是否mBitsPerChannel 会占满整个通道，如果没有占满， 就会依高位对齐或低位对齐。</p><p>没有设置的时候，满足 ((mBitsPerSample / 8) * mChannelsPerFrame) == mBytesPerFrame 的条件，默认会设置此选项。</p><p><strong>kAudioFormatFlagIsNonInterleaved</strong></p><p>是否是平面类型，是否是交错类型。</p><p>双声道的情况</p><ul><li>交错类型的存储为,只有一个通道，通道内左右声道交错存储 LRLRLRLRLRLR</li><li>非交错情况为， 左右声道分开存储，每个平面，存单独的声道<ul><li>平面1 LLLLLLLL</li><li>平面2 RRRRRRR</li></ul></li></ul><ol start="6"><li>一个数据包含多少个采样?或者叫一个数据包含多少帧？一个数据包包含多少字节数？</li></ol><p>mFramesPerPacket</p><p>每个数据包，包含的采样数</p><p>pcm 类型</p><ul><li>交错 mFramesPerPacket = 1</li><li>非交错 mFramesPerPacket = mChannelsPerFrame</li></ul><p>mBytesPerPacket</p><p>每个数据包，包含的字节数
pcm 类型 mBytesPerPacket = mFramesPerPacket * mBytesPerFrame</p><ol><li></li><li>采集出来的数据多久往外送一次？一次送的数据有多大？</li></ol><ol start="4"><li>一分钟大概有多少数据量？</li><li>如果是双声道，往外送的数据格式是怎样的？</li><li>如何处理输入设备切换了？</li></ol><p>AudioStreamBasicDescription</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-c++ codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct AudioStreamBasicDescription</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Float64             mSampleRate;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AudioFormatID       mFormatID;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AudioFormatFlags    mFormatFlags;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UInt32              mBytesPerPacket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UInt32              mFramesPerPacket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UInt32              mBytesPerFrame;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UInt32              mChannelsPerFrame;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UInt32              mBitsPerChannel;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UInt32              mReserved;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct AudioStreamBasicDescription  AudioStreamBasicDescription;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>参考：<a href="https://www.jianshu.com/p/40089d76ea10" target="_blank" rel="noopener noreferrer">如何设置AudioStreamBasicDescription - 简书</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="数据格式"></a>数据格式<a class="hash-link" href="#数据格式" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="linear-pcm"></a>Linear PCM<a class="hash-link" href="#linear-pcm" title="Direct link to heading">#</a></h4><p>PCM 是最常用的无损压缩数字音频格式数据。</p><ul><li><p>sample：采样。一个采样点对单声道采集到声音的数值。</p></li><li><p>frame：帧。一帧数据是一组时间一致的samples，双声道声音文件中一帧有两个samples，一个左声道，一个右声道。</p></li><li><p>packet：包。一个或多个连续帧的集合。在线性PCM中。一个packet重视单帧，其他压缩格式中，一个packet定义给定音频数据格式的最小有意义的帧组。</p></li></ul><p>PCM: Pluse Code Modulation。脉冲编码调制</p><p>PCM: <a href="https://baike.baidu.com/item/PCM/1568054?fr=aladdin" target="_blank" rel="noopener noreferrer">https://baike.baidu.com/item/PCM/1568054?fr=aladdin</a></p><p>pcm编码: <a href="https://baike.baidu.com/item/pcm%E7%BC%96%E7%A0%81/10865033?fr=aladdin" target="_blank" rel="noopener noreferrer">https://baike.baidu.com/item/pcm%E7%BC%96%E7%A0%81/10865033?fr=aladdin</a></p><blockquote><p>PCM 即脉冲编码调制 (Pulse Code Modulation)。在PCM 过程中，将输入的模拟信号进行采样、量化和编码，用二进制进行编码的数来代表模拟信号的幅度 ；接收端再将这些编码还原为原来的模拟信号。即数字音频的 A/D 转换包括三个过程 ：采样，量化，编码。</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="aif"></a>AIF<a class="hash-link" href="#aif" title="Direct link to heading">#</a></h4><p>Audio Interchange File Format：音频交换文件格式。</p><blockquote><p>是Apple公司开发的一种声音文件格式，被Macintosh平台及其应用程序所支持，Netscape Navigator浏览器中的LiveAudio也支持AIFF格式，SGI及其它专业音频软件包也同样支持AIFF格式。AIFF支持ACE2、ACE8、MAC3和MAC6压缩，支持16位44.1kHz立体声。</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="从麦克风采集"></a>从麦克风采集<a class="hash-link" href="#从麦克风采集" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="augraph采集"></a>AUGraph采集<a class="hash-link" href="#augraph采集" title="Direct link to heading">#</a></h4><ul><li>关于 AudioBufferList ：</li></ul><p><a href="https://developer.apple.com/documentation/audiotoolbox/kaudiounitproperty_shouldallocatebuffer" target="_blank" rel="noopener noreferrer">https://developer.apple.com/documentation/audiotoolbox/kaudiounitproperty_shouldallocatebuffer</a></p><p> Default value is true, which means that the associated audio unit element creates a buffer for rendering into.</p><p> If true, the element will create a buffer for rendering into.</p><p> If false, the element will not create a buffer for rendering.</p><p> For example, if the audio unit is only ever going to have a connection as its input and never a callback, then it should not need to create a buffer (the API contract expects an audio unit to provide a buffer for callbacks, but no buffer for connections).</p><p> If the audio unit is always going to be pulled for audio with the client providing audio data buffers to the AudioUnitRender call, then it will never need to create an audio buffer on the output side.</p><p> So, this property can be used to control the default allocation strategy of an audio unit. If the audio unit needs a buffer, but one hasn&#x27;t been allocated, then an error will be thrown from that call to AudioUnitRender.</p><p> This property cannot be set on initialized audio units as it may end up reallocating memory.</p><ul><li>关于 是否disable output</li></ul><p>这个要看情况，一般的录制需要disable，如果需要播放的则不需要</p><p>参见：<code>audio_demo</code>工程 <code>DYSAudioCaptureManager</code> 类</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="audiounit采集"></a>AudioUnit采集<a class="hash-link" href="#audiounit采集" title="Direct link to heading">#</a></h4><p>Apple不推荐直接使用。推荐使用AUGraph的API，因为他是线程安全的。</p><p>参见：<code>audio_demo</code>工程 <code>DYSAudioCaptureManager</code> 类</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="audioqueue采集"></a>AudioQueue采集<a class="hash-link" href="#audioqueue采集" title="Direct link to heading">#</a></h4><p><a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40005343-CH1-SW1" target="_blank" rel="noopener noreferrer">Audio Queue Services Programming Guide</a></p><p>参考： <a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioUnitHostingGuide_iOS/ConstructingAudioUnitApps/ConstructingAudioUnitApps.html#//apple_ref/doc/uid/TP40009492-CH16-SW22" target="_blank" rel="noopener noreferrer">Other Audio Unit Hosting Design Patterns</a></p><p>[AppleAudioQueue笔记](音视频/学习资料/教程/Audio Queue Services Programming Guide.md)</p><p>There are two other main design patterns for audio units hosting. To record or analyze audio, create an input-only app with a render callback function. The callback function is invoked by your application, and it in turn invokes the render method of the Remote I/O unit’s input element. However, in most cases, a better choice for an app like this is to use an input audio queue object (of type <code>AudioQueueRef</code> instantiated using the <code>AudioQueueNewInput</code> function), as explained in <em><a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40005343" target="_blank" rel="noopener noreferrer">Audio Queue Services Programming Guide</a></em>. Using an audio queue object provides a great deal more flexibility because its render callback function is not on a realtime thread.</p><p>如果是录制或者分析音频这种设计模式的话，Apple推荐使用AudioQueue。</p><ul><li>Recording <ol><li></li></ol></li></ul><ul><li>Playing</li></ul><p>音频流数据格式：ASBD：AudioStreamBasicDescription</p><p>主要参数：</p><ul><li>sampleRate: 采样率。模拟信号数字化的过程，采样频率越高，数据量越大，音质越好</li><li>channels: 声道数。即单声道或者双声道（iPhone无法直接采集双声道，但可以模拟，即复制一份采集到的单声道数据，Android部分机型可以采集双声道）</li><li>format: 数据格式。iOS端设备采集的原始数据为线性PCM类型音频数据。</li><li>bitsPerChannel: 位宽。每个采样点的大小，位数越多表示越精细，一般是8bit或者16bit。</li></ul><p>参考：</p><ul><li><a href="https://juejin.cn/post/6844903889007820813" target="_blank" rel="noopener noreferrer">(强烈推荐)移动端音视频从零到上手</a></li><li><a href="https://xiaodongxie1024.github.io/2019/05/11/20190511_AudioUnit_capture/" target="_blank" rel="noopener noreferrer">Audio Unit采集音频实战</a></li><li><a href="https://juejin.cn/post/6844903842098872327" target="_blank" rel="noopener noreferrer">Audio Unit采集音频实战</a></li></ul><p>AudioStreamBasicDescription asbd; </p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-objective-c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/*!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @struct         AudioStreamBasicDescription</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @abstract       This structure encapsulates all the information for describing the basic</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    format properties of a stream of audio data.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @discussion     This structure is sufficient to describe any constant bit rate format that  has</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    channels that are the same size. Extensions are required for variable bit rate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    data and for constant bit rate data where the channels have unequal sizes.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    However, where applicable, the appropriate fields will be filled out correctly</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    for these kinds of formats (the extra data is provided via separate properties).</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    In all fields, a value of 0 indicates that the field is either unknown, not</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    applicable or otherwise is inapproprate for the format and should be ignored.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    Note that 0 is still a valid value for most formats in the mFormatFlags field.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    In audio data a frame is one sample across all channels. In non-interleaved</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    audio, the per frame fields identify one channel. In interleaved audio, the per</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    frame fields identify the set of n channels. In uncompressed audio, a Packet is</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    one frame, (mFramesPerPacket == 1). In compressed audio, a Packet is an</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    indivisible chunk of compressed data, for example an AAC packet will contain</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    1024 sample frames.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @var            mSampleRate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        The number of sample frames per second of the data in the stream.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @var            mFormatID</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        The AudioFormatID indicating the general kind of data in the stream.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @var            mFormatFlags</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        The AudioFormatFlags for the format indicated by mFormatID.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @var            mBytesPerPacket</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        The number of bytes in a packet of data.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @var            mFramesPerPacket</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        The number of sample frames in each packet of data.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @var            mBytesPerFrame</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        The number of bytes in a single sample frame of data.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @var            mChannelsPerFrame</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        The number of channels in each frame of data.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @var            mBitsPerChannel</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        The number of bits of sample data for each channel in a frame of data.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @var            mReserved</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        Pads the structure out to force an even 8 byte alignment.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct AudioStreamBasicDescription</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Float64             mSampleRate;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AudioFormatID       mFormatID;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AudioFormatFlags    mFormatFlags;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UInt32              mBytesPerPacket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UInt32              mFramesPerPacket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UInt32              mBytesPerFrame;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UInt32              mChannelsPerFrame;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UInt32              mBitsPerChannel;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UInt32              mReserved;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct AudioStreamBasicDescription  AudioStreamBasicDescription;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="从文件采集"></a>从文件采集<a class="hash-link" href="#从文件采集" title="Direct link to heading">#</a></h3><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="经验总结"></a>经验总结<a class="hash-link" href="#经验总结" title="Direct link to heading">#</a></h2><ol><li>Start两个AUGraph，<code>status = AUGraphStart(processingGraph);</code> 会返回66635。开启录制失败。</li></ol><p>两个 AUGraph。</p><p>ios14没问题。ios12崩溃</p><p>一个AUGraph，一个AudioUnit</p><p>都崩溃</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="通过命令行采集"></a>通过命令行采集<a class="hash-link" href="#通过命令行采集" title="Direct link to heading">#</a></h2><p>TODO:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">ffmpeg -f avfoundation -i :0 out.wav</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ffplay out.wav</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="参考资料"></a>参考资料<a class="hash-link" href="#参考资料" title="Direct link to heading">#</a></h2><p>1 hour to learn: the simplest iOS live streaming (5) yuv, pcm data introduction and acquisition <a href="https://www.programmersought.com/article/9015850852/" target="_blank" rel="noopener noreferrer">https://www.programmersought.com/article/9015850852/</a></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="dys-typora-open://mine/survival/docs/音视频/Audio/音频采集.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/音视频/Audio/Audio"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Audio</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/音视频/Audio/音频存储"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">音频存储 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#采集管理" class="table-of-contents__link">采集管理</a></li><li><a href="#采集的输入" class="table-of-contents__link">采集的输入</a></li><li><a href="#采集的输出" class="table-of-contents__link">采集的输出</a></li><li><a href="#采集" class="table-of-contents__link">采集</a><ul><li><a href="#数据格式" class="table-of-contents__link">数据格式</a></li><li><a href="#从麦克风采集" class="table-of-contents__link">从麦克风采集</a></li><li><a href="#从文件采集" class="table-of-contents__link">从文件采集</a></li></ul></li><li><a href="#经验总结" class="table-of-contents__link">经验总结</a></li><li><a href="#通过命令行采集" class="table-of-contents__link">通过命令行采集</a></li><li><a href="#参考资料" class="table-of-contents__link">参考资料</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.fb1c19b8.js"></script>
<script src="/runtime~main.cc14fc68.js"></script>
<script src="/main.c6b7f4ce.js"></script>
<script src="/1.a9a8f0c0.js"></script>
<script src="/258.6205818a.js"></script>
<script src="/259.e50796f0.js"></script>
<script src="/935f2afb.41d9bdbd.js"></script>
<script src="/257.eedf933d.js"></script>
<script src="/ba930f5b.96c14989.js"></script>
</body>
</html>